#!/usr/bin/env bash
#######################################
tmoe_qemu_user_static() {
	RETURN_TO_WHERE='tmoe_qemu_user_static'
	BETA_SYSTEM=$(
		whiptail --title "qemu_user_static" --menu "QEMUçš„useræ¨¡å¼è·¨æ¶æ„è¿è¡Œçš„æ•ˆç‡å¯èƒ½æ¯”systemæ¨¡å¼æ›´é«˜ï¼Œä½†å­˜åœ¨æ›´å¤šçš„å±€é™æ€§" 0 50 0 \
			"1" "chartæ¶æ„æ”¯æŒè¡¨æ ¼" \
			"2" "install/upgrade(å®‰è£…/æ›´æ–°)" \
			"3" "remove(ç§»é™¤/å¸è½½)" \
			"0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
			3>&1 1>&2 2>&3
	)
	##############################
	case "${BETA_SYSTEM}" in
	0 | "") tmoe_qemu_user_manager ;;
	1) tmoe_qemu_user_chart ;;
	2) install_qemu_user_static ;;
	3) remove_qemu_user_static ;;
	esac
	######################
	press_enter_to_return
	tmoe_qemu_user_static
}
#####################
tmoe_qemu_user_chart() {
	cat <<-'ENDofTable'
		ä¸‹è¡¨ä¸­çš„æ‰€æœ‰ç³»ç»Ÿå‡æ”¯æŒx64å’Œarm64
		*è¡¨ç¤ºä»…æ—§ç‰ˆæ”¯æŒ
		All distributions in the table below support amd64 and arm64.
			â•”â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•¦
			â•‘   â•‘Architectureâ•‘        â•‘        â•‘         â•‘
			â•‘   â•‘----------- â•‘ x86    â•‘armhf   â•‘ppc64el  â•‘
			â•‘   â•‘System      â•‘        â•‘        â•‘         â•‘
			â•‘---â•‘------------â•‘--------â•‘--------â•‘---------â•‘
			â•‘ 1 â•‘  Debian    â•‘  âœ“     â•‘    âœ“   â•‘   âœ“     â•‘
			â•‘   â•‘            â•‘        â•‘        â•‘         â•‘
			â•‘---â•‘------------â•‘--------â•‘--------â•‘---------â•‘
			â•‘   â•‘            â•‘        â•‘        â•‘         â•‘
			â•‘ 2 â•‘  Ubuntu    â•‘*<=19.10â•‘  âœ“     â•‘   âœ“     â•‘
			â•‘---â•‘------------â•‘--------â•‘--------â•‘---------â•‘
			â•‘   â•‘            â•‘        â•‘        â•‘         â•‘
			â•‘ 3 â•‘ Kali       â•‘  âœ“     â•‘   âœ“    â•‘    X    â•‘
			â•‘---â•‘------------â•‘--------â•‘--------â•‘---------â•‘
			â•‘   â•‘            â•‘        â•‘        â•‘         â•‘
			â•‘ 4 â•‘ Arch       â•‘  X     â•‘   âœ“    â•‘   X     â•‘
			â•‘---â•‘------------â•‘--------â•‘--------â•‘---------â•‘
			â•‘   â•‘            â•‘        â•‘        â•‘         â•‘
			â•‘ 5 â•‘ Fedora     â•‘ *<=29  â•‘   âœ“    â•‘  âœ“      â•‘
			â•‘---â•‘------------â•‘--------â•‘--------â•‘---------â•‘
			â•‘   â•‘            â•‘        â•‘        â•‘         â•‘
			â•‘ 6 â•‘  Alpine    â•‘  âœ“     â•‘    âœ“   â•‘   âœ“     â•‘
			â•‘---â•‘------------â•‘--------â•‘--------â•‘---------â•‘
			â•‘   â•‘            â•‘        â•‘        â•‘         â•‘
			â•‘ 7 â•‘ Centos     â•‘ *<=7   â•‘ *<=7   â•‘   âœ“     â•‘
	ENDofTable
}
###############
check_gnu_linux_qemu_version() {
	if [ -e "${PREFIX}/bin/qemu-aarch64-static" ]; then
		LOCAL_QEMU_USER_FILE="${PREFIX}/bin/qemu-aarch64-static"
	elif [ -e "/usr/bin/qemu-aarch64-static" ]; then
		LOCAL_QEMU_USER_FILE='/usr/bin/qemu-aarch64-static'
	fi
	case ${LOCAL_QEMU_USER_FILE} in
	"") ;;
	*) LOCAL_QEMU_USER_VERSION=$(${LOCAL_QEMU_USER_FILE} --version | head -n 1 | awk '{print $5}' | cut -d ':' -f 2 | cut -d ')' -f 1) ;;
	esac
}
###########
install_qemu_user_static() {
	printf "%s\n" "æ­£åœ¨æ£€æµ‹ç‰ˆæœ¬ä¿¡æ¯..."
	LOCAL_QEMU_USER_FILE=''
	LOCAL_QEMU_USER_VERSION=''
	case ${LINUX_DISTRO} in
	Android)
		if [ -e "${QEMU_USER_LOCAL_VERSION_FILE}" ]; then
			LOCAL_QEMU_USER_VERSION=$(head -n 1 ${QEMU_USER_LOCAL_VERSION_FILE})
		fi
		;;
	*) check_gnu_linux_qemu_version ;;
	esac

	case ${LOCAL_QEMU_USER_VERSION} in
	"") LOCAL_QEMU_USER_VERSION='æœªå®‰è£…Not Installed' ;;
	*) ;;
	esac

	cat <<-'EOF'
		---------------------------
		ä¸€èˆ¬æ¥è¯´ï¼Œæ–°ç‰ˆçš„qemu-userä¼šå¼•å…¥æ–°çš„åŠŸèƒ½ï¼Œå¹¶å¸¦æ¥æ€§èƒ½ä¸Šçš„æå‡ã€‚
		å°½ç®¡æœ‰å¯èƒ½ä¼šå¼•å…¥ä¸€äº›æ–°bugï¼Œä½†æ˜¯ä¹Ÿæœ‰å¯èƒ½ä¿®å¤äº†æ—§ç‰ˆçš„bugã€‚
		We recommend that you to use the new version.
		---------------------------
	EOF
	check_qemu_user_version
	cat <<-ENDofTable
		â•”â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
		â•‘   â•‘          â•‘                   â•‘                    
		â•‘   â•‘ software â•‘    âœ¨æœ€æ–°ç‰ˆæœ¬     â•‘   æœ¬åœ°ç‰ˆæœ¬ ğŸª
		â•‘   â•‘          â•‘  Latest version   â•‘  Local version     
		â•‘---â•‘----------â•‘-------------------â•‘--------------------
		â•‘ 1 â•‘qemu-user â•‘                    ${LOCAL_QEMU_USER_VERSION} 
		â•‘   â•‘ static   â•‘${THE_LATEST_DEB_VERSION_CODE}

	ENDofTable
	do_you_want_to_continue
	THE_LATEST_DEB_LINK="${REPO_URL}${THE_LATEST_DEB_VERSION}"
	printf "%s\n" "${YELLOW}${THE_LATEST_DEB_LINK}${RESET}"
	printf "%s\n" "${THE_LATEST_DEB_VERSION_CODE}" >${QEMU_USER_LOCAL_VERSION_FILE}
	case "${LINUX_DISTRO}" in
	"debian")
		apt update
		printf '%s\n' 'apt install -y qemu-user-static'
		apt install -y qemu-user-static
		;;
	*) download_qemu_user ;;
	esac
}
##############
check_qemu_user_version() {
	REPO_URL='https://mirrors.bfsu.edu.cn/debian/pool/main/q/qemu/'
	THE_LATEST_DEB_VERSION="$(curl -L ${REPO_URL} | grep '\.deb' | grep 'qemu-user-static' | grep "${TRUE_ARCH_TYPE}" | tail -n 1 | cut -d '=' -f 3 | cut -d '"' -f 2)"
	THE_LATEST_DEB_VERSION_CODE=$(printf '%s\n' "${THE_LATEST_DEB_VERSION}" | cut -d '_' -f 2 | sed 's@%2B@+@')
}
###############
unxz_deb_file() {
	if [ ! $(command -v ar) ]; then
		DEPENDENCY_01='binutils'
		apt update
		printf "%s\n" "apt install -y ${DEPENDENCY_01}"
		apt install -y ${DEPENDENCY_01} || pacman -S ${DEPENDENCY_01} || dnf install ${DEPENDENCY_01} || apk add ${DEPENDENCY_01} || zypper in ${DEPENDENCY_01} || port install ${DEPENDENCY_01} || guix package -i ${DEPENDENCY_01} || pkg install ${DEPENDENCY_01} || pkg_add ${DEPENDENCY_01} || pkgutil -i ${DEPENDENCY_01} || eopkg install ${DEPENDENCY_01}
	fi
	ar xv ${THE_LATEST_DEB_VERSION}
	#tar -Jxvf data.tar.xz ./usr/bin -C $PREFIX/..
	tar -Jxvf data.tar.xz
}
########################
copy_qemu_user_bin_files() {
	cp -rf ./usr/bin ${QEMU_BIN_PREFIX}
	cd ..
	rm -rv ${TEMP_FOLDER}
}
######################
download_qemu_user() {
	if [ -z ${TMPDIR} ]; then
		TMPDIR=/tmp
		#mkdir -pv ${TMPDIR}
		#chmod 777 /tmp
	fi
	cd ${TMPDIR}
	TEMP_FOLDER='.QEMU_USER_BIN'
	mkdir -pv ${TEMP_FOLDER}
	cd ${TEMP_FOLDER}
	aria2c --console-log-level=warn --no-conf --allow-overwrite=true -s 5 -x 5 -k 1M -o "${THE_LATEST_DEB_VERSION}" "${THE_LATEST_DEB_LINK}"
	unxz_deb_file
	copy_qemu_user_bin_files
}
##############
remove_qemu_user_static() {
	ls -lah /usr/bin/qemu-*-static ${QEMU_BIN_PREFIX}/bin/qemu-*-static 2>/dev/null
	printf "%s\n" "${RED}rm -rv${RESET} ${BLUE}${QEMU_BIN_PREFIX}/bin/qemu-*-static ${QEMU_USER_LOCAL_VERSION_FILE}${RESET}"
	printf "%s\n" "${RED}${TMOE_REMOVAL_COMMAND}${RESET} ${BLUE}qemu-user-static${RESET}"
	do_you_want_to_continue
	rm -rv ${QEMU_BIN_PREFIX}/bin/qemu-*-static "${QEMU_BIN_PREFIX}/bin/qemu-*-static" ${QEMU_USER_LOCAL_VERSION_FILE}
	${TMOE_REMOVAL_COMMAND} qemu-user-static
}
###############
qemu_user_env() {
	QEMU_USER_LOCAL_VERSION_FILE="${CONFIG_FOLDER}/qemu-user-static_version.txt"
	case ${LINUX_DISTRO} in
	Android) QEMU_BIN_PREFIX=${PREFIX} ;;
	*) QEMU_BIN_PREFIX=/usr ;;
	esac
}
##########
tmoe_qemu_user_manager() {
	cd ${CONFIG_FOLDER}
	NEW_TMOE_ARCH=''
	qemu_user_env
	RETURN_TO_WHERE='tmoe_qemu_user_manager'
	tmoe_qemu_user_manager_zh() {
		BETA_SYSTEM=$(
			whiptail --title "è·¨æ¶æ„è¿è¡Œå®¹å™¨" --menu "æ‚¨æƒ³è¦(æ¨¡æ‹Ÿ)è¿è¡Œå“ªä¸ªæ¶æ„ï¼Ÿ\nWhich architecture do you want to simulate?" 0 50 0 \
				"0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
				"00" "qemu-user-staticç®¡ç†(è·¨æ¶æ„æ¨¡æ‹Ÿæ‰€éœ€çš„åŸºç¡€ä¾èµ–)" \
				"1" "x86/i386(å¸¸è§äº32ä½cpuçš„æ—§å¼ä¼ ç»Ÿpc)" \
				"2" "x64/amd64(2020å¹´æœ€ä¸»æµçš„64ä½æ¶æ„,åº”ç”¨äºpcå’ŒæœåŠ¡å™¨ï¼‰" \
				"3" "arm64/aarch64(2020å¹´ç§»åŠ¨å¹³å°ä¸»æµcpuæ¶æ„)" \
				"4" "armhf/armv7(32ä½armæ¶æ„,æ”¯æŒç¡¬æµ®ç‚¹è¿ç®—)" \
				"5" "riscv64(å¼€æºæ¶æ„,ç²¾ç®€æŒ‡ä»¤é›†)" \
				"6" "ppc64el(PowerPC,åº”ç”¨äºé€šä¿¡ã€å·¥æ§ã€èˆªå¤©å›½é˜²ç­‰é¢†åŸŸ)" \
				"7" "s390x(å¸¸è§äºIBMå¤§å‹æœº)" \
				"8" "mipsel(å¸¸è§äºåµŒå…¥å¼è®¾å¤‡)" \
				"9" "mips64el(å¸¸è§äºé¾™èŠ¯cpu)" \
				"10" "armel(æ”¯æŒè½¯æµ®ç‚¹è¿ç®—,å¸¸è§äºæ—§è®¾å¤‡ï¼‰" \
				3>&1 1>&2 2>&3
		)
	}
	tmoe_qemu_user_manager_ja() {
		BETA_SYSTEM=$(
			whiptail --title "Across architectures" --menu "ã©ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ" 0 50 0 \
				"0" "ğŸŒš æˆ»ã‚‹" \
				"00" "qemu-user-static(åŸºæœ¬çš„ãªä¾å­˜é–¢ä¿‚)" \
				"1" "i386/x86:Intel 8086ã€ãŠã‚ˆã³ãã®å¾Œæ–¹äº’æ›æ€§ã‚’æŒã¤ãƒã‚¤ã‚¯ãƒ­ãƒ—ãƒ­ã‚»ãƒƒã‚µã®å‘½ä»¤ã‚»ãƒƒãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ç·ç§°" \
				"2" "x64/amd64:ã¾ãŸã¯x86-64ã¨ã¯ã€x86ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’64ãƒ“ãƒƒãƒˆã«æ‹¡å¼µã—ãŸå‘½ä»¤ã‚»ãƒƒãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£" \
				"3" "arm64/aarch64:64-bit extension of the ARM architecture" \
				"4" "armhf/armv7:32-bit arm hard float" \
				"5" "riscv64:ç¢ºç«‹ã•ã‚ŒãŸç¸®å°å‘½ä»¤ã‚»ãƒƒãƒˆã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ ã®åŸå‰‡ã«åŸºã¥ã„ãŸã‚ªãƒ¼ãƒ—ãƒ³æ¨™æº–ã®å‘½ä»¤ã‚»ãƒƒãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ ã§ã‚ã‚‹" \
				"6" "ppc64el:64ãƒ“ãƒƒãƒˆãƒ“ãƒƒã‚°ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³PowerPCãŠã‚ˆã³Power ISAãƒ—ãƒ­ã‚»ãƒƒã‚µç”¨ã«æœ€é©åŒ–ã•ã‚ŒãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’å‚ç…§ã™ã‚‹ãŸã‚ã«" \
				"7" "s390x:IBMãƒ¡ã‚¤ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã§ä¸€èˆ¬çš„ã«è¦‹ã‚‰ã‚Œã‚‹" \
				"8" "mipsel:MIPSã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯ã€ãƒŸãƒƒãƒ—ã‚¹ãƒ»ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã‚·ã‚¹ãƒ†ãƒ ã‚ºãŒé–‹ç™ºã—ãŸRISCãƒã‚¤ã‚¯ãƒ­ãƒ—ãƒ­ã‚»ãƒƒã‚µã®å‘½ä»¤ã‚»ãƒƒãƒˆãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ ã§ã‚ã‚‹" \
				"9" "mips64el" \
				"10" "armel:32-bit arm soft float" \
				3>&1 1>&2 2>&3
		)
	}
	tmoe_qemu_user_manager_en() {
		BETA_SYSTEM=$(
			whiptail --title "Across architectures" --menu "Which architecture do you want to simulate?" 0 50 0 \
				"0" "ğŸŒš Return to previous menu" \
				"00" "qemu-user-static(Basic dependence)" \
				"1" "i386:x86 is a family of instruction set architectures initially developed by Intel based on the Intel 8086 microprocessor and its 8088 variant." \
				"2" "x64/amd64:It defines a 64-bit virtual address format, of which the low-order 48 bits are used in current implementations." \
				"3" "arm64:64-bit extension of the ARM architecture" \
				"4" "armhf:32-bit arm hard float" \
				"5" "riscv64:RISC-V is an open standard instruction set architecture (ISA) based on established reduced instruction set computer (RISC) principles" \
				"6" "ppc64el:a pure little-endian mode that has been introduced with the POWER8 as the prime target" \
				"7" "s390x:Linux on IBM Z is not generally appropriate on premises for small businesses that would have fewer than about 10 distributed Linux servers" \
				"8" "mipsel:Microprocessor without Interlocked Pipelined Stages little-endian" \
				"9" "mips64el" \
				"10" "armel:32-bit arm soft float" \
				3>&1 1>&2 2>&3
		)
	}
	##############################
	case ${TMOE_MENU_LANG} in
	zh_*UTF-8) tmoe_qemu_user_manager_zh ;;
	ja_JP.UTF-8) tmoe_qemu_user_manager_ja ;;
	*) tmoe_qemu_user_manager_en ;;
	esac
	############
	case "${BETA_SYSTEM}" in
	0 | "") proot_container_menu ;;
	00) tmoe_qemu_user_static ;;
	1)
		NEW_TMOE_ARCH='i386'
		case ${TRUE_ARCH_TYPE} in
		amd64 | i386) TMOE_QEMU_ARCH="" ;;
		*) TMOE_QEMU_ARCH="${NEW_TMOE_ARCH}" ;;
		esac
		;;
	2)
		NEW_TMOE_ARCH='amd64'
		TMOE_QEMU_ARCH="x86_64"
		;;
	3)
		NEW_TMOE_ARCH='arm64'
		TMOE_QEMU_ARCH="aarch64"
		;;
	4)
		NEW_TMOE_ARCH='armhf'
		case ${TRUE_ARCH_TYPE} in
		arm64 | armhf) TMOE_QEMU_ARCH="" ;;
		*) TMOE_QEMU_ARCH="arm" ;;
		esac
		;;
	5)
		NEW_TMOE_ARCH='riscv64'
		TMOE_QEMU_ARCH="riscv64"
		;;
	6)
		NEW_TMOE_ARCH='ppc64el'
		TMOE_QEMU_ARCH="ppc64le"
		;;
	7)
		NEW_TMOE_ARCH='s390x'
		TMOE_QEMU_ARCH="${NEW_TMOE_ARCH}"
		;;
	8)
		NEW_TMOE_ARCH='mipsel'
		TMOE_QEMU_ARCH="${NEW_TMOE_ARCH}"
		;;
	9)
		NEW_TMOE_ARCH='mips64el'
		TMOE_QEMU_ARCH="${NEW_TMOE_ARCH}"
		;;
	10)
		NEW_TMOE_ARCH='armel'
		case ${TRUE_ARCH_TYPE} in
		arm64 | armhf | armel) TMOE_QEMU_ARCH="" ;;
		*) TMOE_QEMU_ARCH="armeb" ;;
		esac
		;;
	esac
	######################
	if [ ! -z "${NEW_TMOE_ARCH}" ]; then
		if [ "${TRUE_ARCH_TYPE}" = "${NEW_TMOE_ARCH}" ]; then
			TMOE_QEMU_ARCH=""
		fi
		creat_tmoe_arch_file
		ARCH_TYPE=${NEW_TMOE_ARCH}

		if [[ ! -e "${PREFIX}/bin/qemu-x86_64-static" && ! -e "/usr/bin/qemu-x86_64-static" ]]; then
			install_qemu_user_static
		fi
		case ${ARCH_TYPE} in
		mips* | riscv64) git_clone_debian_ports_distro ;;
		*) choose_which_gnu_linux_distro ;;
		esac
	fi
	press_enter_to_return
	tmoe_qemu_user_manager
}
#####################
git_clone_debian_ports_distro() {
	check_rootfs_dir
	[[ -e ${ROOTFS_DIR} ]] || mkdir -pv ${ROOTFS_DIR}
	cd ${ROOTFS_DIR}
	DISTRO_NAME='debian'
	case ${ARCH_TYPE} in
	mips*) DISTRO_CODE='buster' ;;
	riscv64) DISTRO_CODE='sid' ;;
	esac
	TMOE_LINUX_CONTAINER_DISTRO="${DISTRO_NAME}-${DISTRO_CODE}"
	creat_container_edition_txt
	go_to_proot_management

	DEBIAN_ROOTFS_FILE_NAME="${DISTRO_NAME}-${DISTRO_CODE}_${ARCH_TYPE}-rootfs.tar.xz"
	if [ ! -e "${DEBIAN_ROOTFS_FILE_NAME}" ]; then
		TEMP_DIR=".DEBIAN_${ARCH_TYPE}-TEMP_FOLDER"
		[[ ! -e ${TEMP_DIR} ]] || rm -rfv ${TEMP_DIR}
		git clone --depth=1 ${AK2_GIT_URL}/${DISTRO_NAME}-${DISTRO_CODE}_${ARCH_TYPE}.git ${TEMP_DIR}
		cd ${TEMP_DIR}
		cat .container_linux_* >${DEBIAN_ROOTFS_FILE_NAME}
		mv -fv ${DEBIAN_ROOTFS_FILE_NAME} ../
		cd ..
		rm -rvf ${TEMP_DIR}
	fi
	bash -c "$(sed -n p ${TMOE_SHARE_DIR}/container/install |
		sed "s:debian-sid:debian-${DISTRO_CODE}:g")"
}
###############
#æ­¤æ–‡ä»¶é sourceæ¥æ‰§è¡Œï¼Œä¸åŒ…å«$@
