#!/usr/bin/env bash
##############################
proot_container_main_menu() {
	case "$1" in
	restore | --restore) restore_tmoe_container ;;
	*) proot_container_menu ;;
	esac
}
################################
list_tmoe_containers() {
	ARCH_TYPE=${TRUE_ARCH_TYPE}
	rm ~/.config/tmoe-linux/across_architecture_container.txt 2>/dev/null
	case ${ARCH_TYPE} in
	mips* | riscv64)
		source ${TMOE_SHARE_DIR}/container/qemu/qemu-user
		git_clone_debian_ports_distro
		;;
	*) choose_which_gnu_linux_distro ;;
	esac
}
##############
across_architectures_container() {
	case ${TMOE_CHROOT} in
	true)
		case ${LINUX_DISTRO} in
		Android)
			getprop ro.product.model 2>/dev/null
			printf "%s %s\n" "éƒ¨åˆ†Androidç³»ç»Ÿæ— ${BLUE}/proc/sys/fs/binfmt_misc${RESET}, æ•…æœ¬å·¥å…·æœªå¯¹Androidå¼€æ”¾æ­¤åŠŸèƒ½ã€‚" "å¦‚éœ€è·¨æž¶æž„è¿è¡Œchrootå®¹å™¨,åˆ™è¯·æ¢ç”¨GNU/Linuxç³»ç»Ÿï¼Œæˆ–è‡ªè¡ŒåŠ è½½${YELLOW}å†…æ ¸æ¨¡å—${RESET}ã€‚"
			printf "%s\n" "Sorry, you are using Android system, please modprobe binfmt_misc kernel module by yourself."
			press_enter_to_return
			list_tmoe_containers
			;;
		esac
		;;
	esac
	source ${TMOE_SHARE_DIR}/container/qemu/qemu-user
	tmoe_qemu_user_manager
}
#############
proot_container_menu_multi_langs() {
	proot_container_menu_en() {
		SELECTED_GNU_LINUX=$(whiptail --title "${CONTAINER_TYPE} container" --menu "Your current architecture is ${TRUE_ARCH_TYPE}.\nDo you want to run on the same architecture or cross-architecture?" 0 50 0 \
			"1" "ðŸ’  ${TRUE_ARCH_TYPE} distros list" \
			"2" "ðŸ“‘ List installed" \
			"3" "âš”ï¸ Across architectures" \
			"4" "ðŸ”¯ Restore ${CONTAINER_TYPE} container" \
			"5" "ðŸ“• Configuration & manual" \
			"0" "ðŸŒš Back to the main menu" \
			3>&1 1>&2 2>&3)
	}
	proot_container_menu_cn() {
		SELECTED_GNU_LINUX=$(whiptail --title "${CONTAINER_TYPE}å®¹å™¨" --menu "æ‚¨æ˜¯æƒ³è¦è¿è¡Œ${TRUE_ARCH_TYPE}æž¶æž„çš„å®¹å™¨,è¿˜æ˜¯è·¨æž¶æž„å‘¢ï¼Ÿ\né™¤å‘ä¸‹å…¼å®¹å¤–,è·¨æž¶æž„è¿è¡Œçš„æ•ˆçŽ‡å¯èƒ½åä½Ž" 0 50 0 \
			"1" "ðŸ’  ${TRUE_ARCH_TYPE}å‘è¡Œç‰ˆåˆ—è¡¨" \
			"2" "ðŸ“‘ List installed å½“å‰å·²å®‰è£…å®¹å™¨åˆ—è¡¨" \
			"3" "âš”ï¸ Across architectures è·¨CPUæž¶æž„" \
			"4" "ðŸ”¯ Restore æ¢å¤/è¿˜åŽŸ${CONTAINER_TYPE}å®¹å™¨" \
			"5" "ðŸ“• é…ç½®ä¸Žæ‰‹å†Œ" \
			"0" "ðŸŒš Back to the main menu è¿”å›žä¸»èœå•" \
			3>&1 1>&2 2>&3)
	}
	case ${TMOE_MENU_LANG} in
	zh_*UTF-8) proot_container_menu_cn ;;
	*) proot_container_menu_en ;;
	esac
	##############################
	case "${SELECTED_GNU_LINUX}" in
	0 | "") tmoe_manager_main_menu ;;
	1) list_tmoe_containers ;;
	2) list_installed_tmoe_containers ;;
	3) across_architectures_container ;;
	4) restore_tmoe_container ;;
	5) configure_tmoe_container ;;
	esac
	####################
	press_enter_to_return
	proot_container_menu_multi_langs
}
############
systemd_nspawn_is_false() {
	SYSTEMD_NSPAWN=false
	printf "%s\n" "SYSTEMD_NSPAWN=false" >${CONFIG_FOLDER}/chroot.conf
	grep --color=auto 'false' ${CONFIG_FOLDER}/chroot.conf
	chmod -v a+rw ${CONFIG_FOLDER}/chroot.conf
}
systemd_nspawn_is_true() {
	SYSTEMD_NSPAWN=true
	printf "%s\n" "SYSTEMD_NSPAWN=true" >${CONFIG_FOLDER}/chroot.conf
	grep --color=auto 'true' ${CONFIG_FOLDER}/chroot.conf
	chmod -v a+rw ${CONFIG_FOLDER}/chroot.conf
}
systemd_nspawn_is_true_or_false() {
	mkdir -pv ${CONFIG_FOLDER}
	# if [[ ${WINDOWS_DISTRO} = WSL || ${LINUX_DISTRO} = Android ]]; then
	# 	systemd_nspawn_is_false
	# else
	switch_chroot_default_mode
	# fi
}
switch_chroot_default_mode() {
	if (whiptail --title "CHROOT MODE" --yes-button "systemd" --no-button "normal" --yesno "It is recommended to use the systemd mode.\nIf you want to use systemctl in the container,\nyou also need to enable the boot option of nspawn.\nIf you cannot use the systemd mode,\nthen switch it back to the normal mode." 11 50); then
		systemd_nspawn_is_true
	else
		systemd_nspawn_is_false
	fi
	printf "%s\n" "This feature is only available for uncreated containers."
	printf "%s\n" "For the container that has been created, if you want to change the mode, please execute the following commands in the container."
	printf "${GREEN}%s${RESET}\n" "cd /usr/local/etc/tmoe-linux/container"
	printf "%s\n" "If you want to use the systemd mode, you can do so."
	printf "${GREEN}%s${RESET}\n" "ln -svf nspawn tmoe-linux-container ; sed -i -E 's@^(SYSTEMD_NSPAWN=).*@\1true@' chroot.conf"
	printf "%s\n" "If you want to use the normal mode, you can do so."
	printf "${GREEN}%s${RESET}\n" "ln -svf chroot tmoe-linux-container ; sed -i -E 's@^(SYSTEMD_NSPAWN=).*@\1false@' chroot.conf"
}
check_chroot_mode() {
	if [[ -s ${CONFIG_FOLDER}/chroot.conf ]]; then
		if ! egrep -q '^[^#]*SYSTEMD_NSPAWN=' ${CONFIG_FOLDER}/chroot.conf; then
			systemd_nspawn_is_true_or_false
		else
			SYSTEMD_NSPAWN=$(egrep '^[^#]*SYSTEMD_NSPAWN=' ${CONFIG_FOLDER}/chroot.conf | awk -F '=' '{print $2}')
		fi
	else
		systemd_nspawn_is_true_or_false
	fi

	case ${SYSTEMD_NSPAWN} in
	true)
		case ${TMOE_MENU_LANG} in
		zh_*UTF-8) TMOE_TIPS_04="å½“å‰ä¸ºsystemdæ¨¡å¼ã€‚å¦‚éœ€åœ¨å®¹å™¨å†…éƒ¨ä½¿ç”¨systemctl,\nåˆ™è¿˜éœ€è¦å¯ç”¨nspawnçš„bootæ¨¡å¼" ;;
		*) TMOE_TIPS_04="Currently in systemd mode. If you want to use systemctl in the container,\nenable the boot mode of nspawn." ;;
		esac
		;;
	false)
		case ${TMOE_MENU_LANG} in
		zh_*UTF-8) TMOE_TIPS_04="å½“å‰ä¸ºnormalæ¨¡å¼" ;;
		*) TMOE_TIPS_04="Currently in normal mode." ;;
		esac
		;;
	esac
}
chroot_container_menu_multi_langs() {
	chroot_container_menu_en() {
		SELECTED_GNU_LINUX=$(whiptail --title "${CONTAINER_TYPE} container" --menu "Chroot in normal mode is not suitable for production environment,\nit is recommended to use the systemd mode.\n${TMOE_TIPS_04}" 0 50 0 \
			"1" "ðŸ’  ${TRUE_ARCH_TYPE} distros list" \
			"2" "ðŸ“‘ List installed" \
			"3" "ðŸ¥› alpha:switch chroot mode(systemd/normal)" \
			"4" "âš”ï¸ Across architectures" \
			"5" "ðŸ”¯ Restore ${CONTAINER_TYPE} container" \
			"6" "ðŸ“• Configuration & manual" \
			"0" "ðŸŒš Back to the main menu" \
			3>&1 1>&2 2>&3)
	}
	chroot_container_menu_cn() {
		SELECTED_GNU_LINUX=$(whiptail --title "${CONTAINER_TYPE}å®¹å™¨" --menu "ç”±äºŽæ™®é€šæ¨¡å¼çš„chrootåœ¨umountæ—¶å¯èƒ½ä¼šäº§ç”Ÿbug,\næ•…åªé€‚ç”¨äºŽæ¢å¤çŽ¯å¢ƒ,ä¸é€‚ç”¨äºŽç”Ÿäº§çŽ¯å¢ƒ,å»ºè®®æ‚¨ä½¿ç”¨systemdæ¨¡å¼ã€‚\n${TMOE_TIPS_04}" 0 50 0 \
			"1" "ðŸ’  ${TRUE_ARCH_TYPE}å‘è¡Œç‰ˆåˆ—è¡¨" \
			"2" "ðŸ“‘ List installed å½“å‰å·²å®‰è£…å®¹å™¨åˆ—è¡¨" \
			"3" "ðŸ¥› alphaå†…æµ‹:åˆ‡æ¢chrooté»˜è®¤æ¨¡å¼(systemd/normal)" \
			"4" "âš”ï¸ Across architectures è·¨CPUæž¶æž„" \
			"5" "ðŸ”¯ Restore æ¢å¤/è¿˜åŽŸ${CONTAINER_TYPE}å®¹å™¨" \
			"6" "ðŸ“• é…ç½®ä¸Žæ‰‹å†Œ" \
			"0" "ðŸŒš Back to the main menu è¿”å›žä¸»èœå•" \
			3>&1 1>&2 2>&3)
	}
	check_chroot_mode
	if [[ ${SYSTEMD_NSPAWN} = true ]]; then
		systemd_nspawn_env
	fi
	case ${TMOE_MENU_LANG} in
	zh_*UTF-8) chroot_container_menu_cn ;;
	*) chroot_container_menu_en ;;
	esac
	##############################
	case "${SELECTED_GNU_LINUX}" in
	0 | "") tmoe_manager_main_menu ;;
	1) list_tmoe_containers ;;
	2) list_installed_tmoe_containers ;;
	3) switch_chroot_default_mode ;;
	4) across_architectures_container ;;
	5) restore_tmoe_container ;;
	6) configure_tmoe_container ;;
	esac
	####################
	press_enter_to_return
	chroot_container_menu_multi_langs
}
############
proot_container_menu() {
	source ${TMOE_SHARE_DIR}/container/list
	check_proot_or_chroot
	SYSTEMD_NSPAWN=false
	RETURN_TO_WHERE='proot_container_menu'
	RETURN_TO_WHERE_02=${RETURN_TO_WHERE}
	case ${TMOE_CHROOT} in
	true) chroot_container_menu_multi_langs ;;
	*) proot_container_menu_multi_langs ;;
	esac
}
##################
systemd_nspawn_env() {
	if [ ! $(command -v systemd-nspawn) ]; then
		printf "${YELLOW}%s${RESET}\n" "Do you want to install systemd-container?${PURPLE}[Y/n]"
		printf "${GREEN}%s ${BLUE}%s${RESET}\n" "${TMOE_INSTALLATION_COMMAND}" "systemd-container"
		do_you_want_to_continue
		case ${LINUX_DISTRO} in
		Android)
			${TMOE_INSTALLATION_COMMAND} systemd-container
			printf "%s\n" "Sorry,this feature does not support ${PURPLE}Android${RESET} system."
			printf "%s\n" "Please use the ${BLUE}normal mode${RESET}."
			;;
		*) ${TMOE_INSTALLATION_COMMAND} systemd-container ;;
		esac
	fi
	if [ ! $(command -v dbus-uuidgen) ]; then
		printf "${RED}%s${RESET}\n" "EORRORï¼YOU DID NOT INSTALL DBUS."
		printf "${GREEN}%s ${BLUE}%s${RESET}\n" "${TMOE_INSTALLATION_COMMAND}" "dbus"
		systemd_nspawn_is_false
		press_enter_to_return
		chroot_container_menu_multi_langs
	fi
	#double check
	if [ ! $(command -v systemd-nspawn) ]; then
		systemd_nspawn_is_false
		press_enter_to_return
		chroot_container_menu_multi_langs
	else
		systemctl >/dev/null
		case ${?} in
		0) ;;
		*)
			printf "%s\n" "${RED}ERROR${RESET}, you can not use the systemd mode."
			printf "%s\n" "Please use the ${BLUE}normal mode${RESET}."
			press_enter_to_return
			chroot_container_menu_multi_langs
			;;
		esac
	fi
	# list_installed_tmoe_containers
}
###############
restore_tmoe_container() {
	source ${TMOE_SHARE_DIR}/compression/restore
	restore_gnu_linux_container
}
configure_tmoe_container() {
	source ${TMOE_SHARE_DIR}/configuration/menu
	configure_tmoe_container
}
####################
proot_container_main_menu
