#!/usr/bin/env bash
#######################################
install_termux_xfce() {
    if [ "${LINUX_DISTRO}" != 'Android' ]; then
        aria2c --console-log-level=warn --no-conf --allow-overwrite=true -d /tmp -o '.tmoe-linux-tool.bash' 'https://raw.githubusercontent.com/2moe/tmoe/master/share/old-version/tools/app/tool'
        bash /tmp/.tmoe-linux-tool.bash --install-gui
        exit 0
    fi

    if [ -e "${PREFIX}/bin/${XSESSION}" ]; then
        printf "%s\n" "You have installed ${BLUE}${XSESSION}${RESET}"
        do_you_want_to_continue
    fi
    printf "%s\n" "${GREEN}apt ${YELLOW}install -y ${BLUE}x11-repo${RESET}"
    apt update
    apt install -y x11-repo
    apt update
    apt dist-upgrade -y
    for i in ${DEPS}; do
        printf "%s\n" "${GREEN}apt ${YELLOW}install -y ${BLUE}${i}${RESET}"
        apt install -y ${i}
    done
    #ç„¡éœ€set PULSE_SERVER var
    cat >${PREFIX}/bin/startvnc <<-EndOfFile
		#!/usr/bin/env bash
		VNC_RESOLUTION=720x1440
		export DISPLAY=:2
		printf "%s\n" "Starting vnc server, the current vnc address is localhost:5902"
		TMOE_IP_ADDR=\$(ip -4 -br -c a | awk '{print \$NF}' | cut -d '/' -f 1 | grep -v '127\.0\.0\.1' | sed 's@\$@:5902@')
		cat <<-EOF
		The default vnc address is localhost:5902
		The LAN vnc address is \${TMOE_IP_ADDR}
		EOF
		pkill Xvnc 2>/dev/null
		pulseaudio --start
		sleep 1
		[[ -n \${VNC_RESOLUTION} ]] || VNC_RESOLUTION=720x1440
		Xvnc -geometry \${VNC_RESOLUTION} -depth 24 -desktop termux-gui --SecurityTypes=None \$DISPLAY &
		am start -n com.realvnc.viewer.android/com.realvnc.viewer.android.app.ConnectionChooserActivity
		printf "%s\n" "Vnc server has been started, enjoy it!"
		printf "%s\n" "You can press Ctrl+C to stop it."
		sleep 1
		for i in thunar pcmanfm-qt; do
		    if [[ \$(command -v \${i}) ]]; then
		        \${i} &
		        break
		    fi
		done
		${TERMINAL} &
		${XSESSION} || ${XSESSION_02}

	EndOfFile
    termux-fix-shebang ${PREFIX}/bin/startvnc
    chmod a+rx ${PREFIX}/bin/startvnc
    printf "%s\n" "${GREEN}startvnc${RESET}"
    do_you_want_to_continue
    source ${PREFIX}/bin/startvnc
}
##########
tmoe_modify_vnc_conf() {
    if [ "${LINUX_DISTRO}" != 'Android' ]; then
        aria2c --console-log-level=warn --no-conf --allow-overwrite=true -d /tmp -o '.tmoe-linux-tool.bash' 'https://raw.githubusercontent.com/2moe/tmoe/master/share/old-version/tools/app/tool'
        bash /tmp/.tmoe-linux-tool.bash --modify_remote_desktop_config
        exit 0
    fi
    modify_android_termux_vnc_config
}
#########
termux_original_system_gui_menu() {
    RETURN_TO_WHERE='termux_original_system_gui_menu'
    termux_original_system_gui_menu_en() {
        OPTION=$(whiptail --title "Termux" --menu "Termux native GUI has fewer software packages.It is recommended to install a container." 0 50 0 \
            "1" "modify termux-vnc conf" \
            "2" "install termux-lxqt" \
            "3" "ğŸ¹ install termux-xfce4" \
            "4" "ğŸ’” remove xfce4 & lxqt" \
            "0" "ğŸŒš Return to previous menu" \
            3>&1 1>&2 2>&3)
    }
    termux_original_system_gui_menu_cn() {
        #\nè¿™é‡Œæ˜¯termuxåŸç³»ç»Ÿçš„é…ç½®åŒºåŸŸ,ä¸æ˜¯GNU/Linuxå®¹å™¨çš„å“¦ï¼\nThe following options only apply to termux original system.
        OPTION=$(whiptail --title "Termux" --menu "TermuxåŸç³»ç»ŸGUIå¯ç©æ€§è¾ƒä½,å»ºè®®æ‚¨å®‰è£…GNU/Linux(proot/chroot)å®¹å™¨" 0 50 0 \
            "1" "ç¼–è¾‘é…ç½® edit vnc conf" \
            "2" "å®‰è£… termux-lxqt" \
            "3" "ğŸ¹ å®‰è£… termux-xfce4" \
            "4" "ğŸ’” ç§»é™¤ xfce4 & lxqt" \
            "0" "ğŸŒš back" \
            3>&1 1>&2 2>&3)
    }
    case ${TMOE_MENU_LANG} in
    zh_*UTF-8) termux_original_system_gui_menu_cn ;;
    *) termux_original_system_gui_menu_en ;;
    esac
    #####################################
    case "${OPTION}" in
    0 | "") android_termux_tmoe_menu ;;
    1) tmoe_modify_vnc_conf ;;
    2)
        DEPS='lxqt qterminal tigervnc'
        TERMINAL='qterminal'
        XSESSION="startlxqt"
        XSESSION_02="lxqt-session"
        install_termux_xfce
        ;;
    3)
        DEPS='xfce aterm xfce4-terminal tigervnc'
        TERMINAL='aterm'
        XSESSION="startxfce4"
        XSESSION_02="xfce4-session"
        install_termux_xfce
        ;;
    4) remove_termux_xfce ;;
    esac
    ####################################
    press_enter_to_return
    termux_original_system_gui_menu
}
###############
remove_termux_xfce() {
    if [ "${LINUX_DISTRO}" != 'Android' ]; then
        aria2c --console-log-level=warn --no-conf --allow-overwrite=true -d /tmp -o '.tmoe-linux-tool.bash' 'https://raw.githubusercontent.com/2moe/tmoe/master/share/old-version/tools/app/tool'
        bash /tmp/.tmoe-linux-tool.bash --remove_gui
        exit 0
    fi
    remove_android_termux_xfce
}
##########I
modify_android_termux_vnc_config() {
    if [ ! -e ${PREFIX}/bin/startvnc ]; then
        printf "%s\n" "${PREFIX}/bin/startvnc is not detected, maybe you have not installed the graphical desktop environment, do you want to continue editing?"
        printf '%s\n' 'æœªæ£€æµ‹åˆ°startvnc,æ‚¨å¯èƒ½å°šæœªå®‰è£…å›¾å½¢æ¡Œé¢ï¼Œæ˜¯å¦ç»§ç»­ç¼–è¾‘?'
        printf "%s\n" "Press Enter to confirm."
        printf "%s\n" "${YELLOW}æŒ‰å›è½¦é”®ç¡®è®¤ç¼–è¾‘ã€‚${RESET}"
        read
    fi
    CURRENTTERMUXVNCRES=$(grep '^VNC_RESOLUTION=' $(command -v startvnc) | awk -F '=' '{print $2}')
    #CURRENTTERMUXVNCRES=$(sed -n 7p "$(command -v startvnc)" | cut -d 'y' -f 2 | cut -d '-' -f 1)
    if (whiptail --title "modify vnc configuration" --yes-button 'åˆ†è¾¨ç‡resolution' --no-button 'å…¶å®ƒother' --yesno "æ‚¨æƒ³è¦ä¿®æ”¹å“ªé¡¹é…ç½®ä¿¡æ¯ï¼ŸWhich configuration do you want to modify?" 9 50); then
        if grep -q 'debian_' "$(command -v startvnc)"; then
            printf "%s\n" "æ‚¨å½“å‰ä½¿ç”¨çš„startvncé…ç½®ä¸ºLinuxå®¹å™¨ç³»ç»Ÿä¸“ç”¨ç‰ˆï¼Œè¯·è¾“debianè¿›å…¥å®¹å™¨åå†è¾“tmoe tä¿®æ”¹"
            printf "%s\n" "æœ¬é€‰é¡¹ä»…é€‚ç”¨äºtermuxåŸç³»ç»Ÿã€‚"
            press_enter_to_return
            android_termux_tmoe_menu
        fi
        TARGET=$(whiptail --inputbox "Please enter a resolution,è¯·è¾“å…¥åˆ†è¾¨ç‡,ä¾‹å¦‚2880x1440,2400x1200,1920x1080,1920x960,1440x720,1280x1024,1280x960,1280x720,1024x768,800x680ç­‰ç­‰,é»˜è®¤ä¸º720x1440,å½“å‰ä¸º${CURRENTTERMUXVNCRES}ã€‚åˆ†è¾¨ç‡å¯è‡ªå®šä¹‰ï¼Œä½†å»ºè®®æ‚¨æ ¹æ®å±å¹•æ¯”ä¾‹æ¥è°ƒæ•´ï¼Œè¾“å…¥å®ŒæˆåæŒ‰å›è½¦é”®ç¡®è®¤ï¼Œä¿®æ”¹å®Œæˆåå°†è‡ªåŠ¨åœæ­¢VNCæœåŠ¡ã€‚æ³¨æ„ï¼šxä¸ºè‹±æ–‡å°å†™ï¼Œä¸æ˜¯ä¹˜å·ã€‚Press Enter after the input is completed." 16 50 --title "è¯·åœ¨æ–¹æ¡†å†…è¾“å…¥ æ°´å¹³åƒç´ xå‚ç›´åƒç´  (æ•°å­—xæ•°å­—) " 3>&1 1>&2 2>&3)
        #æ­¤å¤„termuxçš„whiptailè·Ÿdebianä¸åŒï¼Œå¿…é¡»æˆªå–Errorå‰çš„å­—ç¬¦ã€‚
        #TRUETARGET="$(printf '%s\n' "${TARGET}" | cut -d 'E' -f 1)"
        TRUETARGET="$(printf '%s\n' "${TARGET}" | head -n 1 | cut -d ' ' -f 1)"
        #ä¸‹é¢é‚£æ¡å˜é‡TRUETARGETTARGETå‰åŠ ç©ºæ ¼
        #sed -i "s#${CURRENTTERMUXVNCRES}# ${TRUETARGETTARGET}#" "$(command -v startvnc)"
        #sed -i "8 c Xvnc -geometry ${TRUETARGET} -depth 24 --SecurityTypes=None \$DISPLAY \&" "$(command -v startvnc)"
        if [[ -n ${TRUETARGET} ]]; then
            sed -i -E "s@^(VNC_RESOLUTION=).*@\1${TRUETARGET}@" $(command -v startvnc)
            printf '%s\n' 'Your current resolution has been modified.'
            printf '%s\n' 'æ‚¨å½“å‰çš„åˆ†è¾¨ç‡å·²ç»ä¿®æ”¹ä¸º'
            printf "%s\n" $(grep '^VNC_RESOLUTION=' $(command -v startvnc) | awk -F '=' '{print $2}')
        fi
    else
        printf '%s\n' 'æ‚¨å¯ä»¥æ‰‹åŠ¨ä¿®æ”¹vncçš„é…ç½®ä¿¡æ¯'
        printf '%s\n' 'If you want to modify the resolution, please change the 720x1440 (default resolution , vertical screen) to another resolution.For example, 1920x1080 (landscape).'
        printf '%s\n' 'è‹¥æ‚¨æƒ³è¦ä¿®æ”¹åˆ†è¾¨ç‡ï¼Œè¯·å°†é»˜è®¤çš„720x1440ï¼ˆç«–å±ï¼‰æ”¹ä¸ºå…¶å®ƒæ‚¨æƒ³è¦çš„åˆ†è¾¨ç‡ï¼Œä¾‹å¦‚1920x1080ï¼ˆæ¨ªå±ï¼‰ã€‚'
        #printf "%s\n" "æ‚¨å½“å‰åˆ†è¾¨ç‡ä¸º${CURRENTTERMUXVNCRES}"
        printf '%s\n' 'æ”¹å®ŒåæŒ‰Ctrl+Sä¿å­˜ï¼ŒCtrl+Xé€€å‡ºã€‚'
        printf "%s\n" "Press Enter to confirm."
        printf "%s\n" "${YELLOW}æŒ‰å›è½¦é”®ç¡®è®¤ç¼–è¾‘ã€‚${RESET}"
        read
        nano ${PREFIX}/bin/startvnc || nano $(command -v startvnc)
        #printf "%s\n" "æ‚¨å½“å‰åˆ†è¾¨ç‡ä¸º$(sed -n 7p "$(command -v startvnc)" | cut -d 'y' -f 2 | cut -d '-' -f 1)"
    fi
    press_enter_to_return
    termux_original_system_gui_menu
}
###############
remove_android_termux_xfce() {
    printf "%s\n" "apt purge -y ^xfce lxqt qterminal tigervnc aterm x11-repo"
    do_you_want_to_continue
    apt purge ^xfce tigervnc aterm
    apt purge lxqt qterminal
    apt purge x11-repo
    apt autoremove --purge
    press_enter_to_return
    android_termux_tmoe_menu
}
#################
termux_original_system_gui_menu $@
