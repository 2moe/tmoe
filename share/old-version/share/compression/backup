#!/usr/bin/env bash
#######################################
backup_filename() {
    unset BAK_FILE_PREFIX_02
    for i in startplasma-x11 startkde mate-session xfce4-session startlxqt startdde startlxde gnome-session; do
        if [[ -e ${DEBIAN_CHROOT}/usr/bin/${i} ]]; then
            BAK_FILE_PREFIX_01=${i}
            break
        fi
    done
    case ${BAK_FILE_PREFIX_01} in
    startplasma-x11 | startkde) BAK_FILE_PREFIX_02='kde' ;;
    mate-session) BAK_FILE_PREFIX_02='mate' ;;
    xfce4-session) BAK_FILE_PREFIX_02='xfce' ;;
    startdde) BAK_FILE_PREFIX_02='deepin' ;;
    startlxqt) BAK_FILE_PREFIX_02='lxqt' ;;
    startlxde) BAK_FILE_PREFIX_02='lxde' ;;
    gnome-session) BAK_FILE_PREFIX_02='gnome' ;;
    esac
    if [ -z "${BAK_FILE_PREFIX_02}" ]; then
        BAK_FILE_PREFIX_03="${DEBIAN_FOLDER}"
    else
        BAK_FILE_PREFIX_03="${DEBIAN_FOLDER}+${BAK_FILE_PREFIX_02}"
    fi
    TARGET_BACKUP_FILE_NAME=$("${TUI_BIN:-whiptail}" --inputbox "è¯·è‡ªå®šä¹‰å¤‡ä»½çš„æ–‡ä»¶åç§°,è‹¥ç•™ç©º\nåˆ™å°†è‡ªåŠ¨å‘½åä¸º${BAK_FILE_PREFIX_03}\nPlease type the filename." 10 50 --title "FILENAME" 3>&1 1>&2 2>&3)
    TARGET_BACKUP_FILE_NAME="$(printf '%s\n' "${TARGET_BACKUP_FILE_NAME}" | head -n 1 | cut -d ' ' -f 1)"
    printf "%s\n" "${TARGET_BACKUP_FILE_NAME}"
    if [ -z ${TARGET_BACKUP_FILE_NAME} ]; then
        #printf "%s\n" "æ–‡ä»¶åç§°ä¸èƒ½ä¸ºç©ºï¼"
        #printf "%s\n" "The file name is ${RED}empty${RESET}."
        #press_enter_to_return
        #backup_system
        TARGET_BACKUP_FILE_NAME="${BAK_FILE_PREFIX_03}"
    fi
}
######################
backup_tmoe_container_preconfigure() {
    [[ -d ${CONTAINER_BACKUP_PATH} ]] || mkdir -pv ${CONTAINER_BACKUP_PATH}
    cd ${CONTAINER_BACKUP_PATH}
    backup_filename
    BACKUP_TIME_TMP=$(date +%Y-%m-%d_%H-%M)
}
#####################
backup_gnu_linux_container_to_external_tf() {
    if [ -h "${HOME}/storage/external-1" ]; then
        BACKUP_PATH="$(readlink ${HOME}/storage/external-1)/Download/backup/containers"
        printf "%s\n" "${RED}å¸è½½æˆ–æ¸…é™¤${RESET}termuxå°†æœ‰å¯èƒ½åŒæ—¶æ¸…ç©º${BLUE}${BACKUP_PATH}${RESET}"
        printf "%s\n" "${RED}Uninstalling${RESET} TERMUX will also clear the ${BLUE}${BACKUP_PATH}${RESET}."
        press_enter_to_continue
    else
        printf "%s\n" "${HOME}/storage/external-1éè½¯é“¾æ¥ï¼Œæ— æ³•ä¿å­˜è‡³è¯¥ç›®å½•,å°†è‡ªåŠ¨åˆ‡æ¢ä¸ºå†…ç½®å­˜å‚¨è®¾å¤‡ã€‚"
        check_container_backup_path
    fi
    case_backup_path_proot_or_chroot
    backup_gnu_linux_container
}
#####################
backup_system() {
    #check_zstd
    RETURN_TO_WHERE='backup_system'
    backup_system_menu_en() {
        OPTION=$("${TUI_BIN:-whiptail}" --title "BACKUP ${DEBIAN_FOLDER_CAPITAL}" --menu "Do you want to backup the container?(à¹‘Â´Ú¡\`à¹‘)" 0 50 0 \
            "1" "Clean up garbage and private data" \
            "2" "Backup ${DEBIAN_FOLDER} container" \
            "3" "Backup container to sd/tf card (only for termux)" \
            "0" "ğŸŒš Return to previous menu" \
            3>&1 1>&2 2>&3)
    }
    backup_system_menu_cn() {
        OPTION=$("${TUI_BIN:-whiptail}" --title "BACKUP ${DEBIAN_FOLDER_CAPITAL}" --menu "æ‚¨æƒ³è¦å¤‡ä»½${DEBIAN_FOLDER}å®¹å™¨æ•°æ®ä¹ˆï¼Ÿ(à¹‘Â´Ú¡\`à¹‘)" 0 50 0 \
            "1" "æ¸…ç†${DEBIAN_FOLDER}å®¹å™¨åƒåœ¾å’Œéšç§æ•°æ®" \
            "2" "å¤‡ä»½${DEBIAN_FOLDER} ${CONTAINER_TYPE}å®¹å™¨" \
            "3" "å¤‡ä»½å®¹å™¨è‡³å¤–ç½®sd/tf(ä»…é™termux)" \
            "0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
            3>&1 1>&2 2>&3)
    }
    case ${TMOE_MENU_LANG} in
    zh_*UTF-8) backup_system_menu_cn ;;
    *) backup_system_menu_en ;;
    esac
    #########################################
    case "${OPTION}" in
    0 | "") proot_management_menu ;;
    1) clean_up_container_garbage ;;
    2)
        check_container_backup_path
        backup_gnu_linux_container
        ;;
    3) backup_gnu_linux_container_to_external_tf ;;
    esac
    ####################
    press_enter_to_return
    backup_system
}
###########################
clean_up_container_garbage() {
    if [ -e "${DEBIAN_CHROOT}" ]; then
        cd ${DEBIAN_CHROOT}
    else
        printf "%s\n" "æœªæ£€æµ‹åˆ°å®¹å™¨ç›®å½•ï¼Œæ— æ³•æ¸…ç†åƒåœ¾æ–‡ä»¶ã€‚"
        press_enter_to_return
        backup_system
    fi
    CONTAINER_GARBAGE_FILES='tmp/.* tmp/* root/.cache root/.ICEauthority root/.Xauthority root/.bash_history root/.pki root/.chord root/.cocomusic.json root/.dbus root/.gnupg root/.gridea root/.l2s..ICEauthority* root/.l2s..Xauthority* root/.mozilla root/.petal.db root/.vnc/passwd root/.vnc/x11passwd root/.vnc/localhost* root/.config/Electron root/.config/Netron root/.config/chord root/.config/electron-netease-cloud-music root/.config/go-for-it root/.config/gridea root/.config/listen1 root/.config/lx-music-desktop root/.config/neofetch root/.config/netease-cloud-music-gtk root/.config/pulse root/.config/tenvideo_universal root/.xfce4-session.verbose-log root/.xfce4-session.verbose-log.last root/.zcompdump-localhost* root/.z root/.zsh_history'
    CONTAINER_GARBAGE_FILES_02='var/cache/apt/archives/* \
var/cache/apt/* \
var/cache/pacman/pkg/* \
var/mail/* \
var/log/* \
var/log/apt/* \
var/log/journal/* \
var/lib/apt/lists/*'
    #ä¸è¦åˆ é™¤å®¹å™¨çš„dev/* \

    if [ -e "root/.vnc/passwd" ]; then
        ls -lah ${CONTAINER_GARBAGE_FILES} 2>/dev/null
    fi
    printf "${BOLD}${YELLOW}%s${RESET}${RESET}\n" "${DEBIAN_CHROOT}"
    printf "%s\n" "${RED}rm -rvf${RESET} ${BLUE}${CONTAINER_GARBAGE_FILES}${RESET}"
    printf "%s\n" "${RED}rm -fv${RESET} ${BLUE}${CONTAINER_GARBAGE_FILES_02}${RESET}"
    cat <<-EOF
		å¦‚éœ€å°†å®¹å™¨åˆ†äº«ç»™ä»–äººï¼Œåˆ™å¯åˆ é™¤ä»¥ä¸Šæ–‡ä»¶ï¼Œå¦åˆ™è¯·å‹¿æ‰§è¡Œæ¸…ç†æ“ä½œã€‚
		æ‚¨è‹¥ä½¿ç”¨çš„æ˜¯debç³»åˆ—å‘è¡Œç‰ˆï¼Œåˆ™åœ¨æ¸…ç†å‰ï¼Œå¯ä»¥åœ¨å®¹å™¨å†…ä»¥sudoæˆ–rootæƒé™æ‰§è¡Œ${GREEN}apt clean;apt autoclean;apt autoremove --purge || apt autoremove${RESET}
		å¼€å‘è€…ä¸å¯¹è¯¯åˆ é™¤çš„æ–‡ä»¶è´Ÿè´£ï¼Œè¯·æ‚¨åœ¨æ¸…ç†å‰ç¡®ä¿ä»¥ä¸Šåˆ—è¡¨ä¸­æ— é‡è¦æ–‡ä»¶ï¼Œå¦åˆ™è¯·è¾“n
		If you want to share the container with others, you can delete the above files, otherwise, please type n to return.
	EOF
    do_you_want_to_continue
    ${TMOE_PREFIX} rm -rvf ${CONTAINER_GARBAGE_FILES}
    ${TMOE_PREFIX} rm -fv ${CONTAINER_GARBAGE_FILES_02}
}
#############
backup_gnu_linux_container() {
    backup_tmoe_container_preconfigure
    case ${TMOE_CHROOT} in
    true) CONTAINER_BACKUP_FILE_NAME="${TARGET_BACKUP_FILE_NAME}_${BACKUP_TIME_TMP}_chroot-rootfs_bak" ;;
    *) CONTAINER_BACKUP_FILE_NAME="${TARGET_BACKUP_FILE_NAME}_${BACKUP_TIME_TMP}-rootfs_bak" ;;
    esac
    BACKUP_FOLDER="${DEBIAN_CHROOT}"
    #çµ•å°è·¯å¾‘ã€‚ä¸”ä¸åŒ…å«tmoe,debian-iå’ŒGIT_DIR
    #${ACROSS_ARCH_FILE} ${LINUX_CONTAINER_DISTRO_FILE}
    for i in ${PREFIX}/bin/tmoe ${PREFIX}/bin/startxsdl ${PREFIX}/bin/startvnc ${PREFIX}/bin/novnc ${PREFIX}/bin/debian ${PREFIX}/bin/stopvnc ${PREFIX}/bin/startx11vnc ${CONFIG_FOLDER} ${HOME}/å®¹å™¨é€‰æ‹©èœå•.sh ${HOME}/å¤©èŒ-ã‚³ãƒ³ãƒ†ãƒŠ-ãƒ¡ãƒ‹ãƒ¥ãƒ¼.sh ${HOME}/TMOE-CONTAINER-MENU.sh; do
        [[ ! -e ${i} ]] || BACKUP_FOLDER="${BACKUP_FOLDER} ${i}"
    done

    case ${LINUX_DISTRO} in
    Android) QEMU_PREFIX=${PREFIX}/bin ;;
    *) QEMU_PREFIX=/usr/bin ;;
    esac

    for i in ${TMOE_LINUX_DIR}/lib ${TMOE_LINUX_DIR}/lib32; do
        [[ ! -e ${i} ]] || BACKUP_FOLDER="${BACKUP_FOLDER} ${i}"
    done

    if ("${TUI_BIN:-whiptail}" --title "Select compression type é€‰æ‹©å‹ç¼©ç±»å‹ " --yes-button "tar.zst" --no-button "tar.xz" --yesno "tar.zståœ¨é€Ÿåº¦å’Œå‹ç¼©ç‡ä¹‹é—´ä¿æŒå¹³è¡¡\ntar.xzå‹ç¼©ç‡é«˜,ä½†é€Ÿåº¦æ…¢\ntar.zst compresses faster.\ntar.xz has a higher compression ration, but is slower." 11 50); then
        printf "${BLOD}%s${RESET} ${BLUE}%s${RESET}\n" "å°†å¤‡ä»½ä»¥ä¸‹æ–‡ä»¶/ç›®å½•ï¼š" "${BACKUP_FOLDER}"
        printf "%s\n" "æ‚¨é€‰æ‹©äº†tar.zst,å³å°†ä¸ºæ‚¨å¤‡ä»½è‡³${CONTAINER_BACKUP_PATH}/${CONTAINER_BACKUP_FILE_NAME}.tar.zst"
        printf "%s\n" "${YELLOW}æŒ‰å›è½¦é”®å¼€å§‹å¤‡ä»½ã€‚Press Enter to start the backup.${RESET} "
        do_you_want_to_continue
        case ${TMOE_CHROOT} in
        true) ${TMOE_PREFIX} tar -I zstd -Ppcvf ${CONTAINER_BACKUP_FILE_NAME}.tar.zst --exclude=${DEBIAN_CHROOT}/media/sd --exclude=${DEBIAN_CHROOT}/media/tf --exclude=${DEBIAN_CHROOT}/media/termux ${BACKUP_FOLDER} ;;
        *)
            if [ "$(command -v pv)" ]; then
                tar -I zstd -Ppcf - --exclude=${DEBIAN_CHROOT}/media/sd --exclude=${DEBIAN_CHROOT}/media/tf --exclude=${DEBIAN_CHROOT}/media/termux ${BACKUP_FOLDER} | (pv -p --timer --rate --bytes >${CONTAINER_BACKUP_FILE_NAME}.tar.zst)
            else
                tar -I zstd -Ppcvf ${CONTAINER_BACKUP_FILE_NAME}.tar.zst --exclude=${DEBIAN_CHROOT}/media/sd --exclude=${DEBIAN_CHROOT}/media/tf --exclude=${DEBIAN_CHROOT}/media/termux ${BACKUP_FOLDER}
            fi
            ;;
        esac
    else
        #Which do yo like better? \n
        printf "${BLOD}%s${RESET} ${BLUE}%s${RESET}\n" "å°†å¤‡ä»½ä»¥ä¸‹æ–‡ä»¶/ç›®å½•ï¼š" "${BACKUP_FOLDER}"
        printf "%s\n" "æ‚¨é€‰æ‹©äº†tar.xz,å³å°†ä¸ºæ‚¨å¤‡ä»½è‡³${CONTAINER_BACKUP_PATH}/${CONTAINER_BACKUP_FILE_NAME}.tar.xz"
        printf "%s\n" "${YELLOW}æŒ‰å›è½¦é”®å¼€å§‹å¤‡ä»½ã€‚Press Enter to start the backup.${RESET} "
        do_you_want_to_continue
        #stopvncï¼ˆpkill allï¼‰åœ¨linuxä¸ä¼šè‡ªåŠ¨ç”Ÿæˆ
        ${TMOE_PREFIX} tar -PJpcvf ${CONTAINER_BACKUP_FILE_NAME}.tar.xz --exclude=${DEBIAN_CHROOT}/media/sd --exclude=${DEBIAN_CHROOT}/media/tf --exclude=${DEBIAN_CHROOT}/media/termux ${BACKUP_FOLDER}
    fi
    printf "%s\n" "Don't worry too much, it is normal for some directories to backup without permission."
    printf "%s\n" "éƒ¨åˆ†ç›®å½•æ— æƒé™å¤‡ä»½æ˜¯æ­£å¸¸ç°è±¡ã€‚"
    pwd
    ls -lth ./*tar* | grep ^- | head -n 1
    #printf "%s\n" 'gzipå‹ç¼©è‡³60%å®Œæˆæ˜¯æ­£å¸¸ç°è±¡ã€‚'
    printf "%s\n" 'å¤‡ä»½å®Œæˆ'
}
####################
backup_system
