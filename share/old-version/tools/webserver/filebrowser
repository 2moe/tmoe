################################
filebrowser_main() {
    case "$1" in
    r | -r) filebrowser_restart ;;
    *)
        install_filebrowser
        ;;
    esac
}
##################
install_filebrowser() {
    if [ ! $(command -v filebrowser) ]; then
        cd /tmp
        case "${ARCH_TYPE}" in
        "amd64" | "arm64")
            rm -rf .FileBrowserTEMPFOLDER
            git clone -b linux_${ARCH_TYPE} --depth=1 https://gitee.com/mo2/filebrowser.git ./.FileBrowserTEMPFOLDER
            cd /usr/local/bin
            tar -Jxvf /tmp/.FileBrowserTEMPFOLDER/filebrowser.tar.xz filebrowser
            chmod a+rx filebrowser
            rm -rf /tmp/.FileBrowserTEMPFOLDER
            ;;
        *)
            #https://github.com/filebrowser/filebrowser/releases
            #curl -fsSL https://raw.githubusercontent.com/filebrowser/get/master/get.sh | bash
            case "${ARCH_TYPE}" in
            "armhf") aria2c --console-log-level=warn --no-conf --allow-overwrite=true -s 5 -x 5 -k 1M -o .filebrowser.tar.gz 'https://github.com/filebrowser/filebrowser/releases/download/v2.1.0/linux-armv7-filebrowser.tar.gz' ;;
            "i386") aria2c --console-log-level=warn --no-conf --allow-overwrite=true -s 5 -x 5 -k 1M -o .filebrowser.tar.gz 'https://github.com/filebrowser/filebrowser/releases/download/v2.1.0/linux-386-filebrowser.tar.gz' ;;
            esac
            cd /usr/local/bin
            tar -zxvf /tmp/.filebrowser.tar.gz filebrowser
            chmod a+rx filebrowser
            rm -rf /tmp/.filebrowser.tar.gz
            ;;
        esac
    fi
    pgrep filebrowser &>/dev/null
    if [ "$?" = "0" ]; then
        FILEBROWSER_STATUS='æ£€æµ‹åˆ°filebrowserè¿›ç¨‹æ­£åœ¨è¿è¡Œ'
        FILEBROWSER_PROCESS='Restarté‡å¯'
    else
        FILEBROWSER_STATUS='æ£€æµ‹åˆ°filebrowserè¿›ç¨‹æœªè¿è¡Œ'
        FILEBROWSER_PROCESS='Startå¯åŠ¨'
    fi

    if (whiptail --title "ä½ æƒ³è¦å¯¹è¿™ä¸ªå°å¯çˆ±åšä»€ä¹ˆ" --yes-button "${FILEBROWSER_PROCESS}" --no-button 'Configureé…ç½®' --yesno "æ‚¨æ˜¯æƒ³è¦å¯åŠ¨æœåŠ¡è¿˜æ˜¯é…ç½®æœåŠ¡ï¼Ÿ${FILEBROWSER_STATUS}" 9 50); then
        if [ ! -e "/etc/filebrowser.db" ]; then
            printf "%s\n" "æ£€æµ‹åˆ°æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨ï¼Œ2såå°†ä¸ºæ‚¨è‡ªåŠ¨é…ç½®æœåŠ¡ã€‚"
            sleep 2s
            filebrowser_onekey
        fi
        filebrowser_restart
    else
        configure_filebrowser
    fi
}
############
configure_filebrowser() {
    #å…ˆè¿›å…¥etcç›®å½•ï¼Œé˜²æ­¢databaseåŠ è½½å¤±è´¥
    cd /etc
    TMOE_OPTION=$(
        whiptail --title "CONFIGURE FILEBROWSER" --menu "æ‚¨æƒ³è¦ä¿®æ”¹å“ªé¡¹é…ç½®ï¼Ÿä¿®æ”¹é…ç½®å‰å°†è‡ªåŠ¨åœæ­¢æœåŠ¡ã€‚" 0 50 0 \
            "1" "One-key conf åˆå§‹åŒ–ä¸€é”®é…ç½®" \
            "2" "add admin æ–°å»ºç®¡ç†å‘˜" \
            "3" "port ä¿®æ”¹ç«¯å£" \
            "4" "view logs æŸ¥çœ‹æ—¥å¿—" \
            "5" "languageè¯­è¨€ç¯å¢ƒ" \
            "6" "listen addr/ip ç›‘å¬ip" \
            "7" "è¿›ç¨‹ç®¡ç†è¯´æ˜" \
            "8" "stop åœæ­¢" \
            "9" "reset é‡ç½®æ‰€æœ‰é…ç½®ä¿¡æ¯" \
            "10" "remove å¸è½½/ç§»é™¤" \
            "0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
            3>&1 1>&2 2>&3
    )
    ##############################
    if [ "${TMOE_OPTION}" == '0' ]; then
        #tmoe_linux_tool_menu
        personal_netdisk
    fi
    ##############################
    if [ "${TMOE_OPTION}" == '1' ]; then
        pkill filebrowser
        service filebrowser stop 2>/dev/null || systemctl stop filebrowser
        filebrowser_onekey
    fi
    ##############################
    if [ "${TMOE_OPTION}" == '2' ]; then
        pkill filebrowser
        service filebrowser stop 2>/dev/null || systemctl stop filebrowser
        filebrowser_add_admin
    fi
    ##############################
    if [ "${TMOE_OPTION}" == '3' ]; then
        pkill filebrowser
        service filebrowser stop 2>/dev/null || systemctl stop filebrowser
        filebrowser_port
    fi
    ##############################
    if [ "${TMOE_OPTION}" == '4' ]; then
        filebrowser_logs
    fi
    ##############################
    if [ "${TMOE_OPTION}" == '5' ]; then
        pkill filebrowser
        service filebrowser stop 2>/dev/null || systemctl stop filebrowser
        filebrowser_language
    fi
    ##############################
    if [ "${TMOE_OPTION}" == '6' ]; then
        pkill filebrowser
        service filebrowser stop 2>/dev/null || systemctl stop filebrowser
        filebrowser_listen_ip
    fi
    ##############################
    if [ "${TMOE_OPTION}" == '7' ]; then
        filebrowser_systemd
    fi
    ##############################
    if [ "${TMOE_OPTION}" == '8' ]; then
        printf "%s\n" "æ­£åœ¨åœæ­¢æœåŠ¡è¿›ç¨‹..."
        printf "%s\n" "Stopping..."
        pkill filebrowser
        service filebrowser stop 2>/dev/null || systemctl stop filebrowser
        service filebrowser status 2>/dev/null || systemctl status filebrowser
    fi
    ##############################
    if [ "${TMOE_OPTION}" == '9' ]; then
        pkill filebrowser
        service filebrowser stop 2>/dev/null || systemctl stop filebrowser
        filebrowser_reset
    fi
    ##############################
    if [ "${TMOE_OPTION}" == '10' ]; then
        RETURN_TO_WHERE='configure_filebrowser'
        do_you_want_to_continue
        pkill filebrowser
        systemctl disable filebrowser
        service filebrowser stop 2>/dev/null || systemctl stop filebrowser
        rm -fv /usr/local/bin/filebrowser
        rm -fv /etc/systemd/system/filebrowser.service
        rm -fv /etc/filebrowser.db
    fi
    ########################################
    if [ -z "${TMOE_OPTION}" ]; then
        personal_netdisk
    fi
    ###########
    press_enter_to_return
    configure_filebrowser
}
##############
filebrowser_onekey() {
    cd /etc
    #åˆå§‹åŒ–æ•°æ®åº“æ–‡ä»¶
    filebrowser -d filebrowser.db config init
    #ç›‘å¬0.0.0.0
    filebrowser config set --address 0.0.0.0
    #è®¾å®šæ ¹ç›®å½•ä¸ºå½“å‰ä¸»ç›®å½•
    filebrowser config set --root ${HOME}
    filebrowser config set --port 38080
    #è®¾ç½®è¯­è¨€ç¯å¢ƒä¸ºä¸­æ–‡ç®€ä½“
    filebrowser config set --locale zh-cn
    #ä¿®æ”¹æ—¥å¿—æ–‡ä»¶è·¯å¾„
    filebrowser config set --log /var/log/filebrowser.log
    TARGET_USERNAME=$(whiptail --inputbox "è¯·è¾“å…¥è‡ªå®šä¹‰ç”¨æˆ·å,ä¾‹å¦‚root,admin,kawaii,moe,nekoç­‰ \n Please enter the username.Press Enter after the input is completed." 15 50 --title "USERNAME" 3>&1 1>&2 2>&3)
    exitstatus=$?
    if [ $exitstatus != 0 ]; then
        printf "%s\n" "ç”¨æˆ·åæ— æ•ˆï¼Œè¯·è¿”å›é‡è¯•ã€‚"
        press_enter_to_return
        filebrowser_onekey
    fi
    TARGET_USERPASSWD=$(whiptail --inputbox "è¯·è®¾å®šç®¡ç†å‘˜å¯†ç \n Please enter the password." 12 50 --title "PASSWORD" 3>&1 1>&2 2>&3)
    exitstatus=$?
    if [ $exitstatus != 0 ]; then
        printf "%s\n" "å¯†ç åŒ…å«æ— æ•ˆå­—ç¬¦ï¼Œè¯·è¿”å›é‡è¯•ã€‚"
        press_enter_to_return
        filebrowser_onekey
    fi
    filebrowser users add ${TARGET_USERNAME} ${TARGET_USERPASSWD} --perm.admin
    #filebrowser users update ${TARGET_USERNAME} ${TARGET_USERPASSWD}

    cat >/etc/systemd/system/filebrowser.service <<-'EndOFsystemd'
		[Unit]
		Description=FileBrowser
		After=network.target
		Wants=network.target

		[Service]
		Type=simple
		PIDFile=/var/run/filebrowser.pid
		ExecStart=/usr/local/bin/filebrowser -d /etc/filebrowser.db
		Restart=on-failure

		[Install]
		WantedBy=multi-user.target
	EndOFsystemd
    chmod a+rx /etc/systemd/system/filebrowser.service
    mkdir -pv /etc/init.d
    cd /etc/init.d
    cat >filebrowser <<-EndOFaria
#!/usr/bin/env bash
### BEGIN INIT INFO
# Provides:          filebrowser
# Required-Start:    \$network \$local_fs \$remote_fs
# Required-Stop:     \$remote_fs
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: filebrowser
### END INIT INFO
PATH=/bin:/usr/bin:/sbin:/usr/sbin
DAEMON=/usr/local/bin/filebrowser
NAME="filebrowser"
DESC="filebrowser"
PIDFILE=/var/run/filebrowser.pid


[ -x "\$DAEMON" ] || exit 0

. /lib/lsb/init-functions

DAEMON_OPTS=""

case "\$1" in
  start)
    printf "%s\n" "Starting filebrowser... "
   /usr/local/bin/filebrowser -d /etc/filebrowser.db &
    ;;
restart)
printf "%s\n" "Restarting filebrowser... "
 pkill filebrowser
 /usr/local/bin/filebrowser -d /etc/filebrowser.db &
 ;;
  stop)
    printf "%s\n" "Stopping filebrowser... "
    pkill filebrowser
     log_daemon_msg "Stopping \$DESC" "\$NAME"
     start-stop-daemon --stop --quiet --oknodo --pidfile \$PIDFILE --remove-pidfile --exec \$DAEMON
     log_end_msg \$?
    ;;
  status)
  status_of_proc -p \$PIDFILE "\$DAEMON" "\$NAME" && exit 0 || exit \$?
    ;;
  *)
    printf "%s\n" "Usage: /etc/init.d/filebrowser {start|stop|status}"
    exit 1
    ;;
esac
exit 0
EndOFaria
    chmod a+rx filebrowser

    systemctl daemon-reload 2>/dev/null
    #systemctl start filebrowser
    #service filebrowser start
    if (whiptail --title "systemctl enable filebrowserï¼Ÿ" --yes-button 'Yes' --no-button 'Noï¼' --yesno "æ˜¯å¦éœ€è¦å°†æ­¤æœåŠ¡è®¾ç½®ä¸ºå¼€æœºè‡ªå¯ï¼Ÿ" 9 50); then
        systemctl enable filebrowser
    fi
    filebrowser_restart
    ########################################
    press_enter_to_return
    configure_filebrowser
    #æ­¤å¤„çš„è¿”å›æ­¥éª¤å¹¶éå¤šä½™
}
############
filebrowser_restart() {
    FILEBROWSER_PORT=$(grep -a port /etc/filebrowser.db | sed 's@,@\n@g' | grep -a port | head -n 1 | cut -d ':' -f 2 | cut -d '"' -f 2)
    service filebrowser restart 2>/dev/null || systemctl restart filebrowser
    if [ "$?" != "0" ]; then
        pkill filebrowser
        nohup /usr/local/bin/filebrowser -d /etc/filebrowser.db 2>&1 >/var/log/filebrowser.log &
        tail -n 20 /var/log/filebrowser.log
    fi
    service filebrowser status 2>/dev/null || systemctl status filebrowser
    if [ "$?" = "0" ]; then
        printf "%s\n" "æ‚¨å¯ä»¥è¾“${YELLOW}service filebrowser stop${RESET}æ¥åœæ­¢è¿›ç¨‹"
    else
        printf "%s\n" "æ‚¨å¯ä»¥è¾“${YELLOW}pkill filebrowser${RESET}æ¥åœæ­¢è¿›ç¨‹"
    fi
    printf "%s\n" "æ­£åœ¨ä¸ºæ‚¨å¯åŠ¨filebrowseræœåŠ¡ï¼Œæœ¬æœºé»˜è®¤è®¿é—®åœ°å€ä¸ºlocalhost:${FILEBROWSER_PORT}"
    echo The LAN address å±€åŸŸç½‘åœ°å€ $(ip -4 -br -c a | tail -n 1 | cut -d '/' -f 1 | cut -d 'P' -f 2):${FILEBROWSER_PORT}
    echo The WAN address å¤–ç½‘åœ°å€ $(curl -sL ip.cip.cc | head -n 1):${FILEBROWSER_PORT}
    printf "%s\n" "${YELLOW}è¯·ä½¿ç”¨æµè§ˆå™¨æ‰“å¼€ä¸Šè¿°åœ°å€${RESET}"
    printf "%s\n" "Please use your browser to open the access address"
}
#############
filebrowser_add_admin() {
    pkill filebrowser
    service filebrowser stop 2>/dev/null || systemctl stop filebrowser
    printf "%s\n" "Stopping filebrowser..."
    printf "%s\n" "æ­£åœ¨åœæ­¢filebrowserè¿›ç¨‹..."
    printf "%s\n" "æ­£åœ¨æ£€æµ‹æ‚¨å½“å‰å·²åˆ›å»ºçš„ç”¨æˆ·..."
    filebrowser -d /etc/filebrowser.db users ls
    printf '%s\n' 'Press Enter to continue.'
    printf "%s\n" "${YELLOW}æŒ‰å›è½¦é”®ç»§ç»­ã€‚${RESET}"
    read
    TARGET_USERNAME=$(whiptail --inputbox "è¯·è¾“å…¥è‡ªå®šä¹‰ç”¨æˆ·å,ä¾‹å¦‚root,admin,kawaii,moe,nekoç­‰ \n Please enter the username.Press Enter after the input is completed." 15 50 --title "USERNAME" 3>&1 1>&2 2>&3)
    exitstatus=$?
    if [ $exitstatus != 0 ]; then
        printf "%s\n" "ç”¨æˆ·åæ— æ•ˆï¼Œæ“ä½œå–æ¶ˆ"
        press_enter_to_return
        configure_filebrowser
    fi
    TARGET_USERPASSWD=$(whiptail --inputbox "è¯·è®¾å®šç®¡ç†å‘˜å¯†ç \n Please enter the password." 12 50 --title "PASSWORD" 3>&1 1>&2 2>&3)
    exitstatus=$?
    if [ $exitstatus != 0 ]; then
        printf "%s\n" "å¯†ç åŒ…å«æ— æ•ˆå­—ç¬¦ï¼Œè¯·è¿”å›é‡è¯•ã€‚"
        press_enter_to_return
        filebrowser_add_admin
    fi
    cd /etc
    filebrowser users add ${TARGET_USERNAME} ${TARGET_USERPASSWD} --perm.admin
    #filebrowser users update ${TARGET_USERNAME} ${TARGET_USERPASSWD} --perm.admin
}
#################
filebrowser_port() {
    FILEBROWSER_PORT=$(grep -a port /etc/filebrowser.db | sed 's@,@\n@g' | grep -a port | head -n 1 | cut -d ':' -f 2 | cut -d '"' -f 2)
    TARGET_PORT=$(whiptail --inputbox "è¯·è¾“å…¥æ–°çš„ç«¯å£å·(çº¯æ•°å­—)ï¼ŒèŒƒå›´åœ¨1-65525ä¹‹é—´,æ£€æµ‹åˆ°æ‚¨å½“å‰çš„ç«¯å£ä¸º${FILEBROWSER_PORT}\n Please enter the port number." 12 50 --title "PORT" 3>&1 1>&2 2>&3)
    exitstatus=$?
    if [ $exitstatus != 0 ]; then
        printf "%s\n" "æ£€æµ‹åˆ°æ‚¨å–æ¶ˆäº†æ“ä½œï¼Œè¯·è¿”å›é‡è¯•ã€‚"
        press_enter_to_return
        configure_filebrowser
    fi
    filebrowser config set --port ${TARGET_PORT}
}
############
filebrowser_logs() {
    if [ ! -f "/var/log/filebrowser.log" ]; then
        printf "%s\n" "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ‚¨å¯èƒ½æ²¡æœ‰å¯ç”¨è®°å½•æ—¥å¿—çš„åŠŸèƒ½"
        printf "%s\n" "${YELLOW}æŒ‰å›è½¦é”®å¯ç”¨ã€‚${RESET}"
        read
        filebrowser -d /etc/filebrowser.db config set --log /var/log/filebrowser.log
    fi
    ls -lh /var/log/filebrowser.log
    printf "%s\n" "æŒ‰Ctrl+Cé€€å‡ºæ—¥å¿—è¿½è¸ªï¼Œpress Ctrl+C to exit."
    tail -Fvn 35 /var/log/filebrowser.log
    #if [ $(command -v less) ]; then
    # sed -n p /var/log/filebrowser.log | less -meQ
    #else
    # sed -n p /var/log/filebrowser.log
    #fi

}
#################
filebrowser_language() {
    TARGET_LANG=$(whiptail --inputbox "Please enter the language format, for example en,zh-cn" 12 50 --title "LANGUAGE" 3>&1 1>&2 2>&3)
    exitstatus=$?
    if [ $exitstatus != 0 ]; then
        printf "%s\n" "æ£€æµ‹åˆ°æ‚¨å–æ¶ˆäº†æ“ä½œï¼Œè¯·è¿”å›é‡è¯•ã€‚"
        press_enter_to_return
        configure_filebrowser
    fi
    filebrowser config set --port ${TARGET_LANG}
}
###############
filebrowser_listen_ip() {
    TARGET_IP=$(whiptail --inputbox "Please enter the listen address, for example 0.0.0.0\né»˜è®¤æƒ…å†µä¸‹æ— éœ€ä¿®æ”¹ã€‚" 12 50 --title "listen" 3>&1 1>&2 2>&3)
    exitstatus=$?
    if [ $exitstatus != 0 ]; then
        printf "%s\n" "æ£€æµ‹åˆ°æ‚¨å–æ¶ˆäº†æ“ä½œï¼Œè¯·è¿”å›é‡è¯•ã€‚"
        press_enter_to_return
        configure_filebrowser
    fi
    filebrowser config set --address ${TARGET_IP}
}
##################
filebrowser_systemd() {
    case "${TMOE_PROOT}" in
    true)
        printf "%s\n" "æ£€æµ‹åˆ°æ‚¨å½“å‰å¤„äº${BLUE}prootå®¹å™¨${RESET}ç¯å¢ƒä¸‹ï¼Œæ— æ³•ä½¿ç”¨systemctlå‘½ä»¤"
        ;;
    false) printf "%s\n" "æ£€æµ‹åˆ°æ‚¨å½“å‰å¤„äºchrootå®¹å™¨ç¯å¢ƒä¸‹ï¼Œæ— æ³•ä½¿ç”¨systemctlå‘½ä»¤" ;;
    esac
    cat <<-'EOF'
		systemdç®¡ç†
			è¾“systemctl start filebrowserå¯åŠ¨
			è¾“systemctl stop filebrowseråœæ­¢
			è¾“systemctl status filebrowseræŸ¥çœ‹è¿›ç¨‹çŠ¶æ€
			è¾“systemctl enable filebrowserå¼€æœºè‡ªå¯
			è¾“systemctl disable filebrowserç¦ç”¨å¼€æœºè‡ªå¯

			serviceå‘½ä»¤
			è¾“service filebrowser startå¯åŠ¨
			è¾“service filebrowser stopåœæ­¢
			è¾“service filebrowser statusæŸ¥çœ‹è¿›ç¨‹çŠ¶æ€
		        
			å…¶å®ƒå‘½ä»¤(é€‚ç”¨äºserviceå’Œsystemctléƒ½æ— æ³•ä½¿ç”¨çš„æƒ…å†µ)
			1:
			filebrowser -d /etc/filebrowser.db
			2ï¼š
			debian-i file
			3(åœæ­¢):
			pkill filebrowser 
	EOF
}
###############
filebrowser_reset() {
    printf "%s\n" "${YELLOW}WARNINGï¼ç»§ç»­æ‰§è¡Œæ­¤æ“ä½œå°†ä¸¢å¤±æ‰€æœ‰é…ç½®ä¿¡æ¯ï¼${RESET}"
    RETURN_TO_WHERE='configure_filebrowser'
    do_you_want_to_continue
    rm -vf filebrowser.db
    filebrowser -d filebrowser.db config init
}
##############
filebrowser_main
