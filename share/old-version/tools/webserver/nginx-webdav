#!/usr/bin/env bash
################################
install_nginx_webdav() {
    pgrep nginx &>/dev/null
    if [ "$?" = "0" ]; then
        FILEBROWSER_STATUS='æ£€æµ‹åˆ°nginxè¿›ç¨‹æ­£åœ¨è¿è¡Œ'
        FILEBROWSER_PROCESS='Restarté‡å¯'
    else
        FILEBROWSER_STATUS='æ£€æµ‹åˆ°nginxè¿›ç¨‹æœªè¿è¡Œ'
        FILEBROWSER_PROCESS='Startå¯åŠ¨'
    fi

    if (whiptail --title "ä½ æƒ³è¦å¯¹è¿™ä¸ªå°å¯çˆ±åšä»€ä¹ˆ" --yes-button "${FILEBROWSER_PROCESS}" --no-button 'Configureé…ç½®' --yesno "æ‚¨æ˜¯æƒ³è¦å¯åŠ¨æœåŠ¡è¿˜æ˜¯é…ç½®æœåŠ¡ï¼Ÿ${FILEBROWSER_STATUS}" 9 50); then
        if [ ! -e "/etc/nginx/conf.d/webdav.conf" ]; then
            printf "%s\n" "æ£€æµ‹åˆ°é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œ2såå°†ä¸ºæ‚¨è‡ªåŠ¨é…ç½®æœåŠ¡ã€‚"
            sleep 2s
            nginx_onekey
        fi
        nginx_restart
    else
        configure_nginx_webdav
    fi
}
#############
configure_nginx_webdav() {
    #è¿›å…¥nginx webdavé…ç½®æ–‡ä»¶ç›®å½•
    cd /etc/nginx/conf.d/
    TMOE_OPTION=$(whiptail --title "CONFIGURE WEBDAV" --menu "æ‚¨æƒ³è¦ä¿®æ”¹å“ªé¡¹é…ç½®ï¼ŸWhich configuration do you want to modify?" 0 50 0 \
        "1" "One-key conf åˆå§‹åŒ–ä¸€é”®é…ç½®" \
        "2" "ç®¡ç†è®¿é—®è´¦å·" \
        "3" "view logs æŸ¥çœ‹æ—¥å¿—" \
        "4" "WebDAV port ä¿®æ”¹webdavç«¯å£" \
        "5" "Nginx port ä¿®æ”¹nginxç«¯å£" \
        "6" "è¿›ç¨‹ç®¡ç†è¯´æ˜" \
        "7" "stop åœæ­¢" \
        "8" "Root dirä¿®æ”¹æ ¹ç›®å½•" \
        "9" "reset nginxé‡ç½®nginx" \
        "10" "remove å¸è½½/ç§»é™¤" \
        "0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
        3>&1 1>&2 2>&3)
    ##############################
    case "${TMOE_OPTION}" in
    0 | "") personal_netdisk ;;
    1)
        pkill nginx
        service nginx stop 2>/dev/null || systemctl stop nginx
        nginx_onekey
        ;;
    2) nginx_add_admin ;;
    3) nginx_logs ;;
    4) nginx_webdav_port ;;
    5) nginx_port ;;
    6) nginx_systemd ;;
    7)
        printf "%s\n" "æ­£åœ¨åœæ­¢æœåŠ¡è¿›ç¨‹..."
        printf "%s\n" "Stopping..."
        pkill nginx
        service nginx stop 2>/dev/null || systemctl stop nginx
        service nginx status || systemctl status nginx
        ;;
    8) nginx_webdav_root_dir ;;
    9)
        printf "%s\n" "æ­£åœ¨åœæ­¢nginxè¿›ç¨‹..."
        printf "%s\n" "Stopping nginx..."
        pkill nginx
        service nginx stop 2>/dev/null || systemctl stop nginx
        nginx_reset
        ;;
    10)
        remove_nginx
        ;;
    esac
    ##############################
    press_enter_to_return
    configure_nginx_webdav
}
##############
remove_nginx() {
    pkill nginx
    printf "%s\n" "æ­£åœ¨åœæ­¢nginxè¿›ç¨‹..."
    printf "%s\n" "Stopping nginx..."
    service nginx stop 2>/dev/null || systemctl stop nginx
    rm -fv /etc/nginx/conf.d/webdav.conf
    printf "%s\n" "${YELLOW}å·²åˆ é™¤webdavé…ç½®æ–‡ä»¶,${RESET}"
    printf "%s\n" "æ˜¯å¦ç»§ç»­å¸è½½nginx?"
    printf "%s\n" "æ‚¨æ­£åœ¨æ‰§è¡Œå±é™©æ“ä½œï¼Œå¸è½½nginxå°†å¯¼è‡´æ‚¨éƒ¨ç½²çš„æ‰€æœ‰ç½‘ç«™æ— æ³•è®¿é—®ï¼ï¼ï¼"
    printf "%s\n" "${YELLOW}This is a dangerous operation, you must press Enter to confirm${RESET}"
    service nginx restart || systemctl restart nginx
    RETURN_TO_WHERE='configure_nginx_webdav'
    do_you_want_to_continue
    service nginx stop || systemctl stop nginx
    ${TMOE_REMOVAL_COMMAND} nginx nginx-extras
}
###################
nginx_onekey() {
    case "${TMOE_PROOT}" in
    true | no | false)
        printf "%s\n" "æ£€æµ‹åˆ°æ‚¨å¤„äº${BLUE}chroot/prootå®¹å™¨${RESET}ç¯å¢ƒä¸‹ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å‡ºç°å¼‚å¸¸ã€‚"
        printf "%s\n" "éƒ¨åˆ†ç³»ç»Ÿå¯èƒ½ä¼šå‡ºç°failedï¼Œä½†ä»èƒ½æ­£å¸¸è¿æ¥ã€‚"
        CHROOT_STATUS='1'
        ;;
    esac
    printf "%s\n" "æœ¬æœåŠ¡ä¾èµ–äºè½¯ä»¶æºä»“åº“çš„nginx,å¯èƒ½æ— æ³•ä¸å®å¡”ç­‰ç¬¬ä¸‰æ–¹é¢æ¿çš„nginxç›¸äº’å…¼å®¹"
    printf "%s\n" "è‹¥80å’Œ443ç«¯å£è¢«å ç”¨ï¼Œåˆ™æœ‰å¯èƒ½å¯¼è‡´nginxå¯åŠ¨å¤±è´¥ï¼Œè¯·ä¿®æ”¹nginxä¸º1024ä»¥ä¸Šçš„é«˜ä½ç«¯å£ã€‚"
    printf "%s\n" "å®‰è£…å®Œæˆåï¼Œè‹¥æµè§ˆå™¨æµ‹è¯•è¿æ¥æˆåŠŸï¼Œåˆ™æ‚¨å¯ä»¥æ¢ç”¨æ–‡ä»¶ç®¡ç†å™¨è¿›è¡Œç®¡ç†ã€‚"
    printf "%s\n" "ä¾‹å¦‚Androidç«¯çš„Solid Explorer,windowsç«¯çš„RaiDrive"
    printf '%s\n' 'Press Enter to confirm.'
    printf "%s\n" "é»˜è®¤webdavæ ¹ç›®å½•ä¸º/mediaï¼Œæ‚¨å¯ä»¥åœ¨å®‰è£…å®Œæˆåè‡ªè¡Œä¿®æ”¹ã€‚"
    RETURN_TO_WHERE='configure_nginx_webdav'
    do_you_want_to_continue

    DEPENDENCY_01='nginx'
    DEPENDENCY_02='apache2-utils'

    case "${LINUX_DISTRO}" in
    "debian") DEPENDENCY_01="${DEPENDENCY_01} nginx-extras" ;;
    esac
    beta_features_quick_install
    ##############
    mkdir -pv /media
    touch "/media/æ¬¢è¿ä½¿ç”¨tmoe-linux-webdav_ä½ å¯ä»¥å°†æ–‡ä»¶å¤åˆ¶è‡³æ ¹ç›®å½•ä¸‹çš„mediaæ–‡ä»¶å¤¹"
    if [ -e "${HOME}/sd" ]; then
        ln -sf "${HOME}"/sd /media/
    fi

    if [ -e "${HOME}/tf" ]; then
        ln -sf "${HOME}"/tf /media/
    fi

    if [ -e "${HOME}/termux" ]; then
        ln -sf "${HOME}"/termux /media/
    fi

    if [ "${CHROOT_STATUS}" = "1" ]; then
        printf "%s\n" "æ£€æµ‹åˆ°æ‚¨å¤„äºå®¹å™¨ç¯å¢ƒä¸‹"
        cd /etc/nginx/sites-available || exit 1
        if [ ! -f "default.tar.gz" ]; then
            tar -zcvf default.tar.gz default
        fi
        tar -zxvf default.tar.gz default
        ls -lh /etc/nginx/sites-available/default
        sed -i 's@80 default_server@2086 default_server@g' default
        sed -i 's@443 ssl default_server@8443 ssl default_server@g' default
        printf "%s\n" "å·²å°†æ‚¨çš„nginxçš„httpç«¯å£ä»80ä¿®æ”¹ä¸º2086ï¼Œhttpsç«¯å£ä»443ä¿®æ”¹ä¸º8443"
    fi

    cd /etc/nginx/conf.d/ || exit 1
    cat >webdav.conf <<-'EndOFnginx'
		server {
		    listen       28080;
		    server_name  webdav;
		    error_log /var/log/nginx/webdav.error.log error;
		    access_log  /var/log/nginx/webdav.access.log combined;
		    location / {
		        root /media;
		        charset utf-8;
		        autoindex on;
		        dav_methods PUT DELETE MKCOL COPY MOVE;
		        dav_ext_methods PROPFIND OPTIONS;
		        create_full_put_path  on;
		        dav_access user:rw group:r all:r;
		        auth_basic "Not currently available";
		        auth_basic_user_file /etc/nginx/conf.d/.htpasswd.webdav;
		    }
		    error_page   500 502 503 504  /50x.html;
		    location = /50x.html {
		        root   /usr/share/nginx/html;
		    }
		}
	EndOFnginx
    #############
    TARGET_USERNAME=$(whiptail --inputbox "è¯·è‡ªå®šä¹‰webdavç”¨æˆ·å,ä¾‹å¦‚root,admin,kawaii,moe,nekoç­‰ \n Please enter the username.Press Enter after the input is completed." 15 50 --title "USERNAME" 3>&1 1>&2 2>&3)
    exitstatus=$?
    if [ $exitstatus != 0 ]; then
        printf "%s\n" "ç”¨æˆ·åæ— æ•ˆï¼Œè¯·è¿”å›é‡è¯•ã€‚"
        press_enter_to_return
        nginx_onekey
    fi
    TARGET_USERPASSWD=$(whiptail --inputbox "è¯·è®¾å®šè®¿é—®å¯†ç \n Please enter the password." 12 50 --title "PASSWORD" 3>&1 1>&2 2>&3)
    exitstatus=$?
    if [ $exitstatus != 0 ]; then
        printf "%s\n" "å¯†ç åŒ…å«æ— æ•ˆå­—ç¬¦ï¼Œè¯·è¿”å›é‡è¯•ã€‚"
        press_enter_to_return
        nginx_onekey
    fi
    htpasswd -mbc /etc/nginx/conf.d/.htpasswd.webdav ${TARGET_USERNAME} ${TARGET_USERPASSWD}
    nginx -t
    if [ "$?" != "0" ]; then
        sed -i 's@dav_methods@# &@' webdav.conf
        sed -i 's@dav_ext_methods@# &@' webdav.conf
        nginx -t
    fi
    nginx_restart
    ########################################
    press_enter_to_return
    configure_nginx_webdav
    #æ­¤å¤„çš„è¿”å›æ­¥éª¤å¹¶éå¤šä½™
}
############
nginx_restart() {
    cd /etc/nginx/conf.d/ || exit 1
    NGINX_WEBDAV_PORT=$(grep listen webdav.conf | head -n 1 | cut -d ';' -f 1 | awk -F ' ' '$0=$NF')
    service nginx restart 2>/dev/null || systemctl restart nginx
    if [ "$?" != "0" ]; then
        /etc/init.d/nginx reload
    fi
    service nginx status 2>/dev/null || systemctl status nginx
    if [ "$?" = "0" ]; then
        printf "%s\n" "æ‚¨å¯ä»¥è¾“${YELLOW}service nginx stop${RESET}æ¥åœæ­¢è¿›ç¨‹"
    else
        printf "%s\n" "æ‚¨å¯ä»¥è¾“${YELLOW}/etc/init.d/nginx stop${RESET}æ¥åœæ­¢è¿›ç¨‹"
    fi
    tail -n 10 /var/log/nginx/webdav.error.log
    tail -n 10 /var/log/nginx/webdav.access.log
    printf "%s\n" "æ­£åœ¨ä¸ºæ‚¨å¯åŠ¨nginxæœåŠ¡ï¼Œæœ¬æœºé»˜è®¤è®¿é—®åœ°å€ä¸ºlocalhost:${NGINX_WEBDAV_PORT}"
    echo The LAN address å±€åŸŸç½‘åœ°å€ $(ip -4 -br -c a | tail -n 1 | cut -d '/' -f 1 | cut -d 'P' -f 2):${NGINX_WEBDAV_PORT}
    echo The WAN address å¤–ç½‘åœ°å€ $(curl -sL ip.cip.cc | head -n 1):${NGINX_WEBDAV_PORT}
    printf "%s\n" "${YELLOW}æ‚¨å¯ä»¥ä½¿ç”¨æ–‡ä»¶ç®¡ç†å™¨æˆ–æµè§ˆå™¨æ¥æ‰“å¼€WebDAVè®¿é—®åœ°å€${RESET}"
    printf "%s\n" "Please use your browser to open the access address"
}
#############
nginx_add_admin() {
    TARGET_USERNAME=$(whiptail --inputbox "æ‚¨æ­£åœ¨é‡ç½®webdavè®¿é—®ç”¨æˆ·,è¯·è¾“å…¥æ–°ç”¨æˆ·å,ä¾‹å¦‚root,admin,kawaii,moe,nekoç­‰ \n Please enter the username.Press Enter after the input is completed." 15 50 --title "USERNAME" 3>&1 1>&2 2>&3)
    exitstatus=$?
    if [ $exitstatus != 0 ]; then
        printf "%s\n" "ç”¨æˆ·åæ— æ•ˆï¼Œæ“ä½œå–æ¶ˆ"
        press_enter_to_return
        configure_nginx_webdav
    fi
    TARGET_USERPASSWD=$(whiptail --inputbox "è¯·è®¾å®šè®¿é—®å¯†ç \n Please enter the password." 12 50 --title "PASSWORD" 3>&1 1>&2 2>&3)
    exitstatus=$?
    if [ $exitstatus != 0 ]; then
        printf "%s\n" "å¯†ç åŒ…å«æ— æ•ˆå­—ç¬¦ï¼Œè¯·è¿”å›é‡è¯•ã€‚"
        press_enter_to_return
        nginx_add_admin
    fi
    htpasswd -mbc /etc/nginx/conf.d/.htpasswd.webdav "${TARGET_USERNAME}" "${TARGET_USERPASSWD}"
    nginx_restart
}
#################
nginx_webdav_port() {
    NGINX_WEBDAV_PORT=$(grep listen webdav.conf | head -n 1 | cut -d ';' -f 1 | awk -F ' ' '$0=$NF')
    TARGET_PORT=$(whiptail --inputbox "è¯·è¾“å…¥æ–°çš„ç«¯å£å·(çº¯æ•°å­—)ï¼ŒèŒƒå›´åœ¨1-65525ä¹‹é—´,æ£€æµ‹åˆ°æ‚¨å½“å‰çš„ç«¯å£ä¸º${NGINX_WEBDAV_PORT}\n Please enter the port number." 12 50 --title "PORT" 3>&1 1>&2 2>&3)
    exitstatus=$?
    if [ $exitstatus != 0 ]; then
        printf "%s\n" "æ£€æµ‹åˆ°æ‚¨å–æ¶ˆäº†æ“ä½œï¼Œè¯·è¿”å›é‡è¯•ã€‚"
        press_enter_to_return
        configure_nginx_webdav
    fi
    sed -i "s@${NGINX_WEBDAV_PORT}\;@${TARGET_PORT}\;@" webdav.conf
    ls -l $(pwd)/webdav.conf
    cat webdav.conf | grep listen
    /etc/init.d/nginx reload
}
#################
nginx_port() {
    cd /etc/nginx/sites-available
    NGINX_PORT=$(grep -E 'listen|default' default | head -n 1 | cut -d ';' -f 1 | cut -d 'd' -f 1 | awk -F ' ' '$0=$NF')
    TARGET_PORT=$(whiptail --inputbox "è¯·è¾“å…¥æ–°çš„ç«¯å£å·(çº¯æ•°å­—)ï¼ŒèŒƒå›´åœ¨1-65525ä¹‹é—´,æ£€æµ‹åˆ°æ‚¨å½“å‰çš„Nginxç«¯å£ä¸º${NGINX_PORT}\n Please enter the port number." 12 50 --title "PORT" 3>&1 1>&2 2>&3)
    exitstatus=$?
    if [ $exitstatus != 0 ]; then
        printf "%s\n" "æ£€æµ‹åˆ°æ‚¨å–æ¶ˆäº†æ“ä½œï¼Œè¯·è¿”å›é‡è¯•ã€‚"
        press_enter_to_return
        configure_nginx_webdav
    fi
    cp -pvf default default.bak
    tar -zxvf default.tar.gz default
    sed -i "s@80 default_server@${TARGET_PORT} default_server@g" default
    ls -l $(pwd)/default
    grep -E 'listen|default' default | grep -v '#'
    /etc/init.d/nginx reload
}
############
nginx_logs() {
    tail -n 10 /var/log/nginx/webdav.error.log
    if [ "$(command -v less)" ]; then
        less -meQ /var/log/nginx/webdav.access.log
    else
        tail -n 10 /var/log/nginx/webdav.access.log
    fi
    ls -lh /var/log/nginx/webdav.error.log
    ls -lh /var/log/nginx/webdav.access.log
}
#############
nginx_webdav_root_dir() {
    NGINX_WEBDAV_ROOT_DIR=$(cat webdav.conf | grep root | head -n 1 | cut -d ';' -f 1 | awk -F ' ' '$0=$NF')
    TARGET_PATH=$(whiptail --inputbox "è¯·è¾“å…¥æ–°çš„è·¯å¾„,ä¾‹å¦‚/media/root,æ£€æµ‹åˆ°æ‚¨å½“å‰çš„webDAVæ ¹ç›®å½•ä¸º${NGINX_WEBDAV_ROOT_DIR}\n Please enter the port number." 12 50 --title "PATH" 3>&1 1>&2 2>&3)
    exitstatus=$?
    if [ $exitstatus != 0 ]; then
        printf "%s\n" "æ£€æµ‹åˆ°æ‚¨å–æ¶ˆäº†æ“ä½œï¼Œè¯·è¿”å›é‡è¯•ã€‚"
        press_enter_to_return
        configure_nginx_webdav
    fi
    sed -i "s@${NGINX_WEBDAV_ROOT_DIR}\;@${TARGET_PATH}\;@" webdav.conf
    ls -l $(pwd)/webdav.conf
    printf "%s\n" "æ‚¨å½“å‰çš„webdavæ ¹ç›®å½•å·²ä¿®æ”¹ä¸º$(grep root webdav.conf | head -n 1 | cut -d ';' -f 1 | awk -F ' ' '$0=$NF')"
    /etc/init.d/nginx reload
}
#################
nginx_systemd() {
    case "${TMOE_PROOT}" in
    true)
        printf "%s\n" "æ£€æµ‹åˆ°æ‚¨å½“å‰å¤„äº${BLUE}prootå®¹å™¨${RESET}ç¯å¢ƒä¸‹ï¼Œæ— æ³•ä½¿ç”¨systemctlå‘½ä»¤"
        ;;
    false) printf "%s\n" "æ£€æµ‹åˆ°æ‚¨å½“å‰å¤„äºchrootå®¹å™¨ç¯å¢ƒä¸‹ï¼Œæ— æ³•ä½¿ç”¨systemctlå‘½ä»¤" ;;
    esac
    cat <<-'EOF'
		    systemdç®¡ç†
			è¾“systemctl start nginxå¯åŠ¨
			è¾“systemctl stop nginxåœæ­¢
			è¾“systemctl status nginxæŸ¥çœ‹è¿›ç¨‹çŠ¶æ€
			è¾“systemctl enable nginxå¼€æœºè‡ªå¯
			è¾“systemctl disable nginxç¦ç”¨å¼€æœºè‡ªå¯

			serviceå‘½ä»¤
			è¾“service nginx startå¯åŠ¨
			è¾“service nginx stopåœæ­¢
			è¾“service nginx statusæŸ¥çœ‹è¿›ç¨‹çŠ¶æ€

		    init.dç®¡ç†
			/etc/init.d/nginx startå¯åŠ¨
			/etc/init.d/nginx restarté‡å¯
			/etc/init.d/nginx stopåœæ­¢
			/etc/init.d/nginx statussæŸ¥çœ‹è¿›ç¨‹çŠ¶æ€
			/etc/init.d/nginx reloadé‡æ–°åŠ è½½

	EOF
}
###############
nginx_reset() {
    printf "%s\n" "${YELLOW}WARNINGï¼ç»§ç»­æ‰§è¡Œæ­¤æ“ä½œå°†ä¸¢å¤±nginxé…ç½®ä¿¡æ¯ï¼${RESET}"
    RETURN_TO_WHERE='configure_nginx_webdav'
    do_you_want_to_continue
    cd /etc/nginx/sites-available
    tar zcvf default.tar.gz default
}
###############
install_nginx_webdav
