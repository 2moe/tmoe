####################
image_compression_menu() {
    RETURN_TO_WHERE='image_compression_menu'
    SOFTWARE=$(
        whiptail --title "image_compression" --menu \
            "TMOEæ‰¹é‡å‹ç¼©å›¾ç‰‡å°å·¥å…·,åŸºäºgraphicsmagick-imagemagick-compat" 0 0 0 \
            "1" "start å¯åŠ¨" \
            "2" "install dependencieså®‰è£…ä¾èµ–" \
            "3" "remove å¸è½½" \
            "0" "ğŸŒš Back to the main menu è¿”å›ä¸»èœå•" \
            3>&1 1>&2 2>&3
    )
    case "${SOFTWARE}" in
    0 | "") tmoe_multimedia_menu ;;
    1) image_compression_tool_gui_or_tui ;;
    2)
        DEPENDENCY_02='zenity'
        install_image_compression_tool
        ;;
    3) remove_image_compression_tool ;;
    esac
    ############################################
    press_enter_to_return
    image_compression_menu
}
###########
remove_image_compression_tool() {
    DEPENDENCY_01='ImageMagick imagemagick graphicsmagick-imagemagick-compat'
    DEPENDENCY_02='zenity'
    printf "%s\n" "${RED}${TMOE_REMOVAL_COMMAND}${RESET} ${BLUE}${DEPENDENCY_01} ${DEPENDENCY_02}${RESET}"
    do_you_want_to_continue
    ${TMOE_REMOVAL_COMMAND} ${DEPENDENCY_01} ${DEPENDENCY_02}
}
##########
install_image_compression_tool() {
    case ${LINUX_DISTRO} in
    debian) DEPENDENCY_01='graphicsmagick-imagemagick-compat' ;;
    redhat) DEPENDENCY_01='ImageMagick' ;;
    *) DEPENDENCY_01='imagemagick' ;;
    esac
    beta_features_quick_install
}
###############
fix_pic_folder_permissions() {
    if [ "${HOME}" != '/root' ]; then
        printf "%s\n" "chown -R ${CURRENT_USER_NAME}:${CURRENT_USER_GROUP} ${TMOE_COMPRESSION_FOLDER}"
        printf "%s\n" "æ­£åœ¨å°†${TMOE_COMPRESSION_FOLDER}çš„æƒé™ä¿®æ”¹ä¸º${CURRENT_USER_NAME}ç”¨æˆ·å’Œ${CURRENT_USER_GROUP}ç”¨æˆ·ç»„"
        chown -R ${CURRENT_USER_NAME}:${CURRENT_USER_GROUP} ${TMOE_COMPRESSION_FOLDER}
    fi
}
###########
tui_image_compression_tool() {
    FILE_EXT_01='jpg'
    FILE_EXT_02='png'
    if [ -e "${HOME}/å›¾ç‰‡" ]; then
        START_DIR="${HOME}/å›¾ç‰‡"
    elif [ -e "${HOME}/Pictures" ]; then
        START_DIR="${HOME}/Pictures"
    else
        START_DIR="${HOME}"
    fi
    IMPORTANT_TIPS='ä»»æ„é€‰æ‹©ä¸€å¼ å›¾ç‰‡,è¯¥æ–‡ä»¶å¤¹å†…çš„æ‰€æœ‰å›¾ç‰‡éƒ½å°†è¢«å‹ç¼©'
    tmoe_file_manager
    if [ -z ${SELECTION} ]; then
        printf "%s\n" "æ²¡æœ‰æŒ‡å®š${YELLOW}æœ‰æ•ˆ${RESET}çš„${BLUE}æ–‡ä»¶${GREEN}ï¼Œè¯·${GREEN}é‡æ–°${RESET}é€‰æ‹©"
    else
        choose_the_pic_quality
        catimg ${TMOE_FILE_ABSOLUTE_PATH} 2>/dev/null
        printf "%s\n" "è¯¥æ–‡ä»¶å¤¹å†…çš„${RED}æ‰€æœ‰å›¾ç‰‡${RESET}ï¼ˆä¸åŒ…å«å­ç›®å½•) éƒ½å°†è¢«å‹ç¼©"
        printf "%s\n" "å‹ç¼©è¿‡çš„å›¾ç‰‡å°†ä¿å­˜è‡³${FILE_PATH}/${TMOE_COMPRESSION_FOLDER}"
        do_you_want_to_continue
        compress_pics
    fi
}
#################
compress_pics() {
    cd ${FILE_PATH}
    if [ ! -e "${TMOE_COMPRESSION_FOLDER}" ]; then
        mkdir -pv ${TMOE_COMPRESSION_FOLDER}
    fi
    for TMOE_PICS in *; do
        convert +profile "*" -strip -quality ${TARGET} ${TMOE_PICS} ${TMOE_COMPRESSION_FOLDER}/${TMOE_PICS%%.*}.jpg
    done
    printf "%s\n" "å‹ç¼©å®Œæˆã€‚"
    fix_pic_folder_permissions
    ls -lah ${FILE_PATH}/${TMOE_COMPRESSION_FOLDER}
    xdg-open ${TMOE_COMPRESSION_FOLDER} 2>/dev/null
}
#############
choose_the_pic_quality() {
    TARGET=$(whiptail --inputbox "è‹¥æ•°å€¼ä¸ºç©º,åˆ™è‡ªåŠ¨è°ƒæ•´ä¸º80" 0 50 --title "è¯·è¾“å…¥å›¾ç‰‡è´¨é‡(1-99)" 3>&1 1>&2 2>&3)
    if [ "$?" != "0" ]; then
        ${RETURN_TO_WHERE}
    elif [ -z "${TARGET}" ]; then
        TARGET='80'
    fi
    TMOE_COMPRESSION_FOLDER="tmoe_compression_quality_${TARGET}"
}
##################
image_compression_tool_gui_or_tui() {
    check_imagemagick
    if (whiptail --title "GUI or TUI" --yes-button "GUI" --no-button "TUI" --yesno "æ‚¨æ˜¯æƒ³ç”¨å›¾å½¢ç”¨æˆ·ç•Œé¢,è¿˜æ˜¯æ–‡æœ¬ç”¨æˆ·ç•Œé¢å‘¢ï¼Ÿ\nDo you want to use GUI or TUI?\nè‹¥æ‚¨å¤„äºæ¡Œé¢ç¯å¢ƒä¸‹,åˆ™å»ºè®®é€‰æ‹©GUI,å¦åˆ™è¯·é€‰æ‹©TUIâ™ª(^âˆ‡^*) " 0 0); then
        gui_image_compression_tool
    else
        tui_image_compression_tool
    fi
}
################
check_imagemagick() {
    if [ ! $(command -v convert) ]; then
        DEPENDENCY_02=''
        install_image_compression_tool
    fi
}
#################
gui_image_compression_tool() {
    check_zenity
    PIC_DIR=$(zenity --title "è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶å¤¹ï¼Œå¹¶æŒ‰ç¡®è®¤é”®" --file-selection --directory)
    case "$?" in
    0) cd ${PIC_DIR} ;;
    *) ${RETURN_TO_WHERE} ;;
    esac
    ########
    zenity --question --title="tmoe-pic-compressorçš„æç¤ºo(*ï¿£â–½ï¿£*)o" --text="${PIC_DIR} å†…çš„æ‰€æœ‰å›¾ç‰‡æ–‡ä»¶å°†è¢«å‹ç¼©ï¼" --ok-label="å¥½å“’" --cancel-label="æˆ‘çŸ¥é“å•¦"
    TARGET=$(zenity --scale --title="Picture qualityå›¾ç‰‡è´¨é‡" --text "1ä¸ºæœ€ä½,99ä¸ºæœ€é«˜" --min-value=1 --max-value=99 --value=2 --step 2)
    case "$?" in
    0)
        TMOE_COMPRESSION_FOLDER="tmoe_compression_quality_${TARGET}"
        if [ ! -e "${TMOE_COMPRESSION_FOLDER}" ]; then
            mkdir -pv ${TMOE_COMPRESSION_FOLDER}
        fi
        xdg-open ${TMOE_COMPRESSION_FOLDER}
        (
            printf "%s\n" "10"
            printf "%s\n" "40"
            sleep 1
            for TMOE_PICS in *; do
                convert +profile "*" -strip -quality ${TARGET} ${TMOE_PICS} ${TMOE_COMPRESSION_FOLDER}/${TMOE_PICS%%.*}.jpg
            done
            printf "%s\n" "100"
            sleep 1
        ) | zenity --progress --title="æ­£åœ¨å‹ç¼©å›¾ç‰‡..." --text="æ­£åœ¨ä¿å­˜è‡³${TMOE_COMPRESSION_FOLDER}" --percentage=0 --auto-close
        fix_pic_folder_permissions
        ls -lah ${PIC_DIR}/${TMOE_COMPRESSION_FOLDER}
        printf "%s\n" "æ–‡ä»¶å·²ç»ä¿å­˜è‡³${BLUE}${PIC_DIR}/${TMOE_COMPRESSION_FOLDER}${RESET}"
        ;;
    *) ${RETURN_TO_WHERE} ;;
    esac
}
###########
image_compression_menu
