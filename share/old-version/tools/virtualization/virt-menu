#!/usr/bin/env bash
#######################
qemu_main() {
    case "$1" in
    -x64qemu)
        start_tmoe_qemu_tool
        ;;
    -arm64qemu)
        start_tmoe_qemu_aarch64_manager
        ;;
    -m | *)
        install_container_and_virtual_machine
        ;;
    esac
}
############
qemu_system_menu() {
    RETURN_TO_WHERE='qemu_system_menu'
    DEPENDENCY_01=''
    VIRTUAL_TECH=$(
        whiptail --title "qemu-system" --menu "æ‚¨æƒ³è¦é€‰æ‹©å“ªä¸€é¡¹å‘¢ï¼Ÿ" 0 0 0 \
            "1" "tmoe-qemu:x86_64/i386è™šæ‹Ÿæœºç®¡ç†" \
            "2" "virt-manager(GUIè™šæ‹Ÿæœºç®¡ç†å™¨)" \
            "3" "aqemu(QEMUå’ŒKVMçš„Qt5å‰ç«¯)" \
            "4" "gnome-boxes(ç®€å•åœ°ç®¡ç†è¿œç¨‹å’Œæœ¬åœ°è™šæ‹Ÿç³»ç»Ÿ)" \
            "0" "ðŸŒš Return to previous menu è¿”å›žä¸Šçº§èœå•" \
            3>&1 1>&2 2>&3
    )
    #############
    case ${VIRTUAL_TECH} in
    0 | "") install_container_and_virtual_machine ;;
    1) start_tmoe_qemu_tool ;;
    2) DEPENDENCY_02='virt-manager' ;;
    3) DEPENDENCY_02='aqemu' ;;
    4) DEPENDENCY_02='gnome-boxes' ;;
    esac
    #æœªå®‰è£…é¢å¤–è½¯ä»¶åŒ…,qemu-block-extra
    case ${VIRTUAL_TECH} in
    1) ;;
    *) beta_features_quick_install ;;
    esac
    ###############
    press_enter_to_return
    qemu_system_menu
}
#############
start_tmoe_qemu_tool() {
    source ${TMOE_TOOL_DIR}/virtualization/qemu/tmoe-qemu
}
virtual_machine_iso_file() {
    source ${TMOE_TOOL_DIR}/virtualization/iso.sh
}
install_container_and_virtual_machine() {
    RETURN_TO_WHERE='install_container_and_virtual_machine'
    VIRTUAL_TECH=$(
        whiptail --title "è™šæ‹ŸåŒ–ä¸Žapiçš„è½¬æ¢" --menu "Which option do you want to choose?" 0 0 0 \
            "1" "ðŸ’» qemu:å¼€æºã€è·¨å¹³å°çš„è™šæ‹Ÿæœº" \
            "2" "ðŸ“€ iso/qcow2:ä¸‹è½½é•œåƒ(linux,win11)" \
            "3" "ðŸ³ docker:å¼€æºçš„åº”ç”¨å®¹å™¨å¼•æ“Ž" \
            "4" "ðŸ–¥ï¸ VirtualBox(ç”²éª¨æ–‡å¼€æºè™šæ‹Ÿæœºx64)" \
            "5" "ðŸ· wine:è°ƒç”¨win apiå¹¶å³æ—¶è½¬æ¢" \
            "6" "genymotion(ä¸“ä¸ºAndroidå¼€å‘è€…æ‰“é€ çš„æ¨¡æ‹Ÿå™¨)" \
            "0" "ðŸŒš Return to previous menu è¿”å›žä¸Šçº§èœå•" \
            "00" "Back to the main menu è¿”å›žä¸»èœå•" \
            3>&1 1>&2 2>&3
    )
    #############
    case ${VIRTUAL_TECH} in
    0 | "") beta_features ;;
    00) tmoe_linux_tool_menu ;;
    1) qemu_system_menu ;;
    2) virtual_machine_iso_file ;;
    3) tmoe_docker_menu ;;
    4) install_virtual_box ;;
    5) wine_menu ;;
    6) install_genymotion ;;
    esac
    ###############
    press_enter_to_return
    install_container_and_virtual_machine
}
#"4" "OpenMediaVault(åŸºäºŽdebiançš„NASç½‘ç»œè¿žæŽ¥å­˜å‚¨è§£å†³æ–¹æ¡ˆ)" \
#4) install_open_media_vault ;;
install_genymotion() {
    cat <<-EOF
		é¦–å…ˆï¼Œå®‰è£virtual box, ç„¶å¾Œå‰å¾€å®˜ç¶²ä¸‹è¼‰genymotionã€‚
		${YELLOW}https://www.genymotion.com/download/${RESET}
		ç¤ºä¾‹ï¼šç”¨curlä¸‹è¼‰ï¼Œä¸¦æŒ‡å®šæ–‡ä»¶åç¨±çˆ²${YELLOW}genymotion.bin${RESET}
		æ³¨æ„ï¼šè«‹æŠŠè—è‰²é«˜äº®æ–‡æœ¬æ›¿æ›çˆ²æœ€æ–°ç‰ˆurl
		${GREEN}curl -Lo ${YELLOW}genymotion.bin ${BLUE}"https://dl.genymotion.com/releases/genymotion-3.2.1/genymotion-3.2.1-linux_x64.bin"${RESET}
	EOF
    URL=$(curl -L https://www.genymotion.com/download/ | grep linux_x64.bin | awk -F '<a href=' '{print $2}' | cut -d '"' -f 2)
    cat <<-EOF
		æª¢æ¸¬åˆ°æœ€æ–°ç‰ˆurlçˆ²${BLUE}${URL}${RESET}
		æ‚¨å¯ä»¥å°‡ä¸Šè¿°æŒ‡ä»¤æ›¿æ›çˆ²
		${GREEN}curl -Lo ${YELLOW}genymotion.bin ${BLUE}"${URL}"${RESET}
		æŽ¥ç€è³¦äºˆ genymotion.bin å¯åŸ·è¡Œæ¬Šé™ï¼Œä¸¦é‹è¡Œå®ƒã€‚
		${GREEN}chmod +x genymotion.bin
		./genymotion.bin${RESET}
		æœ€å¾Œé‹è¡Œ ${GREEN}./genymotion/genymotion${RESET}
	EOF
}
#####################
qemu_main "$@"
