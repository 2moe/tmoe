#!/usr/bin/env bash
#######################
tmoe_qemu_main() {
    case "$1" in
    -m | * | -x64qemu)
        check_qemu_installation
        tmoe_qemu_main_menu
        ;;
    esac
}
#############################
tmoe_qemu_main_menu() {
    RETURN_TO_WHERE='tmoe_qemu_main_menu'
    RETURN_TO_MENU='tmoe_qemu_main_menu'
    QEMU_DIR="${TMOE_LINUX_DIR}/qemu/list"
    [[ -e ${QEMU_DIR} ]] || mkdir -pv ${QEMU_DIR}
    cd ${QEMU_DIR}
    let i=02
    for CLIST in $(ls .); do
        if [[ -s ${CLIST} && ! -d ${CLIST} ]]; then
            printf "%s %s " "${CLIST}" "$((i++))" >>${TMPDIR}/.tmoe-linux_cache.01
        fi
    done
    #%såæœ‰ç©ºæ ¼
    TMOE_VIRTUALIZATION=$(
        whiptail --title "qemu-system vm" --menu "qemu-system virtual machine" 0 50 0 \
            "ğŸ¹ create a new VM æ–°å»ºè™šæ‹Ÿæœº" "1" \
            $(sed -n p ${TMPDIR}/.tmoe-linux_cache.01 2>/dev/null) \
            "Back" "ğŸŒš è¿”å›" \
            3>&1 1>&2 2>&3
    )
    rm -f ${TMPDIR}/.tmoe-linux_cache.01 2>/dev/null
    #"10" "ğŸ–± Input devicesè¾“å…¥è®¾å¤‡" \
    #"ğŸ­ Upgrade å‡çº§qemu bin" "2" \	*å‡çº§qemu*) upgrade_qemu_bin ;;
    ##############ğŸ§º
    case ${TMOE_VIRTUALIZATION} in
    Back | "") install_container_and_virtual_machine ;;
    *æ–°å»ºè™šæ‹Ÿæœº) create_a_new_tmoe_qemu_vm ;;
    *)
        #echo $TMOE_VIRTUALIZATION
        QEMU_VM_NAME="${TMOE_VIRTUALIZATION}"
        QEMU_FILE="${QEMU_DIR}/${QEMU_VM_NAME}"
        start_tmoe_qemu_manager
        ;;
    esac
    ###############
    press_enter_to_return
    #${RETURN_TO_WHERE}
    tmoe_qemu_main_menu
}
start_tmoe_qemu_manager() {
    RETURN_TO_WHERE='start_tmoe_qemu_manager'
    RETURN_TO_MENU='start_tmoe_qemu_manager'
    TMOE_VIRTUALIZATION=$(
        whiptail --title "è¾“startqemuå¯åŠ¨${QEMU_VM_NAME}" --menu "${QEMU_VM_NAME} virtual machine tmoe manager.\næœ¬å·¥å…·ä»…æ”¯æŒqemu5.x/6.x" 0 50 0 \
            "1" "ğŸ¹ Start å¯åŠ¨${QEMU_VM_NAME}" \
            "2" "ğŸ¥— Edit config ç¼–è¾‘é…ç½®" \
            "3" "ğŸ’¾ Disk managerç£ç›˜ç®¡ç†å™¨" \
            "4" "ğŸ“º Display & audioæ˜¾ç¤ºä¸éŸ³é¢‘" \
            "5" "ğŸ­ CPU & RAM ä¸­å¤®å¤„ç†å™¨ä¸å†…å­˜ç®¡ç†" \
            "6" "ğŸ¥… Network ç½‘ç»œè®¾å®š" \
            "7" "ğŸ˜‹ Extra optionsé¢å¤–é€‰é¡¹" \
            "8" "del conf åˆ é™¤${QEMU_VM_NAME}é…ç½®" \
            "0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
            3>&1 1>&2 2>&3
    )
    #"10" "ğŸ–± Input devicesè¾“å…¥è®¾å¤‡" \
    #"3" "ğŸ± Multi-VMå¤šè™šæ‹Ÿæœºç®¡ç†" \
    #"11" "ğŸ”Œ uefi/legacy bios(å¼€æœºå¼•å¯¼å›ºä»¶)" \
    #"8" "ğŸ”Œ Del åˆ é™¤" \
    ##############ğŸ§º
    case ${TMOE_VIRTUALIZATION} in
    0 | "") tmoe_qemu_main_menu ;;
    1) start_qemu_vm ;;
    2) edit_qemu_script ;;
    3) tmoe_qemu_disk_manager ;;
    4) tmoe_qemu_display_settings ;;
    5) tmoe_qemu_x64_cpu_manager ;;
    6) modify_tmoe_qemu_network_settings ;;
    7) modify_tmoe_qemu_extra_options ;;
    8) delete_current_qemu_vm_conf ;;
    esac
    ###############
    press_enter_to_return
    ${RETURN_TO_WHERE}
}
##############
start_qemu_vm() {
    bash ${QEMU_FILE}
}
edit_qemu_script() {
    if [ $(command -v editor) ]; then
        editor ${QEMU_FILE}
    else
        nano ${QEMU_FILE}
    fi
}
##############
#æ–°å»º---é€‰æ‹©virtio/sata----é€‰æ‹©ç£ç›˜-----æ¶æ„---UEFI/BIOS---è®¿é—®æ–¹å¼---è½¬å‘ç«¯å£
create_a_new_tmoe_qemu_vm() {
    save_current_qemu_conf_as_a_new_script
    choose_qemu_qcow2_disk_type
    RETURN_TO_WHERE='choose_qemu_qcow2_or_img_file'
    FILE_EXT_01='qcow2'
    FILE_EXT_02='*'
    if (whiptail --title "é€‰æ‹©æˆ–æ–°å»ºè™šæ‹Ÿç£ç›˜" --yes-button 'chooseé€‰æ‹©' --no-button 'creatæ–°å»º' --yesno "Choose a qcow2 file or create a new disk?\nè‹¥æ‚¨æ— è™šæ‹Ÿç£ç›˜ï¼Œé‚£å°±æ–°å»ºä¸€ä¸ªå§" 8 50); then
        choose_qemu_qcow2_or_img_file
    else
        create_blank_virtual_disk_image
    fi
    press_enter_to_continue
    SELECTION=""
    RETURN_TO_WHERE='choose_your_qemu_arch'
    if (whiptail --title "æ˜¯å¦éœ€è¦é€‰æ‹©å¯åŠ¨å…‰ç›˜" --yes-button 'yes' --no-button 'skipè·³è¿‡' --yesno "Do you want to choose a iso?\nå¯åŠ¨å…‰ç›˜ç”¨äºå®‰è£…ç³»ç»Ÿ,è‹¥æ‚¨æ— æ­¤æ–‡ä»¶,åˆ™è¯·å…ˆä¸‹è½½iso;\nè‹¥ç£ç›˜å†…å·²å®‰è£…äº†ç³»ç»Ÿ,åˆ™å¯è·³è¿‡æ­¤é€‰é¡¹ã€‚" 10 50); then
        BLK_DEVICE='CD_ROM_DISK_01'
        FILE_EXT_01='iso'
        FILE_EXT_02='ISO'
        choose_qemu_qcow2_or_img_file
        press_enter_to_continue
    fi
    choose_your_qemu_arch
    choose_qemu_machine_type
    choose_uefi_or_bios
    RETURN_TO_WHERE='do_you_want_to_enable_tcp_port_fwd'
    choose_qemu_connection_type
    do_you_want_to_enable_tcp_port_fwd
    do_you_want_to_link_this_script
    printf "%s\n" "å¤„äº${BLUE}é»˜è®¤é…ç½®${RESET}ä¸‹çš„è™šæ‹Ÿæœºçš„å¯åŠ¨å‘½ä»¤å§‹ç»ˆä¸º${GREEN}startqemu${RESET}"
    printf "%s\n" "æ˜¯å¦éœ€è¦å¯åŠ¨è™šæ‹Ÿæœºï¼Ÿ"
    printf "%s\n" "æ‚¨ä¹‹åå¯ä»¥è¾“${GREEN}startqemu${RESET}æ¥å¯åŠ¨"
    printf "%s\n" "You can type ${GREEN}startqemu${RESET} to start the default qemu vm."
    printf "%s\n" "Do you want to start it now?${PURPLE}[Y/n]${RESET}"
    RETURN_TO_WHERE='start_tmoe_qemu_manager'
    do_you_want_to_continue
    bash ${QEMU_FILE}
}
##########################
do_you_want_to_enable_tcp_port_fwd() {
    if (whiptail --title "TCP PORT FORWORD" --yes-button 'yes' --no-button 'no' --yesno "Do you want to enable the tcp port fwd function?\næ˜¯å¦éœ€è¦å¼€å¯tcpç«¯å£è½¬å‘åŠŸèƒ½?é»˜è®¤å°†guestçš„22ç«¯å£è½¬å‘è‡³hostçš„2888,å°†39080è½¬å‘è‡³39081\næ‚¨å¯ä»¥åœ¨networké…ç½®é€‰é¡¹ä¸­æ‰‹åŠ¨ä¿®æ”¹è½¬å‘è§„åˆ™ã€‚" 12 50); then
        TCP_PORT_HOST_FWD_01_ENABLED=true
    else
        TCP_PORT_HOST_FWD_01_ENABLED=false
    fi
    sed -E -i "s@^(TCP_PORT_HOST_FWD_01_ENABLED=).*@\1${TCP_PORT_HOST_FWD_01_ENABLED}@g" ${QEMU_FILE}
    grep --color=auto "^TCP_PORT_HOST_FWD_01_ENABLED=" ${QEMU_FILE}
}
###########################
choose_your_qemu_arch() {
    CURRENT_VALUE=$(grep '^QEMU_BIN_ARCH=' ${QEMU_FILE} | head -n 1 | cut -d '=' -f 2)
    if (whiptail --title "è¯·é€‰æ‹©qemuè™šæ‹Ÿæœºæ¶æ„" --yes-button 'x86_64' --no-button 'i386' --yesno "If your guest is 64bit,then choose x86_64\nè‹¥æ‚¨éœ€è¦è¿è¡Œx64ç³»ç»Ÿ,åˆ™è¯·é€‰æ‹©x86_64;\nè‹¥éœ€è¿è¡Œ32ä½x86 OS,åˆ™è¯·é€‰æ‹©i386.å½“å‰ä¸º${CURRENT_VALUE}" 10 50); then
        QEMU_BIN_ARCH='x86_64'
    else
        QEMU_BIN_ARCH='i386'
    fi
    sed -E -i "s@^(QEMU_BIN_ARCH=).*@\1${QEMU_BIN_ARCH}@g" ${QEMU_FILE}
    grep --color=auto "^QEMU_BIN_ARCH=" ${QEMU_FILE}
}
choose_qemu_machine_type() {
    CURRENT_VALUE=$(grep '^MACHINE_TYPE=' ${QEMU_FILE} | head -n 1 | cut -d '=' -f 2)
    if (whiptail --title "è¯·é€‰æ‹©qemuæœºå™¨ç±»å‹" --yes-button 'i440fx(1996)' --no-button 'q35(2009)' --yesno "If you are using arch/debian-sid/win8.1/win10,then choose q35.\nè‹¥æ‚¨ä½¿ç”¨çš„æ˜¯æ—§ç³»ç»Ÿ,åˆ™é€‰æ‹©pc-i440fx;å¦åˆ™è¯·é€‰æ‹©q35.å½“å‰ä¸º${CURRENT_VALUE}" 10 50); then
        MACHINE_TYPE='pc'
    else
        MACHINE_TYPE='q35'
    fi
    sed -E -i "s@^(MACHINE_TYPE=).*@\1${MACHINE_TYPE}@g" ${QEMU_FILE}
    grep --color=auto "^MACHINE_TYPE=" ${QEMU_FILE}
}
choose_uefi_or_bios() {
    if (whiptail --title "è¯·é€‰æ‹©å¼•å¯¼ç±»å‹" --yes-button 'legacy bios' --no-button 'uefi' --yesno "If your guest is win95/winxp,then choose legacy bios.\né»˜è®¤ä¸ºlegacy bios,è‹¥æ‚¨çš„è™šæ‹Ÿæœºéè€æ—§ç³»ç»Ÿ,\nä¾‹å¦‚debian sidæˆ–win10,åˆ™å¯é€‰æ‹©uefi\nè‹¥TianoCore UEFIæ— æ³•å¼•å¯¼ç³»ç»Ÿ,åˆ™è¯·åˆ‡æ¢å›bios\nè‹¥ä½ ä½¿ç”¨çš„æ˜¯æœªåŒ…å«efiå¼•å¯¼çš„é•œåƒ,åˆ™è¯·ä½¿ç”¨legacy" 14 50); then
        UEFI_ENABLED=false
    else
        UEFI_ENABLED=true
    fi
    sed -E -i "s@^(UEFI_ENABLED=).*@\1${UEFI_ENABLED}@g" ${QEMU_FILE}
    grep --color=auto "^UEFI_ENABLED=" ${QEMU_FILE}
}
choose_qemu_connection_type() {
    #æ­¤å¤„ä¸åŒ…å«RETURN_TO_WHEREå˜é‡
    unset CONNECTION_TYPE
    TMOE_OPTION=$(whiptail --title "è¯·é€‰æ‹©è¿æ¥ç±»å‹" --menu "The default connection type is VNC.\né€šè¿‡è¿œç¨‹æˆ–æœ¬åœ°æ¡Œé¢æ¥æ˜¾ç¤ºqemuçš„ç•Œé¢" 0 50 0 \
        "1" "vnc" \
        "2" "x11/wayland(æœ¬åœ°æ˜¾ç¤ºGUI)" \
        "3" "remote-x11(è¿œç¨‹x11,è½¬å‘x)" \
        "4" "spice" \
        "0" "ğŸŒš back è¿”å›" \
        3>&1 1>&2 2>&3)
    ##############ğŸ§º
    case ${TMOE_OPTION} in
    "" | 0) ${RETURN_TO_WHERE} ;;
    1)
        CONNECTION_TYPE='vnc'
        tmoe_qemu_vnc_menu
        ;;
    2) CONNECTION_TYPE='x11' ;;
    3)
        CONNECTION_TYPE='remote-x11'
        choose_qemu_x11_addr
        ;;
    4)
        CONNECTION_TYPE='spice'
        choose_qemu_vnc_port
        ;;
    esac
    ###############
    case ${CONNECTION_TYPE} in
    "") ;;
    *)
        sed -E -i "s@^(CONNECTION_TYPE=).*@\1${CONNECTION_TYPE}@g" ${QEMU_FILE}
        grep --color=auto "^CONNECTION_TYPE=" ${QEMU_FILE}
        ;;
    esac
}
##################
tmoe_qemu_vnc_menu() {
    TMOE_OPTION=$(whiptail --title "CONFIGURE VNC" --menu "You can modify the VNC configuration here" 0 50 0 \
        "1" "portç«¯å£" \
        "2" "localhost/LAN(æœ¬æœº/å±€åŸŸç½‘è®¿é—®)" \
        "0" "ğŸŒš back è¿”å›" \
        3>&1 1>&2 2>&3)
    ##############ğŸ§º
    case ${TMOE_OPTION} in
    "" | 0) choose_qemu_connection_type ;;
    1) choose_qemu_vnc_port ;;
    2) tmoe_qemu_vnc_localhost ;;
    esac
}
###################
tmoe_qemu_vnc_localhost() {
    CURRENT_VALUE=$(grep '^VNC_LOCALHOST=' ${QEMU_FILE} | head -n 1 | cut -d '=' -f 2)
    if (whiptail --title "localhost vnc" --yes-button 'true' --no-button 'false' --yesno "æ˜¯å¦ä»…å…è®¸æœ¬æœºè®¿é—®?é»˜è®¤ä¸ºtrue,å½“å‰ä¸º${CURRENT_VALUE}\nDo you only allow localhost to access vnc?" 9 50); then
        VNC_LOCALHOST=true
    else
        VNC_LOCALHOST=false
    fi
    sed -E -i "s@^(VNC_LOCALHOST=).*@\1${VNC_LOCALHOST}@g" ${QEMU_FILE}
    grep --color=auto "^VNC_LOCALHOST=" ${QEMU_FILE}
}
###################
choose_qemu_x11_addr() {
    unset REMOTE_X11_ADDR
    CURRENT_IP=$(ip -4 -br a | awk '{print $NF}' | grep '192\.168\.' | cut -d '/' -f 1 | head -n 1)
    [[ -n ${CURRENT_IP} ]] || CURRENT_IP=$(ip -4 -br -c a | awk '{print $NF}' | grep -v '127\.0\.0\.1' | grep '172\.' | cut -d '/' -f 1 | head -n 1)
    [[ -n ${CURRENT_IP} ]] || CURRENT_IP="192.168.1.2"
    TMOE_OPTION=$(whiptail --title "è¯·é€‰æ‹©x11è½¬å‘åœ°å€" --menu "The default addr is 127.0.0.1:0" 0 50 0 \
        "1" "127.0.0.1:0" \
        "2" "127.0.0.1:1" \
        "3" "${CURRENT_IP}:0" \
        "4" "customize è‡ªå®šä¹‰" \
        "0" "ğŸŒš back è¿”å›" \
        3>&1 1>&2 2>&3)
    ##############ğŸ§º
    case ${TMOE_OPTION} in
    "" | 0) choose_qemu_connection_type ;;
    1) REMOTE_X11_ADDR='127.0.0.1:0' ;;
    2) REMOTE_X11_ADDR='127.0.0.1:1' ;;
    3) REMOTE_X11_ADDR="${CURRENT_IP}:0" ;;
    4) type_the_remote_x11_addr ;;
    esac
    ###############
    case ${REMOTE_X11_ADDR} in
    "") ;;
    *)
        sed -E -i "s@^(REMOTE_X11_ADDR=).*@\1${REMOTE_X11_ADDR}@g" ${QEMU_FILE}
        grep --color=auto "^REMOTE_X11_ADDR=" ${QEMU_FILE}
        ;;
    esac
}
#################
type_the_remote_x11_addr() {
    REMOTE_X11_ADDR=$(whiptail --inputbox "è¯·è¾“å…¥è½¬å‘åœ°å€,é»˜è®¤ä¸º127.0.0.1:0\nPlease type the addr." 9 50 --title "ADDR" 3>&1 1>&2 2>&3)
    if [ "$?" != "0" ]; then
        #${RETURN_TO_WHERE}
        choose_qemu_x11_addr
    elif [[ ! ${REMOTE_X11_ADDR} =~ ^([0-9]{1,2}|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\.([0-9]{1,2}|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\.([0-9]{1,2}|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\.([0-9]{1,2}|1[0-9][0-9]|2[0-4][0-9]|25[0-5]):[0-9]{1,5}$ ]]; then
        printf "${PURPLE}%s${RESET}\n" "${REMOTE_X11_ADDR}"
        printf "%s\n" "æ‚¨è¾“å…¥çš„åœ°å€æ— æ•ˆ,è¯·é‡æ–°è¾“å…¥"
        printf "%s\n" "Please re-enter."
        press_enter_to_return
        type_the_remote_x11_addr
    elif [ -z "${REMOTE_X11_ADDR}" ]; then
        printf "%s\n" "The addr is empty."
        printf "%s\n" "åœ°å€ä¸ºç©ºï¼Œå°†è‡ªåŠ¨åˆ‡æ¢è‡³${GREEN}127.0.0.1:0${RESET}"
        REMOTE_X11_ADDR='127.0.0.1:0'
    fi
}
#################
choose_qemu_vnc_port() {
    CURRENT_VNC_PORT=$(grep "^VNC_PORT=" ${QEMU_FILE} | cut -d '=' -f 2)
    unset VNC_PORT
    TMOE_OPTION=$(whiptail --title "è¯·é€‰æ‹©${CONNECTION_TYPE}ç«¯å£" --menu "The current ${CONNECTION_TYPE} port is ${CURRENT_VNC_PORT}.\né»˜è®¤ç«¯å£5905,å½“å‰ä¸º${CURRENT_VNC_PORT}" 0 50 0 \
        "1" "5900" \
        "2" "5901" \
        "3" "5902" \
        "4" "5903" \
        "5" "5904" \
        "6" "customize è‡ªå®šä¹‰" \
        "0" "ğŸŒš back è¿”å›" \
        3>&1 1>&2 2>&3)
    ##############ğŸ§º
    case ${TMOE_OPTION} in
    "" | 0) choose_qemu_connection_type ;;
    [1-5]) VNC_PORT=$((5899 + ${TMOE_OPTION})) ;;
    6) type_the_vnc_port_target ;;
    esac
    ###############
    case ${VNC_PORT} in
    "") ;;
    *)
        sed -E -i "s@^(VNC_PORT=).*@\1${VNC_PORT}@g" ${QEMU_FILE}
        grep --color=auto "^VNC_PORT=" ${QEMU_FILE}
        ;;
    esac
}
#################
type_the_vnc_port_target() {
    VNC_PORT=$(whiptail --inputbox "è¯·è¾“å…¥ç«¯å£å·(çº¯æ•°å­—),é»˜è®¤ä¸º5905\nPlease type the port" 9 50 --title "PORT" 3>&1 1>&2 2>&3)
    if [ "$?" != "0" ]; then
        #${RETURN_TO_WHERE}
        choose_qemu_vnc_port
    elif [[ ! ${VNC_PORT} =~ ^[0-9]+$ ]]; then
        printf "%s\n" "ç«¯å£å·ä»…åŒ…å«æ•°å­—,è¯·å‹¿è¾“å…¥ç‰¹æ®Šå­—ç¬¦ã€‚"
        printf "%s\n" "Please re-enter."
        press_enter_to_return
        type_the_vnc_port_target
    elif [ -z "${VNC_PORT}" ]; then
        printf "%s\n" "The vnc port is empty."
        printf "%s\n" "ç«¯å£ä¸ºç©ºï¼Œå°†è‡ªåŠ¨åˆ‡æ¢è‡³${GREEN}5905${RESET}ç«¯å£"
        VNC_PORT='5905'
    fi
}
do_you_want_to_link_this_script() {
    [[ ! -e $(command -v startqemu) ]] || rm -fv $(command -v startqemu)
    ln -svf ${QEMU_FILE} /usr/local/bin/startqemu
    if (whiptail --title "Do you want to link this script to your HOME dir" --yes-button 'yes' --no-button 'no' --yesno "æ˜¯å¦éœ€è¦åœ¨${HOME}ç›®å½•ä¸‹ç”Ÿæˆå¯åŠ¨è„šæœ¬(è½¯é“¾æ¥),è‹¥é€‰yes,åˆ™å¯é€šè¿‡~/${QEMU_VM_NAME}æ¥å¯åŠ¨è™šæ‹Ÿæœº" 9 50); then
        ln -svf ${QEMU_FILE} ${HOME}
        printf "%s\n" "æ‚¨å¯ä»¥è¾“${GREEN}~/${QEMU_VM_NAME}${RESET}æ¥å¯åŠ¨å½“å‰è™šæ‹Ÿæœºã€‚"
        printf "%s\n" "You can type ${GREEN}~/${QEMU_VM_NAME}${RESET} to start current qemu vm."
    fi
}
#########################
save_current_qemu_conf_as_a_new_script() {
    QEMU_VM_NAME=$(whiptail --inputbox "è¯·è¾“å…¥è™šæ‹Ÿæœºåç§°,ä¸å«ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦,\nè‹¥ç•™ç©ºåˆ™å°†è‡ªåŠ¨å‘½åä¸ºgnu-linux_x64-$(date +%Y-%m-%d_%H-%M)ã€‚Please type the VM name." 10 50 --title "VM NAME" 3>&1 1>&2 2>&3)
    if [ "$?" != "0" ]; then
        ${RETURN_TO_MENU}
    elif [ -z "${QEMU_VM_NAME}" ]; then
        QEMU_VM_NAME="gnu-linux_x64-$(date +%Y-%m-%d_%H-%M)"
        printf "%s\n" "Your qemu vm name is empty."
        printf "%s\n" "åç§°ä¸ºç©ºï¼Œå°†è‡ªåŠ¨ç”Ÿæˆè™šæ‹Ÿæœºåç§°:${GREEN}${QEMU_VM_NAME}${RESET}"
    elif [[ -e ${QEMU_DIR}/${QEMU_VM_NAME} ]]; then
        printf "%s\n" "æ–‡ä»¶å·²è¢«å ç”¨ï¼Œè¯·é‡æ–°è¾“å…¥"
        printf "%s\n" "Please re-enter."
        press_enter_to_return
        save_current_qemu_conf_as_a_new_script
    elif [[ ! ${QEMU_VM_NAME} =~ ^[0-9A-Za-z_-]+$ ]]; then
        printf "%s\n" "è™šæ‹Ÿæœºåç§°ä»…åŒ…å«è‹±æ–‡ã€æ•°å­—å’Œ_-,è¯·å‹¿è¾“å…¥ç‰¹æ®Šå­—ç¬¦ã€‚"
        printf "%s\n" "Please re-enter."
        press_enter_to_return
        save_current_qemu_conf_as_a_new_script
    fi
    QEMU_FILE="${QEMU_DIR}/${QEMU_VM_NAME}"
    cp -vf ${TMOE_TOOL_DIR}/virtualization/qemu/startqemu ${QEMU_FILE}
    chmod -v 777 ${QEMU_FILE}
    sed -E -i "s@^(QEMU_NAME=).*@\1${QEMU_VM_NAME}@g" ${QEMU_FILE}
    grep --color=auto "^QEMU_NAME=" ${QEMU_FILE}
}
################
fix_qemu_vdisk_file_perssions() {
    if [ ${HOME} != '/root' ]; then
        printf "%s\n" "æ­£åœ¨å°†${TMOE_FILE_ABSOLUTE_PATH%/*}çš„æ–‡ä»¶æƒé™ä¿®æ”¹ä¸º${CURRENT_USER_NAME}ç”¨æˆ·å’Œ${CURRENT_USER_GROUP}ç”¨æˆ·ç»„"
        #chown -v ${CURRENT_USER_NAME}:${CURRENT_USER_GROUP} ${TARGET_FILE_NAME}
        chown -Rv ${CURRENT_USER_NAME}:${CURRENT_USER_GROUP} "${TMOE_FILE_ABSOLUTE_PATH%/*}"
    fi
}
choose_qemu_qcow2_disk_type() {
    if (whiptail --title "è¯·é€‰æ‹©ç£ç›˜è®¾å¤‡ç±»å‹" --yes-button 'sata' --no-button 'virtio-blk' --yesno "If your guest is linux,then choose virtio.\nè‹¥è™šæ‹Ÿæœºç³»ç»Ÿæœªå®‰è£…virtioé©±åŠ¨,åˆ™è¯·é€‰æ‹©sata" 9 50); then
        BLK_DEVICE="SATA_DISK_01"
    else
        BLK_DEVICE="VIRTIO_DISK_01"
    fi
}
################
create_blank_virtual_disk_image() {
    [[ -n ${QEMU_VM_NAME} ]] || QEMU_VM_NAME="gnu-linux_x64-$(date +%Y-%m-%d_%H-%M)"
    DISK_FILE_PATH="${HOME}/sd/Download/qemu"
    TARGET_FILE_NAME=$(whiptail --inputbox "è¯·è¾“å…¥ç£ç›˜æ–‡ä»¶åç§°,è‹¥ç•™ç©º,åˆ™å°†è‡ªåŠ¨åˆ›å»º${QEMU_VM_NAME}\nPlease type the filename." 10 50 --title "FILENAME" 3>&1 1>&2 2>&3)
    if [ "$?" != "0" ]; then
        ${RETURN_TO_WHERE}
    elif [ -z "${TARGET_FILE_NAME}" ]; then
        TARGET_FILE_NAME="${QEMU_VM_NAME}.qcow2"
        if [[ -e ${DISK_FILE_PATH}/${QEMU_VM_NAME} ]]; then
            printf "%s\n" "æ–‡ä»¶å·²å­˜åœ¨ï¼Œæ–°æ–‡ä»¶å°†è¢«é‡å‘½åä¸º${QEMU_VM_NAME}_02"
            press_enter_to_continue
            TARGET_FILE_NAME="${QEMU_VM_NAME}_02.qcow2"
        fi
    elif [[ ! ${TARGET_FILE_NAME} =~ ^[0-9A-Za-z_-]+$ ]]; then
        printf "%s\n" "ç£ç›˜åç§°ä»…åŒ…å«è‹±æ–‡ã€æ•°å­—å’Œ_-,è¯·å‹¿è¾“å…¥ç‰¹æ®Šå­—ç¬¦ã€‚"
        printf "%s\n" "Please re-enter."
        press_enter_to_return
        create_blank_virtual_disk_image
    elif [[ -e ${DISK_FILE_PATH}/${TARGET_FILE_NAME} ]]; then
        printf "%s\n" "æ–‡ä»¶å·²å­˜åœ¨ï¼Œæ–°æ–‡ä»¶å°†è¢«é‡å‘½åä¸º${TARGET_FILE_NAME}_02"
        press_enter_to_continue
        TARGET_FILE_NAME="${TARGET_FILE_NAME}_02.qcow2"
    else
        TARGET_FILE_NAME="${TARGET_FILE_NAME}.qcow2"
    fi
    [[ -e ${DISK_FILE_PATH} ]] || mkdir -pv ${DISK_FILE_PATH}
    cd ${DISK_FILE_PATH}
    TMOE_FILE_ABSOLUTE_PATH="${DISK_FILE_PATH}/${TARGET_FILE_NAME}"
    TARGET_FILE_SIZE=$(whiptail --inputbox "è¯·è®¾å®šç£ç›˜ç©ºé—´å¤§å°,ä¾‹å¦‚512M,16G,128Gæˆ–1T\nè‹¥ç•™ç©ºåˆ™å°†è‡ªåŠ¨åˆ›å»º16Gçš„ç£ç›˜,Please type the disk size." 10 50 --title "SIZE" 3>&1 1>&2 2>&3)
    if [ "$?" != "0" ]; then
        qemu-img create -f qcow2 ${TARGET_FILE_NAME} 16G
    elif [ -z "${TARGET_FILE_SIZE}" ]; then
        printf "%s\n" "The default disk size is 16G."
        printf "%s\n" "æ‚¨æœªè¾“å…¥ç£ç›˜ç©ºé—´å¤§å°ï¼Œå°†ä¸ºæ‚¨è‡ªåŠ¨åˆ›å»º16Gå¤§å°çš„qcow2ç£ç›˜"
        do_you_want_to_continue
        #qemu-img create -f qcow2 -o preallocation=metadata ${TARGET_FILE_NAME} 16G
        qemu-img create -f qcow2 ${TARGET_FILE_NAME} 16G
    else
        qemu-img create -f qcow2 ${TARGET_FILE_NAME} ${TARGET_FILE_SIZE}
    fi
    fix_qemu_vdisk_file_perssions
    stat ${TARGET_FILE_NAME}
    qemu-img info ${TARGET_FILE_NAME}
    ls -lh ${DISK_FILE_PATH}/${TARGET_FILE_NAME}
    #printf "%s\n" "æ˜¯å¦éœ€è¦å°†å…¶è®¾ç½®ä¸ºé»˜è®¤ç£ç›˜ï¼Ÿ"
    #printf "%s\n" "Do you need to set it as the default disk?"
    #do_you_want_to_continue
    sed -E -i "s@^(${BLK_DEVICE}=).*@\1"${TMOE_FILE_ABSOLUTE_PATH}"@g;s@^(${BLK_DEVICE}_ENABLED=).*@\1true@g" ${QEMU_FILE}
    grep -E --color=auto "^${BLK_DEVICE}_ENABLED=|^${BLK_DEVICE}_FORMAT=|^${BLK_DEVICE}=" ${QEMU_FILE}
}
################
choose_qemu_qcow2_or_img_file() {
    if grep -q "^${BLK_DEVICE}_ENABLED=.*true" ${QEMU_FILE}; then
        CURRENT_QEMU_ISO=$(grep "^${BLK_DEVICE}=" ${QEMU_FILE} | head -n 1 | awk -F '=' '{print $2}')
        IMPORTANT_TIPS="æ‚¨å½“å‰å·²åŠ è½½çš„è™šæ‹Ÿç£ç›˜ä¸º${CURRENT_QEMU_ISO}"
    else
        IMPORTANT_TIPS="ç£ç›˜æ–‡ä»¶è·¯å¾„è¯·ä¸è¦åŒ…å«ç©ºæ ¼,æ‚¨å½“å‰æœªåŠ è½½è™šæ‹Ÿç£ç›˜"
    fi
    where_is_tmoe_file_dir

    if [ -z ${SELECTION} ]; then
        printf "%s\n" "æ²¡æœ‰æŒ‡å®š${YELLOW}æœ‰æ•ˆ${RESET}çš„${BLUE}æ–‡ä»¶${GREEN}ï¼Œè¯·${GREEN}é‡æ–°${RESET}é€‰æ‹©"
    else
        printf "%s\n" "æ‚¨é€‰æ‹©çš„æ–‡ä»¶ä¸º${TMOE_FILE_ABSOLUTE_PATH}"
        qemu-img info "${TMOE_FILE_ABSOLUTE_PATH}"
        qemu-img check "${TMOE_FILE_ABSOLUTE_PATH}"
        ls -lah "${TMOE_FILE_ABSOLUTE_PATH}"
        sed -E -i "s@^(${BLK_DEVICE}=).*@\1"${TMOE_FILE_ABSOLUTE_PATH}"@g;s@^(${BLK_DEVICE}_ENABLED=).*@\1true@g" ${QEMU_FILE}
        QEMU_DISK_FOEMAT=$(qemu-img info "${TMOE_FILE_ABSOLUTE_PATH}" 2>&1 | grep format | head -n 1 | awk '{print $NF}')
        [[ -z ${QEMU_DISK_FOEMAT} ]] || sed -E -i "s@^(${BLK_DEVICE}_FORMAT=).*@\1${QEMU_DISK_FOEMAT}@g" ${QEMU_FILE}
        grep -E --color=auto "^${BLK_DEVICE}_ENABLED=|^${BLK_DEVICE}_FORMAT=|^${BLK_DEVICE}=" ${QEMU_FILE}
    fi
}
##########
tmoe_qemu_disk_manager() {
    RETURN_TO_WHERE='tmoe_qemu_disk_manager'
    RETURN_TO_MENU='tmoe_qemu_disk_manager'
    #15 50 7
    FILE_EXT_01='qcow2'
    FILE_EXT_02='*'
    TMOE_VIRTUALIZATION=$(
        whiptail --title "DISK MANAGER" --menu "æ‚¨æƒ³è¦é€‰æ‹©å“ªå—ç£ç›˜å‘¢?" 0 0 0 \
            "1" "sata-01(ç¬¬ä¸€å—sataç£ç›˜)" \
            "2" "cd-01(ç¬¬ä¸€å¼ å…‰ç›˜)" \
            "3" "virtio driver(é©±åŠ¨ç›˜)" \
            "4" "virtio-01(ç¬¬ä¸€å—virtioç£ç›˜)" \
            "5" "usb-01(ç¬¬ä¸€å—usbç§»åŠ¨ç¡¬ç›˜)" \
            "6" "floppy-01(ç¬¬ä¸€å¼ è½¯ç›˜)" \
            "7" "virtio-9p(å…±äº«æ–‡ä»¶å¤¹)" \
            "8" "sata-02" \
            "9" "cd-02" \
            "10" "virtio-02" \
            "11" "usb-02" \
            "12" "floppy-02" \
            "0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
            3>&1 1>&2 2>&3
    )
    #############
    #"12" "virtio-fs(å…±äº«æ–‡ä»¶å¤¹)" \
    case ${TMOE_VIRTUALIZATION} in
    0 | "") start_tmoe_qemu_manager ;;
    1) BLK_DEVICE='SATA_DISK_01' ;;
    2) BLK_DEVICE='CD_ROM_DISK_01' ;;
    3) BLK_DEVICE='CD_ROM_DISK_02' ;;
    4) BLK_DEVICE='VIRTIO_DISK_01' ;;
    5) BLK_DEVICE='USB_DISK_01' ;;
    6) BLK_DEVICE='FLOPPY_DISK_01' ;;
    7) BLK_DEVICE='VIRTIO_9P_PCI_01' ;;
    8) BLK_DEVICE='SATA_DISK_02' ;;
    9) BLK_DEVICE='CD_ROM_DISK_02' ;;
    10) BLK_DEVICE='VIRTIO_DISK_02' ;;
    11) BLK_DEVICE='USB_DISK_02' ;;
    12) BLK_DEVICE='FLOPPY_DISK_02' ;;
    esac
    ###########
    case ${TMOE_VIRTUALIZATION} in
    3)
        FILE_EXT_01='ISO'
        FILE_EXT_02='iso'
        tmoe_qemu_disk_manager_05
        ;;
    2 | 9)
        FILE_EXT_01='ISO'
        FILE_EXT_02='iso'
        tmoe_qemu_disk_manager_03
        ;;
    6 | 12)
        FILE_EXT_01='fd'
        FILE_EXT_02='*'
        tmoe_qemu_disk_manager_02
        ;;
    7) tmoe_qemu_disk_manager_04 ;;
    *) tmoe_qemu_disk_manager_02 ;;
    esac
    press_enter_to_return
    tmoe_qemu_disk_manager
}
tmoe_qemu_disk_manager_02() {
    RETURN_TO_WHERE='tmoe_qemu_disk_manager_02'
    TMOE_VIRTUALIZATION=$(
        whiptail --title "${BLK_DEVICE} MANAGER" --menu "æ‚¨æƒ³è¦å¯¹${BLK_DEVICE}è¿›è¡Œä»€ä¹ˆæ“ä½œ" 0 0 0 \
            "1" "ğŸ’½ choose a file é€‰æ‹©ç£ç›˜æ–‡ä»¶" \
            "2" "create a new diskæ–°å»ºç©ºç™½ç£ç›˜" \
            "3" "disable ç¦ç”¨${BLK_DEVICE}" \
            "4" "compress å‹ç¼©(çœŸå®å¤§å°)" \
            "5" "expand æ‰©å®¹(æœ€å¤§ç©ºé—´)" \
            "6" "bootindex æŒ‡å®šå¼•å¯¼é¡ºåº" \
            "7" "format ä¿®æ”¹æ ¼å¼" \
            "8" "delete åˆ é™¤ç£ç›˜" \
            "0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
            3>&1 1>&2 2>&3
    )
    #############
    case ${TMOE_VIRTUALIZATION} in
    0 | "") ${RETURN_TO_MENU} ;;
    1) choose_qemu_qcow2_or_img_file ;;
    2) create_blank_virtual_disk_image ;;
    3) disable_qemu_disk ;;
    4) compress_qcow2_img_file ;;
    5) expand_qemu_qcow2_img_file ;;
    6) modify_qemu_disk_bootindex ;;
    7) modify_qemu_disk_format ;;
    8) delete_current_qemu_vm_disk_file ;;
    esac
    press_enter_to_return
    tmoe_qemu_disk_manager_02
}
tmoe_qemu_disk_manager_03() {
    RETURN_TO_WHERE='tmoe_qemu_disk_manager_03'
    TMOE_VIRTUALIZATION=$(
        whiptail --title "${BLK_DEVICE} MANAGER" --menu "æ‚¨æƒ³è¦å¯¹${BLK_DEVICE}è¿›è¡Œä»€ä¹ˆæ“ä½œ" 0 0 0 \
            "1" "ğŸ’½ choose a file é€‰æ‹©isoæ–‡ä»¶" \
            "2" "disable ç¦ç”¨${BLK_DEVICE}" \
            "3" "bootindex æŒ‡å®šå¼•å¯¼é¡ºåº" \
            "4" "delete iso åˆ é™¤å…‰ç›˜" \
            "0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
            3>&1 1>&2 2>&3
    )
    #############
    case ${TMOE_VIRTUALIZATION} in
    0 | "") ${RETURN_TO_MENU} ;;
    1) choose_qemu_qcow2_or_img_file ;;
    2) disable_qemu_disk ;;
    3) modify_qemu_disk_bootindex ;;
    4) delete_current_qemu_vm_disk_file ;;
    esac
    press_enter_to_return
    tmoe_qemu_disk_manager_03
}
tmoe_qemu_disk_manager_04() {
    RETURN_TO_WHERE='tmoe_qemu_disk_manager_04'
    TMOE_VIRTUALIZATION=$(
        whiptail --title "${BLK_DEVICE} MANAGER" --menu "æ‚¨æƒ³è¦å¯¹${BLK_DEVICE}è¿›è¡Œä»€ä¹ˆæ“ä½œ" 0 0 0 \
            "1" "shared dir ä¿®æ”¹å…±äº«æ–‡ä»¶å¤¹" \
            "2" "readme ä½¿ç”¨è¯´æ˜" \
            "3" "disable ç¦ç”¨${BLK_DEVICE}" \
            "0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
            3>&1 1>&2 2>&3
    )
    #############
    case ${TMOE_VIRTUALIZATION} in
    0 | "") ${RETURN_TO_MENU} ;;
    1) modify_qemu_shared_folder ;;
    2) readme_of_9p_file_system ;;
    3) disable_qemu_disk ;;
    esac
    press_enter_to_return
    tmoe_qemu_disk_manager_04
}
#######################
tmoe_qemu_disk_manager_05() {
    RETURN_TO_WHERE='tmoe_qemu_disk_manager_05'
    #15 60 6
    TMOE_VIRTUALIZATION=$(
        whiptail --title "VIRTIO-DRIVER-ISO" --menu "è‹¥æ‚¨çš„guestä¸ºwindows,ä¸”æœªå®‰è£…virtio & qxlé©±åŠ¨,åˆ™è¯·æŒ‚è½½virtioé©±åŠ¨ç›˜,å¹¶åœ¨guestå†…å®‰è£…é©±åŠ¨" 0 0 0 \
            "1" "Download driverä¸‹è½½å¹¶å¯ç”¨é©±åŠ¨ç›˜" \
            "2" "Choose a iso(cd-02) é€‰æ‹©é©±åŠ¨å…‰ç›˜" \
            "3" "Readme ä½¿ç”¨è¯´æ˜" \
            "0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
            3>&1 1>&2 2>&3
    )
    #############
    case ${TMOE_VIRTUALIZATION} in
    0 | "") ${RETURN_TO_MENU} ;;
    1) download_virtio_driver ;;
    2) choose_qemu_qcow2_or_img_file ;;
    3) printf '%s\n' 'è¯·å…ˆä»¥å¸¸è§„æŒ‚è½½æ–¹å¼(IDEæˆ–SATAç£ç›˜)è¿è¡Œè™šæ‹Ÿæœºç³»ç»Ÿï¼Œæ¥ç€åœ¨è™šæ‹Ÿæœºå†…å®‰è£…virtioé©±åŠ¨ï¼Œç„¶åé€€å‡ºè™šæ‹Ÿæœºï¼Œæœ€åç¦ç”¨IDEæˆ–SATAç£ç›˜ï¼Œå¹¶é€‰æ‹©virtioç£ç›˜ã€‚è‹¥æ‚¨ä½¿ç”¨äº†isoè¿›è¡Œå…¨æ–°å®‰è£…ï¼Œåˆ™å¯ä½¿ç”¨ä»¥ä¸‹æ–¹æ¡ˆã€‚VIRTIO_DISK_01ä¸ºç©ºç™½qcow2ç£ç›˜ï¼ŒCD_ROM_DISK_01ä¸ºwin10å…‰ç›˜é•œåƒï¼ŒCD_ROM_DISK_02ä¸ºvirtioé©±åŠ¨å…‰ç›˜ã€‚å¯åŠ¨è™šæ‹Ÿæœºåï¼Œåœ¨å®‰è£…å‰ï¼Œè¯·é€‰æ‹©virtioé©±åŠ¨ç›˜å†…amd64/i386ä¸‹çš„w10ç›®å½•ï¼Œæœ€åé€‰æ‹©win10çš„virtioç£ç›˜é©±åŠ¨ã€‚æ‚¨äº¦å¯ä¿®æ”¹BOOTINDEXå¼€æœºå¼•å¯¼é¡ºåº,å°†Virtioç£ç›˜-01çš„å¼•å¯¼é¡ºåºæ”¹ä¸º1ï¼Œå°†å…¶ä»–ç£ç›˜ä¿®æ”¹ä¸º2æˆ–3æˆ–4ã€‚' ;;
    esac
    press_enter_to_return
    ${RETURN_TO_WHERE}
}
##########
delete_current_qemu_vm_disk_file() {
    CURRENT_VALUE=$(grep "^${BLK_DEVICE}=" ${QEMU_FILE} | head -n 1 | cut -d '=' -f 2)
    stat ${CURRENT_VALUE}
    qemu-img info ${CURRENT_VALUE}
    printf "%s\n" "${RED}rm -fv ${BLUE}${CURRENT_VALUE}${RESET}"
    printf "%s\n" "Do you want to delete it?"
    printf "%s\n" "åˆ é™¤åå°†æ— æ³•æ’¤é”€ï¼Œè¯·è°¨æ…æ“ä½œ"
    do_you_want_to_continue
    rm -fv ${CURRENT_VALUE}
}
################
set_it_as_the_default_qemu_iso() {
    ls -lh ${TMOE_FILE_ABSOLUTE_PATH}
    sed -E -i "s@^(${BLK_DEVICE}=).*@\1"${TMOE_FILE_ABSOLUTE_PATH}"@g;s@^(${BLK_DEVICE}_ENABLED=).*@\1true@g" ${QEMU_FILE}
    grep -E --color=auto "^${BLK_DEVICE}_ENABLED=|^${BLK_DEVICE}=" ${QEMU_FILE}
}
download_virtio_driver() {
    DOWNLOAD_PATH="${HOME}/sd/Download/qemu"
    #15 50 4
    TMOE_VIRTUALIZATION=$(
        whiptail --title "VIRTIO DRIVER" --menu "${VIRTIO_STATUS}" 0 0 0 \
            "1" "virtio-win-latest.zst(æ¯æœˆ16å·æ›´æ–°)" \
            "2" "virtio-win-latest(fedoraå®˜ç½‘)" \
            "3" "readmeé©±åŠ¨è¯´æ˜" \
            "0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
            3>&1 1>&2 2>&3
    )
    #############
    case ${TMOE_VIRTUALIZATION} in
    0 | "") tmoe_qemu_disk_manager_05 ;;
    1)
        DOWNLOAD_FILE_NAME='virtio-win-latest.iso'
        THE_LATEST_ISO_LINK="https://cdn.tmoe.me/virtio"
        printf "%s\n" "Do you want to download the latest virtio-iso.tar.zst from azure?"
        do_you_want_to_continue
        mkdir -pv ${DOWNLOAD_PATH}
        cd ${DOWNLOAD_PATH}
        aria2c --console-log-level=error --no-conf --allow-overwrite=true -s 6 -x 6 -k 1M -d "${DOWNLOAD_PATH}" -o "${DOWNLOAD_FILE_NAME}.tar.zst" "${THE_LATEST_ISO_LINK}"
        printf "%s\n" "Extracting ${DOWNLOAD_FILE_NAME}.tar.zst, please wait."
        tar -I zstd -xvf ${DOWNLOAD_FILE_NAME}.tar.zst
        TMOE_FILE_ABSOLUTE_PATH="${DOWNLOAD_PATH}/${DOWNLOAD_FILE_NAME}"
        #check_virtio_driver_iso
        set_it_as_the_default_qemu_iso
        ;;
    2)
        THE_LATEST_ISO_LINK='https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/latest-virtio/virtio-win.iso'
        printf "%s\n" "${YELLOW}${THE_LATEST_ISO_LINK}${RESET}"
        DOWNLOAD_FILE_NAME='virtio-win-latest.iso'
        check_virtio_driver_iso
        set_it_as_the_default_qemu_iso
        ;;
    3)
        FEDORA_VIRTIO_URL='https://docs.fedoraproject.org/en-US/quick-docs/creating-windows-virtual-machines-using-virtio-drivers/index.html'
        printf "%s\n" "url: ${YELLOW}${FEDORA_VIRTIO_URL}${RESET}"
        su "${CURRENT_USER_NAME}" -c "xdg-open ${FEDORA_VIRTIO_URL}"
        printf "%s\n" "è¯·å°†cd-02å…‰ç›˜è®¾ç½®ä¸º${DOWNLOAD_PATH}ç›®å½•ä¸‹çš„virtio-win-latest.iso,è¿›å…¥winè™šæ‹Ÿæœºåï¼Œå†å®‰è£…virtioé©±åŠ¨ã€‚"
        #xdg-open 'https://docs.fedoraproject.org/en-US/quick-docs/creating-windows-virtual-machines-using-virtio-drivers/index.html' 2>/dev/null
        ;;
    esac
    press_enter_to_return
    download_virtio_driver
}
check_virtio_driver_iso() {
    TMOE_FILE_ABSOLUTE_PATH="${DOWNLOAD_PATH}/${DOWNLOAD_FILE_NAME}"
    if [ -f "${TMOE_FILE_ABSOLUTE_PATH}" ]; then
        if (whiptail --title "æ£€æµ‹åˆ°virtio.isoå·²ä¸‹è½½,è¯·é€‰æ‹©æ‚¨éœ€è¦æ‰§è¡Œçš„æ“ä½œï¼" --yes-button 'è®¾ä¸ºcd02-iso' --no-button 'é‡ä¸‹DL again' --yesno "Detected that the file has been downloaded.\nDo you want to set it as the default iso, or download it again?" 0 0); then
            do_you_want_to_continue
        else
            aria2c_download_virtio_iso
        fi
    else
        aria2c_download_virtio_iso
    fi
}
aria2c_download_virtio_iso() {
    [[ -e ${DOWNLOAD_PATH} ]] || mkdir -pv ${DOWNLOAD_PATH}
    printf "%s\n" "å³å°†ä¸ºæ‚¨ä¸‹è½½è‡³${DOWNLOAD_PATH}"
    aria2c --console-log-level=warn --no-conf --allow-overwrite=true -s 6 -x 6 -k 1M -d "${DOWNLOAD_PATH}" -o "${DOWNLOAD_FILE_NAME}" "${THE_LATEST_ISO_LINK}"
}
##############
readme_of_9p_file_system() {
    cat <<-'EOF'
		VIRTIO_9P_PCI_01çš„å‚æ•°å€¼ä¸ºå®¿ä¸»æœºçš„ç›®å½•ï¼Œé»˜è®¤ä¸º${HOME}/sdã€‚è‹¥æ‚¨çš„qemu-system host(å®¿ä¸»)è¿è¡Œåœ¨tmoe-linuxå®‰è£…çš„prootå®¹å™¨é‡Œï¼Œåˆ™å»ºè®®ä¿®æ”¹ä¸º"/storage/self/primary" ;è‹¥ä¸ºchroot,åˆ™å»ºè®®ä¿®æ”¹ä¸º"/media/sd" ;è‹¥ä¸ºdockeræˆ–nspawnå®¹å™¨,åˆ™å»ºè®®ä¿®æ”¹ä¸º"/media/docker"ã€‚
		æœ¬åŠŸèƒ½æš‚ä»…é€‚é…Linuxå‘è¡Œç‰ˆã€‚
		æ‚¨éœ€è¦åœ¨guestä¸­æŒ‚è½½9p file systemï¼Œæ‰èƒ½ä»¥æ­¤æ–¹å¼å…±äº«hostçš„ç›®å½•ã€‚
		ç²¾ç®€å‘½ä»¤:
		mkdir -pv ~/sd
		mount -t 9p -o trans=virtio shared0 ~/sd -o version=9p2000.L,posixacl,cache=mmap
		å®Œæ•´å‘½ä»¤:
				MOUNT_FOLDER="${HOME}/sd"
				MOUNT_NAME="shared0"
				mount_tmoe_linux_9p() {
				    [[ -e "${MOUNT_FOLDER}" ]] || mkdir -pv "${MOUNT_FOLDER}"
		            unset TMOE_MOUNT_PREFIX
				    [[ $(id -u) = "0" ]] || TMOE_MOUNT_PREFIX='sudo'
		            ${TMOE_MOUNT_PREFIX} mount -t 9p -o trans=virtio ${MOUNT_NAME} "${MOUNT_FOLDER}" -o version=9p2000.L,posixacl,cache=mmap
				}
				df | grep "${MOUNT_FOLDER}" &>/dev/null || mount_tmoe_linux_9p
		æ³¨ï¼šæ‚¨å¯ä»¥å°†å®Œæ•´å‘½ä»¤å¦å­˜ä¸ºè„šæœ¬æ–‡ä»¶ï¼Œå¹¶èµ‹äºˆæ‰§è¡Œæƒé™ï¼Œä¾¿äºè‡ªåŠ¨æŒ‚è½½ã€‚
	EOF
}
#####################
modify_qemu_shared_folder() {
    if grep -q "${BLK_DEVICE}_ENABLED=.*true" ${QEMU_FILE}; then
        CURRENT_9P_DIR=$(grep "^${BLK_DEVICE}=" ${QEMU_FILE} | cut -d '=' -f 2)
        case ${CURRENT_9P_DIR} in
        "")
            for i in ${HOME} ${HOME}/sd /sd /media/docker /media/sd; do
                [[ ! -e ${i} ]] || CURRENT_9P_DIR=${i}
            done
            ;;
        esac
        IMPORTANT_TIPS="å½“å‰å·²å…±äº«${CURRENT_9P_DIR}"
    else
        IMPORTANT_TIPS="å½“å‰æœªå¯ç”¨${BLK_DEVICE}"
    fi
    RETURN_TO_WHERE='modify_qemu_shared_folder'
    TMOE_VIRTUALIZATION=$(
        whiptail --title "9P FS SHARED DIR" --menu "è¯·é€‰æ‹©9pæ–‡ä»¶ç³»ç»Ÿè·¯å¾„\n${IMPORTANT_TIPS}" 0 0 0 \
            "1" "${HOME}/sd" \
            "2" "/media/sd" \
            "3" "/media/docker" \
            "4" "/sd" \
            "5" "${HOME}" \
            "6" "customize è‡ªå®šä¹‰" \
            "0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
            3>&1 1>&2 2>&3
    )
    #############
    case ${TMOE_VIRTUALIZATION} in
    0 | "") tmoe_qemu_disk_manager_04 ;;
    1) CURRENT_9P_DIR='${HOME}/sd' ;;
    2) CURRENT_9P_DIR='/media/sd' ;;
    3) CURRENT_9P_DIR='/media/docker' ;;
    4) CURRENT_9P_DIR='/sd' ;;
    5) CURRENT_9P_DIR='${HOME}' ;;
    6) modify_qemu_9p_dir_01 ;;
    esac
    sed -E -i "s@^(${BLK_DEVICE}=).*@\1"${CURRENT_9P_DIR}"@g;s@^(${BLK_DEVICE}_ENABLED=).*@\1true@g" ${QEMU_FILE}
    grep -E --color=auto "^${BLK_DEVICE}_ENABLED=|^${BLK_DEVICE}=" ${QEMU_FILE}
}
################
modify_qemu_9p_dir_01() {
    TARGET=$(whiptail --inputbox "è¯·è¾“å…¥æ–‡ä»¶è·¯å¾„,è‹¥ç•™ç©º,åˆ™ä½¿ç”¨${HOME}.\nPlease type the path." 10 53 --title "9P PATH" 3>&1 1>&2 2>&3)
    if [ "$?" != "0" ]; then
        ${RETURN_TO_WHERE}
    elif [ -z "${TARGET}" ]; then
        CURRENT_9P_DIR='${HOME}'
    fi
}
################
modify_qemu_disk_format() {
    CURRENT_DISK_FORMAT=$(grep "^${BLK_DEVICE}_FORMAT=" ${QEMU_FILE} | cut -d '=' -f 2)
    TMOE_FILE_ABSOLUTE_PATH=$(grep "^${BLK_DEVICE}=" ${QEMU_FILE} | cut -d '=' -f 2)
    QEMU_IMG_FOEMAT=$(qemu-img info "${TMOE_FILE_ABSOLUTE_PATH}" 2>&1 | grep format | head -n 1 | awk '{print $NF}')
    if [[ -z ${QEMU_IMG_FOEMAT} || ${QEMU_IMG_FOEMAT} = qcow2 ]]; then
        QEMU_IMG_FORMAT='raw'
    fi
    if (whiptail --title "${BLK_DEVICE} FORMAT" --yes-button "qcow2" --no-button "${QEMU_IMG_FORMAT}" --yesno "Current format is ${CURRENT_DISK_FORMAT}\nå¦‚éœ€æŒ‡å®šå…¶ä»–æ ¼å¼,è¯·æ‰‹åŠ¨ä¿®æ”¹é…ç½®è„šæœ¬" 0 0); then
        QEMU_IMG_FORMAT='qcow2'
    fi
    sed -E -i "s@^(${BLK_DEVICE}_FORMAT=).*@\1${QEMU_IMG_FORMAT}@g" ${QEMU_FILE}
    grep --color=auto "^${BLK_DEVICE}_FORMAT=" ${QEMU_FILE}
}
modify_qemu_disk_bootindex() {
    CURRENT_BOOTINDEX=$(grep "^${BLK_DEVICE}_BOOTINDEX=" ${QEMU_FILE} | cut -d '=' -f 2)
    case ${CURRENT_BOOTINDEX} in
    "") IMPORTANT_TIPS='å½“å‰è®¾å¤‡æœªæŒ‡å®šå¼•å¯¼é¡ºåº' ;;
    *) IMPORTANT_TIPS="å½“å‰è®¾å¤‡å¼•å¯¼åºå·ä¸º${CURRENT_BOOTINDEX}" ;;
    esac
    BOOTINDEX=$(
        whiptail --title "BOOT INDEX" --menu "æŒ‡å®š${BLK_DEVICE}å¼•å¯¼é¡ºåº,\n${IMPORTANT_TIPS},\nå»ºè®®æ‚¨ç›´æ¥åœ¨é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹" 0 0 0 \
            "0" "ğŸŒš Back è¿”å›" \
            "1" "ç¬¬ä¸€ä½" \
            "2" "ç¬¬äºŒä½" \
            "3" "ç¬¬ä¸‰ä½" \
            "4" "ç¬¬å››ä½" \
            "5" "ç¬¬äº”ä½" \
            "6" "ç¬¬å…­ä½" \
            "7" "ç¬¬ä¸ƒä½" \
            "8" "ç¬¬å…«ä½" \
            "9" "ç¬¬ä¹ä½" \
            "10" "ç¬¬åä½" \
            3>&1 1>&2 2>&3
    )
    #############
    case ${BOOTINDEX} in
    0 | "") ${RETURN_TO_WHERE} ;;
    *)
        sed -E -i "s@^(${BLK_DEVICE}_BOOTINDEX=).*@\1${BOOTINDEX}@g" ${QEMU_FILE}
        grep --color=auto "^${BLK_DEVICE}_BOOTINDEX=" ${QEMU_FILE}
        ;;
    esac
    press_enter_to_return
    tmoe_qemu_disk_manager_02
}
disable_qemu_disk() {
    sed -E -i "s@^(${BLK_DEVICE}_ENABLED=).*@\1false@g" ${QEMU_FILE}
    grep -E --color=auto "^${BLK_DEVICE}_ENABLED=|^${BLK_DEVICE}=" ${QEMU_FILE}
    printf "%s\n" "å·²${PURPLE}ç¦ç”¨${RESET}${BLUE}${BLK_DEVICE}${RESET}"
}
#################
compress_qcow2_img_file() {
    choose_qemu_qcow2_or_img_file
    do_you_want_to_continue
    if (whiptail --title "è¯·é€‰æ‹©å‹ç¼©æ–¹å¼" --yes-button "compress" --no-button "convert" --yesno "å‰è€…ä¸ºå¸¸è§„å‹ç¼©ï¼Œåè€…è½¬æ¢å‹ç¼©ã€‚â™ª(^âˆ‡^*) " 10 50); then
        printf '%s\n' 'compressing...'
        printf '%s\n' 'æ­£åœ¨å‹ç¼©ä¸­...'
        printf "${GREEN}%s${RESET}\n" "qemu-img convert -c -O qcow2 ${SELECTION} ${SELECTION}_new-temp-file"
        qemu-img convert -c -O qcow2 ${SELECTION} ${SELECTION}_new-temp-file
    else
        printf '%s\n' 'converting...'
        printf '%s\n' 'æ­£åœ¨è½¬æ¢ä¸­...'
        printf "${GREEN}%s${RESET}\n" "qemu-img convert -O qcow2 ${SELECTION} ${SELECTION}_new-temp-file"
        qemu-img convert -O qcow2 ${SELECTION} ${SELECTION}_new-temp-file
    fi
    qemu-img info ${SELECTION}_new-temp-file
    mv -f ${SELECTION} original_${SELECTION}
    mv -f ${SELECTION}_new-temp-file ${SELECTION}
    printf '%s\n' 'åŸæ–‡ä»¶å¤§å°'
    ls -lh original_${SELECTION} | tail -n 1 | awk '{print $5}'
    printf '%s\n' 'å‹ç¼©åçš„æ–‡ä»¶å¤§å°'
    ls -lh ${SELECTION} | tail -n 1 | awk '{print $5}'
    printf "%s\n" "å‹ç¼©å®Œæˆï¼Œæ˜¯å¦åˆ é™¤åŸå§‹æ–‡ä»¶?"
    qemu-img check ${SELECTION}
    printf "%s\n" "Do you want to delete the original fileï¼Ÿ"
    printf "%s\n" "è¯·è°¨æ…æ“ä½œï¼Œåœ¨ä¿è¯æ–°ç£ç›˜æ•°æ®æ— é”™å‰ï¼Œä¸å»ºè®®æ‚¨åˆ é™¤åŸå§‹æ–‡ä»¶ï¼Œå¦åˆ™å°†å¯¼è‡´åŸæ–‡ä»¶æ•°æ®ä¸¢å¤±"
    printf "%s\n" "è‹¥æ‚¨å–æ¶ˆæ“ä½œï¼Œåˆ™è¯·æ‰‹åŠ¨è¾“rm ${FILE_PATH}/original_${SELECTION}"
    do_you_want_to_continue
    rm -fv original_${SELECTION}
}
################
expand_qemu_qcow2_img_file() {
    printf '%s\n' 'å»ºè®®æ‚¨åœ¨è°ƒæ•´å®¹é‡å‰å¯¹ç£ç›˜æ–‡ä»¶è¿›è¡Œå¤‡ä»½ã€‚'
    printf "%s\n" "åœ¨æ‰©å®¹å®Œqcow2åï¼Œæ‚¨å¯ä»¥å¯åŠ¨linux guest,åœ¨è™šæ‹Ÿæœºå†…éƒ¨ä½¿ç”¨${GREEN}cfdisk${RESET}å‘½ä»¤æ¥è°ƒæ•´åˆ†åŒºã€‚"
    printf '%s\n' "è°ƒæ•´å®Œæˆä¹‹åï¼Œæ‚¨å¯ä»¥å†ä½¿ç”¨resize2fså‘½ä»¤å¯¹ç£ç›˜ç©ºé—´è¿›è¡Œé‡æ–°è¯†åˆ«ï¼Œä¾‹å¦‚${BLUE}resize2fs /dev/sda1${RESET}"
    printf "%s\n" "/dev/sda2ä¸€èˆ¬ä¸ºsata/scsiç£ç›˜è®¾å¤‡,æ‚¨å¯ä»¥ä½¿ç”¨${GREEN}fdisk -l${RESET}å‘½ä»¤è·å–ç£ç›˜è®¾å¤‡è·¯å¾„;è‹¥ä¸ºvirtioç£ç›˜,åˆ™ä¸€èˆ¬ä¸º${BLUE}/dev/vda1${RESET}"
    #printf '%s\n' 'åœ¨æ‰©å®¹ä¹‹åï¼Œæ‚¨å¿…é¡»åœ¨è™šæ‹Ÿæœºç³»ç»Ÿå†…å¯¹è¯¥é•œåƒè¿›è¡Œåˆ†åŒºå¹¶æ ¼å¼åŒ–åæ‰èƒ½çœŸæ­£å¼€å§‹ä½¿ç”¨æ–°ç©ºé—´ã€‚'
    #åœ¨æ”¶ç¼©ç£ç›˜æ˜ åƒå‰ï¼Œå¿…é¡»å…ˆä½¿ç”¨è™šæ‹Ÿæœºå†…éƒ¨ç³»ç»Ÿçš„åˆ†åŒºå·¥å…·å‡å°‘è¯¥åˆ†åŒºçš„å¤§å°ï¼Œç„¶åç›¸åº”åœ°æ”¶ç¼©ç£ç›˜æ˜ åƒï¼Œå¦åˆ™æ”¶ç¼©ç£ç›˜æ˜ åƒå°†å¯¼è‡´æ•°æ®ä¸¢å¤±'
    printf "%s\n" "If you want to check /dev/sda1,you can type: e2fsck -f /dev/sda1;resize2fs -f /dev/sda1;fdisk -l /dev/sda1"
    printf '%s\n' 'Arch wiki:After enlarging the disk image, you must use file system and partitioning tools inside the virtual machine to actually begin using the new space. When shrinking a disk image, you must first reduce the allocated file systems and partition sizes using the file system and partitioning tools inside the virtual machine and then shrink the disk image accordingly, otherwise shrinking the disk image will result in data loss! For a Windows guest, open the "create and format hard disk partitions" control panel.'
    do_you_want_to_continue
    choose_qemu_qcow2_or_img_file
    CURRENT_VALUE=$(qemu-img info ${SELECTION} | grep 'virtual size' | awk '{print $3.$4}' | awk -F 'iB' '{print $1}')
    #10 53
    TARGET=$(whiptail --inputbox "è¯·è¾“å…¥éœ€è¦å¢åŠ çš„ç©ºé—´å¤§å°,ä¾‹å¦‚512Mæˆ–8G(éœ€åŒ…å«å•ä½),å½“å‰ç©ºé—´ä¸º${CURRENT_VALUE}\nè‹¥ç•™ç©ºï¼Œåˆ™å¢åŠ 2048M.Please type the size" 10 53 --title "virtual size" 3>&1 1>&2 2>&3)
    if [ "$?" != "0" ]; then
        ${RETURN_TO_WHERE}
    elif [ -z "${TARGET}" ]; then
        TARGET="2048M"
    elif [[ ${TARGET} =~ ^[0-9]+$ ]]; then
        printf "%s\n" "æ‚¨æœªè¾“å…¥å•ä½,å°†è‡ªåŠ¨å¢åŠ å•ä½M"
        TARGET="${TARGET}M"
    elif [[ ! ${TARGET} =~ ^[0-9].*[A-Za-z]+$ ]]; then
        printf "%s\n" "ç£ç›˜ç©ºé—´å¤§å°ä»¥çº¯æ•°å­—å¼€å¤´ï¼Œä»¥Gæˆ–Mç­‰å•ä½ç»“å°¾ã€‚"
        TARGET="2048M"
    else
        qemu-img resize ${SELECTION} +${TARGET}
        qemu-img check ${SELECTION}
        stat ${SELECTION}
        qemu-img info ${SELECTION}
        CURRENT_VALUE=$(qemu-img info ${SELECTION} | grep 'virtual size' | awk '{print $3,$4}')
        printf "%s\n" "æ‚¨å·²å°†virtual sizeä¿®æ”¹ä¸º${CURRENT_VALUE}"
    fi
}
##############
##############
##############
tmoe_qemu_display_settings() {
    RETURN_TO_WHERE='tmoe_qemu_display_settings'
    RETURN_TO_TMOE_MENU_01='tmoe_qemu_display_settings'
    #15 50 7
    TMOE_VIRTUALIZATION=$(
        whiptail --title "DISPLAY" --menu "Which configuration do you want to modify?" 0 0 0 \
            "1" "Graphics card(æ˜¾å¡)" \
            "2" "Sound cardå£°å¡" \
            "3" "vnc/x11/spice(è¿œç¨‹ä¸æœ¬åœ°æ¡Œé¢)" \
            "4" "pulseaudioéŸ³é¢‘" \
            "0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
            3>&1 1>&2 2>&3
    )
    #############
    case ${TMOE_VIRTUALIZATION} in
    0 | "") ${RETURN_TO_MENU} ;;
    1) modify_qemu_graphics_card ;;
    2) modify_qemu_sound_card ;;
    3) choose_qemu_connection_type ;;
    4) modify_tmoe_qemu_vnc_pulse_audio_address ;;
    esac
    press_enter_to_return
    tmoe_qemu_display_settings
}
################
modify_tmoe_qemu_vnc_pulse_audio_address() {
    CURRENT_VALUE=$(grep '^AUDIO_ADDR=' ${QEMU_FILE} | head -n 1 | cut -d '=' -f 2)
    #10 60
    AUDIO_ADDR=$(whiptail --inputbox "è¯·è¾“å…¥éŸ³é¢‘æœåŠ¡åœ°å€ï¼Œé»˜è®¤ä¸º127.0.0.1:4713,å½“å‰ä¸º${CURRENT_VALUE}\nPlease type the pulseaudio server addr." 10 50 --title "MODIFY PULSE SERVER ADDRESS" 3>&1 1>&2 2>&3)
    if [ "$?" != "0" ]; then
        ${RETURN_TO_WHERE}
    elif [ -z "${AUDIO_ADDR}" ]; then
        printf "%s\n" "è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å€¼"
        printf "%s\n" "Please enter a valid value"
        #elif [[ ! ${AUDIO_ADDR} =~ ^([0-9]{1,2}|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\.([0-9]{1,2}|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\.([0-9]{1,2}|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\.([0-9]{1,2}|1[0-9][0-9]|2[0-4][0-9]|25[0-5]):[0-9]{1,5}$ ]]; then
        #	printf "${PURPLE}%s${RESET}\n" "${AUDIO_ADDR}"
        #		printf "%s\n" "æ‚¨è¾“å…¥çš„åœ°å€æ— æ•ˆ,è¯·é‡æ–°è¾“å…¥"
        #printf "%s\n" "Please re-enter."
        #press_enter_to_return
        #modify_tmoe_qemu_vnc_pulse_audio_address
    else
        sed -E -i "s@^(AUDIO_ADDR=).*@\1${AUDIO_ADDR}@g" ${QEMU_FILE}
        grep -E --color=auto "^AUDIO_ADDR=" ${QEMU_FILE}
        printf '%s\n' 'Your current PULSEAUDIO SERVER address has been modified.'
        printf "%s\n" "æ‚¨å½“å‰çš„éŸ³é¢‘åœ°å€å·²ä¿®æ”¹ä¸º$(grep '^AUDIO_ADDR=' ${QEMU_FILE} | head -n 1 | cut -d '=' -f 2)"
    fi
}
##################
modify_qemu_sound_card() {
    #RETURN_TO_WHERE='modify_qemu_sound_card'
    CURRENT_VALUE=$(grep '^SOUND_CARD=' ${QEMU_FILE} | head -n 1 | cut -d '=' -f 2)
    #16 50 7
    #ich9-intel-hdaï¼Œintel-hda,AC97å’ŒES1370ã€‚
    SOUND_CARD_ENABLED=true
    TMOE_VIRTUALIZATION=$(
        whiptail --title "å£°å¡å‹å·" --menu "Current sound-dev is ${CURRENT_VALUE},the default is intel-hda.\nå£°å¡1é»˜è®¤ä¸ºintel-hda,å£°å¡2é»˜è®¤ä¸ºac97,å£°å¡1å½“å‰ä¸º${CURRENT_VALUE}" 0 0 0 \
            "1" "ich9-intel-hda" \
            "2" "ich6(Intel HD Audio)" \
            "3" "ac97(Intel 82801AA AC97)" \
            "4" "es1370(ENSONIQ AudioPCI ES1370)" \
            "5" "disable 01 ç¦ç”¨ç¬¬ä¸€å—å£°å¡" \
            "6" "disable 02 ç¦ç”¨ç¬¬äºŒå—å£°å¡" \
            "0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
            3>&1 1>&2 2>&3
    )
    #############
    case ${TMOE_VIRTUALIZATION} in
    0 | "") tmoe_qemu_display_settings ;;
    1) SOUND_CARD='ich9-intel-hda' ;;
    2) SOUND_CARD='intel-hda' ;;
    3) SOUND_CARD='AC97' ;;
    4) SOUND_CARD='ES1370' ;;
    5)
        SOUND_CARD='DISABLED'
        SOUND_CARD_ENABLED=false
        ;;
    6)
        SOUND_CARD_02='DISABLED'
        SOUND_CARD_02_ENABLED=false
        ;;
    esac
    case ${TMOE_VIRTUALIZATION} in
    6)
        sed -E -i "s@^(SOUND_CARD_02=).*@\1${SOUND_CARD_02}@g;s@^(SOUND_CARD_02_ENABLED=).*@\1${SOUND_CARD_02_ENABLED}@g" ${QEMU_FILE}
        grep -E --color=auto "^SOUND_CARD_02=|^SOUND_CARD_02_ENABLED=" ${QEMU_FILE}
        printf "%s\n" "æ‚¨å·²å°†sound_card_02ä¿®æ”¹ä¸º${BLUE}${SOUND_CARD_02}${RESET}"
        ;;
    *)
        sed -E -i "s@^(SOUND_CARD=).*@\1${SOUND_CARD}@g;s@^(SOUND_CARD_ENABLED=).*@\1${SOUND_CARD_ENABLED}@g" ${QEMU_FILE}
        grep -E --color=auto "^SOUND_CARD=|^SOUND_CARD_ENABLED=" ${QEMU_FILE}
        printf "%s\n" "æ‚¨å·²å°†sound_cardä¿®æ”¹ä¸º${BLUE}${SOUND_CARD}${RESET}"
        ;;
    esac
    press_enter_to_return
    ${RETURN_TO_WHERE}
}
############
modify_qemu_graphics_card() {
    CURRENT_VALUE=$(grep '^GPU_MODEL=' ${QEMU_FILE} | head -n 1 | cut -d '=' -f 2)
    #16 50 7
    TMOE_VIRTUALIZATION=$(
        whiptail --title "GPU/VGA" --menu "Current display-dev is ${CURRENT_VALUE},the default is qxl-vga.\né»˜è®¤ä¸ºqxl-vga,å½“å‰ä¸º${CURRENT_VALUE}" 0 0 0 \
            "1" "virtio-vga:bus PCI,åŠè™šæ‹ŸåŒ–" \
            "2" "qxl-vga:bus PCI,Spice QXL GPU,åŠè™šæ‹ŸåŒ–" \
            "3" "VGA:bus PCI" \
            "4" "bochs-display:bus PCI" \
            "5" "cirrus-vga:bus PCI,desc(Cirrus CLGD 54xx)" \
            "6" "secondary-vga:bus PCI" \
            "7" "ati-vga:bus PCI" \
            "8" "vmware-svga:bus PCI" \
            "0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
            3>&1 1>&2 2>&3
    )
    #############
    case ${TMOE_VIRTUALIZATION} in
    0 | "") tmoe_qemu_display_settings ;;
    1) GPU_MODEL='virtio-vga' ;;
    2)
        printf "%s\n" "QXL paravirtual graphic card.  It is VGA compatible (including VESA 2.0 VBE support).  Works best with qxl guest drivers installed though.  Recommended choice when using the spice protocol."
        GPU_MODEL='qxl-vga'
        ;;
    3) GPU_MODEL='VGA' ;;
    4)
        printf "%s\n" "std Standard VGA card with Bochs VBE extensions.  If your guest OS supports the VESA 2.0 VBE extensions (e.g. Windows XP) and if you want to use high resolution modes (>= 1280x1024x16) then you should use this option. (This card is the default since QEMU 2.2)"
        GPU_MODEL='bochs-display'
        ;;
    5)
        printf "%s\n" "Cirrus Logic GD5446 Video card. All Windows versions starting from Windows 95 should recognize and use this graphic card. For optimal performances, use 16 bit color depth in the guest and the host OS.  (This card was the default before QEMU 2.2) "
        GPU_MODEL='cirrus-vga'
        ;;
    6) GPU_MODEL='secondary-vga' ;;
    7) GPU_MODEL='ati-vga' ;;
    8)
        printf "%s\n" " VMWare SVGA-II compatible adapter. Use it if you have sufficiently recent XFree86/XOrg server or Windows guest with a driver for this card."
        GPU_MODEL='vmware-svga'
        ;;
    esac
    ###############
    sed -E -i "s@^(GPU_MODEL=).*@\1${GPU_MODEL}@g" ${QEMU_FILE}
    grep --color=auto "^GPU_MODEL=" ${QEMU_FILE}
    printf "%s\n" "æ‚¨å·²å°†graphics_cardä¿®æ”¹ä¸º${BLUE}${GPU_MODEL}${RESET}"
    press_enter_to_return
    ${RETURN_TO_WHERE}
}
###############
###############
###############
tmoe_qemu_x64_cpu_manager() {
    RETURN_TO_WHERE='tmoe_qemu_x64_cpu_manager'
    #15 50 6
    TMOE_VIRTUALIZATION=$(
        whiptail --title "CPU & RAM" --menu "Which configuration do you want to modify?" 0 0 0 \
            "1" "CPU sockets,cores,threads" \
            "2" "cpu model/type(å‹å·/ç±»å‹)" \
            "3" "RAMè¿è¡Œå†…å­˜" \
            "4" "kvm/tcg/xenåŠ é€Ÿç±»å‹" \
            "0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
            3>&1 1>&2 2>&3
    )
    #############
    case ${TMOE_VIRTUALIZATION} in
    0 | "") ${RETURN_TO_MENU} ;;
    1) modify_number_of_qemu_cpus ;;
    2) modify_qemu_amd64_tmoe_cpu_type ;;
    3) choose_memory_allocation_type ;;
    4) modify_qemu_machine_accel ;;
    esac
    ###############
    #-soundhw cs4231a \
    press_enter_to_return
    ${RETURN_TO_WHERE}
}
############
modify_qemu_machine_accel() {
    if grep -Eq 'vmx|smx' /proc/cpuinfo; then
        if [ "$(lsmod | grep kvm)" ]; then
            KVM_STATUS='æ£€æµ‹åˆ°æ‚¨çš„CPUå¯èƒ½æ”¯æŒç¡¬ä»¶è™šæ‹ŸåŒ–,å¹¶ä¸”å·²ç»å¯ç”¨äº†KVMå†…æ ¸æ¨¡å—ã€‚'
        else
            KVM_STATUS='æ£€æµ‹åˆ°æ‚¨çš„CPUå¯èƒ½æ”¯æŒç¡¬ä»¶è™šæ‹ŸåŒ–ï¼Œä½†æœªæ£€æµ‹åˆ°KVMå†…æ ¸æ¨¡å—ï¼'
        fi
    else
        KVM_STATUS='æ£€æµ‹åˆ°æ‚¨çš„CPUå¯èƒ½ä¸æ”¯æŒç¡¬ä»¶è™šæ‹ŸåŒ–ï¼'
    fi
    #17 50 5
    CURRENT_VALUE=$(grep '^MACHINE_ACCEL=' ${QEMU_FILE} | head -n 1 | cut -d '=' -f 2)
    TMOE_VIRTUALIZATION=$(
        whiptail --title "åŠ é€Ÿç±»å‹" --menu "KVMè¦æ±‚cpuæ”¯æŒç¡¬ä»¶è™šæ‹ŸåŒ–,è¿›è¡ŒåŒæ¶æ„æ¨¡æ‹Ÿè¿è¡Œæ—¶èƒ½å¾—åˆ°æ¯”tcgæ›´å¿«çš„é€Ÿåº¦ã€‚\n${KVM_STATUS}\nå½“å‰ä¸º${CURRENT_VALUE}" 0 50 0 \
            "1" "kvm:tcg(default)" \
            "2" "tcg:kvm" \
            "3" "tcg" \
            "0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
            3>&1 1>&2 2>&3
    )
    #############
    case ${TMOE_VIRTUALIZATION} in
    0 | "") ${RETURN_TO_WHERE} ;;
    1)
        MACHINE_ACCEL="kvm:tcg"
        ENABLE_KVM=true
        ;;
    2)
        MACHINE_ACCEL="tcg:kvm"
        ENABLE_KVM=false
        ;;
    3)
        MACHINE_ACCEL="tcg"
        ENABLE_KVM=false
        ;;
    esac
    ###############
    sed -E -i "s@^(MACHINE_ACCEL=).*@\1${MACHINE_ACCEL}@g;s@^(ENABLE_KVM=).*@\1${ENABLE_KVM}@g" ${QEMU_FILE}
    grep --color=auto "^MACHINE_ACCEL=" ${QEMU_FILE}
    printf "%s\n" "æ‚¨å·²å°†MACHINE_ACCELä¿®æ”¹ä¸º${BLUE}${MACHINE_ACCEL}${RESET}"
}
#############
choose_memory_allocation_type() {
    CURRENT_VALUE=$(grep '^MEMORY_REDUCED=' ${QEMU_FILE} | head -n 1 | cut -d '=' -f 2)
    [[ -n ${CURRENT_VALUE} ]] || CURRENT_VALUE=256
    if grep -q '^MEMORY_ALLOCATION=.*auto' ${QEMU_FILE}; then
        IMPORTANT_TIPS='å½“å‰å·²å¯ç”¨autoåˆ†é…æ¨¡å¼ã€‚'
    else
        IMPORTANT_TIPS='å½“å‰ä¸ºmanuallyåˆ†é…æ¨¡å¼ã€‚'
    fi

    if (whiptail --title "MEMORY ALLOCATION TYPE" --yes-button 'auto' --no-button 'manually' --yesno "If you choose auto, the guest's RAM will be allocated automatically according to the host's available RAM.\nè‹¥é€‰æ‹©auto,åˆ™å°†è‡ªåŠ¨åˆ†é…å†…å­˜,åˆ†é…è§„åˆ™ä¸ºå½“å‰å®¿ä¸»æœºå¯ç”¨å†…å­˜(ä¸å«swap)å‡å»${CURRENT_VALUE}M\nè‹¥é€‰manually,åˆ™å°†æŒ‡å®šè™šæ‹Ÿæœºå†…å­˜å¤§å°ã€‚\n${IMPORTANT_TIPS}" 13 50); then
        sed -E -i "s@^(MEMORY_ALLOCATION=).*@\1auto@g" ${QEMU_FILE}
        grep --color=auto "^MEMORY_ALLOCATION=" ${QEMU_FILE}
        TARGET=$(whiptail --inputbox "å·²å¯ç”¨auto-mode,è¯·è¾“å…¥è‡ªåŠ¨åˆ†é…æ—¶éœ€è¦å‡å°‘çš„å†…å­˜å¤§å°(éå®é™…å†…å­˜å¤§å°),è¯¦è§é…ç½®è„šæœ¬ä¸­MEMORY_ALLOCATIONçš„è¯´æ˜\né»˜è®¤ä¸º256,å½“å‰ä¸º${CURRENT_VALUE}\nPlease type size to be reduced during auto allocation" 13 50 --title "MEMORY_REDUCED" 3>&1 1>&2 2>&3)
        if [ "$?" != "0" ]; then
            #printf "%s\n" "æ£€æµ‹åˆ°æ‚¨å–æ¶ˆäº†æ“ä½œ"
            ${RETURN_TO_WHERE}
        elif [ -z "${TARGET}" ]; then
            printf "%s\n" "è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å€¼"
            printf "%s\n" "Please enter a valid value"
        elif [[ ! ${TARGET} =~ ^[0-9]+$ ]]; then
            printf "%s\n" "Please type the pure number"
        else
            sed -E -i "s@^(MEMORY_REDUCED=).*@\1${TARGET}@g" ${QEMU_FILE}
            grep --color=auto "^MEMORY_REDUCED=" ${QEMU_FILE}
            printf "%s\n" "æ‚¨å·²å°†MEMORY_REDUCEDçš„å€¼ä¿®æ”¹ä¸º${BLUE}${TARGET}${RESET}"
        fi
    else
        modify_qemu_ram_size
    fi
}
#################
modify_qemu_ram_size() {
    CURRENT_VALUE_02=$(grep '^MEMORY_SIZE=' ${QEMU_FILE} | head -n 1 | cut -d '=' -f 2)
    CURRENT_VALUE_03=$(free -m | awk '{print $NF}' | sed -n 2p)
    TARGET=$(whiptail --inputbox "è¯·è¾“å…¥è¿è¡Œå†…å­˜å¤§å°,é»˜è®¤ä¸º1024,å½“å‰ä¸º${CURRENT_VALUE_02}\næ¬²æ”¹ä¸º2G,åˆ™è¾“2048;æ¬²æ”¹ä¸º4G,åˆ™è¾“4096\nå½“å‰å®¿ä¸»æœºå¯ç”¨å†…å­˜${CURRENT_VALUE_03}\nPlease type the RAM size, the default is 1024" 11 50 --title "RAM" 3>&1 1>&2 2>&3)
    if [ "$?" != "0" ]; then
        #printf "%s\n" "æ£€æµ‹åˆ°æ‚¨å–æ¶ˆäº†æ“ä½œ"
        ${RETURN_TO_WHERE}
    elif [ -z "${TARGET}" ]; then
        printf "%s\n" "è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å€¼"
        printf "%s\n" "Please enter a valid value"
    elif [[ ! ${TARGET} =~ ^[0-9]+$ ]]; then
        printf "%s\n" "Please type the pure number"
    else
        sed -E -i "s@^(MEMORY_SIZE=).*@\1${TARGET}@g;s@^(MEMORY_ALLOCATION=).*@\1num@g" ${QEMU_FILE}
        grep --color=auto "^MEMORY_SIZE=|^MEMORY_ALLOCATION=" ${QEMU_FILE}
        printf "%s\n" "æ‚¨å·²å°†MEMORY_SIZEçš„å€¼ä¿®æ”¹ä¸º${BLUE}${TARGET}${RESET}"
    fi
}
modify_number_of_qemu_cpus() {
    TMOE_VIRTUALIZATION=$(
        whiptail --title "CPU CORES NUM" --menu "Please choose the num of cpu cores.\né»˜è®¤ä¸º2ä¸ªvcpu,2ä¸ªsockets,1ä¸ªcore,1ä¸ªthread\nå³2ä¸ªCPUæ’æ§½ x å•æ ¸ x å•çº¿ç¨‹" 0 0 0 \
            "1" "1x1x1" \
            "2" "2x1x1" \
            "4" "2x2x1" \
            "8" "2x2x2" \
            "16" "2x4x2" \
            "32" "2x8x2" \
            "64" "2x16x2" \
            "128" "2x32x2" \
            "255" "255x1x1" \
            "0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
            3>&1 1>&2 2>&3
    )
    #############
    case ${TMOE_VIRTUALIZATION} in
    0 | "") ${RETURN_TO_WHERE} ;;
    1)
        CPUS_NUM='1'
        SOCKETS_NUM='1'
        CORES_NUM='1'
        THREADS_NUM='1'
        ;;
    2)
        CPUS_NUM='2'
        SOCKETS_NUM='2'
        CORES_NUM='1'
        THREADS_NUM='1'
        ;;
    4)
        CPUS_NUM='4'
        SOCKETS_NUM='2'
        CORES_NUM='2'
        THREADS_NUM='1'
        ;;
    8)
        CPUS_NUM='8'
        SOCKETS_NUM='2'
        CORES_NUM='2'
        THREADS_NUM='2'
        ;;
    16)
        CPUS_NUM='16'
        SOCKETS_NUM='2'
        CORES_NUM='4'
        THREADS_NUM='2'
        ;;
    32)
        CPUS_NUM='32'
        SOCKETS_NUM='2'
        CORES_NUM='8'
        THREADS_NUM='2'
        ;;
    64)
        CPUS_NUM='64'
        SOCKETS_NUM='2'
        CORES_NUM='16'
        THREADS_NUM='2'
        ;;
    128)
        CPUS_NUM='128'
        SOCKETS_NUM='2'
        CORES_NUM='32'
        THREADS_NUM='2'
        ;;
    255)
        CPUS_NUM='255'
        SOCKETS_NUM='255'
        CORES_NUM='1'
        THREADS_NUM='1'
        ;;
    esac
    ###############
    sed -E -i "s@^(CPUS_NUM=).*@\1${CPUS_NUM}@g;s@^(SOCKETS_NUM=).*@\1${SOCKETS_NUM}@g;s@^(CORES_NUM=).*@\1${CORES_NUM}@g;s@^(THREADS_NUM=).*@\1${THREADS_NUM}@g" ${QEMU_FILE}
    grep -E --color=auto "^CPUS_NUM=|^SOCKETS_NUM=|^CORES_NUM=|^THREADS_NUM=" ${QEMU_FILE}
}
###############
###############
###############
modify_tmoe_qemu_network_settings() {
    RETURN_TO_WHERE='modify_tmoe_qemu_network_settings'
    NET_DEVICE='NET_CARD_01'
    TMOE_VIRTUALIZATION=$(
        whiptail --title "network devices" --menu "Which configuration do you want to modifyï¼Ÿ" 0 0 0 \
            "1" "network card 01(ç¬¬ä¸€å—ç½‘å¡)" \
            "2" "net-01 port forwardç«¯å£è½¬å‘01" \
            "3" "network card 02(ç¬¬äºŒå—ç½‘å¡)" \
            "4" "net-02 port forwardç«¯å£è½¬å‘02" \
            "5" "network card 03(ç¬¬ä¸‰å—ç½‘å¡)" \
            "0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
            3>&1 1>&2 2>&3
    )
    #############
    case ${TMOE_VIRTUALIZATION} in
    0 | "") ${RETURN_TO_MENU} ;;
    1)
        NET_DEVICE='NET_CARD_01'
        DEFAULT_VALUE='virtio-net-pci'
        IMPORTANT_TIPS="ç½‘å¡01é»˜è®¤ä¸º${DEFAULT_VALUE},"
        modify_qemu_tmoe_network_card
        ;;
    2)
        NET_DEVICE='NET_CARD_01'
        modify_qemu_exposed_ports
        ;;
    3)
        NET_DEVICE='NET_CARD_02'
        DEFAULT_VALUE="e1000"
        IMPORTANT_TIPS="ç½‘å¡02é»˜è®¤ä¸º${DEFAULT_VALUE},"
        modify_qemu_tmoe_network_card
        ;;
    4)
        NET_DEVICE='NET_CARD_02'
        modify_qemu_exposed_ports
        ;;
    5)
        NET_DEVICE='NET_CARD_03'
        DEFAULT_VALUE="rtl8139"
        IMPORTANT_TIPS="ç½‘å¡03é»˜è®¤ä¸º${DEFAULT_VALUE},"
        modify_qemu_tmoe_network_card
        ;;
    esac
    ###############
    press_enter_to_return
    modify_tmoe_qemu_network_settings
}
#############
modify_qemu_tmoe_network_card() {
    RETURN_TO_WHERE='modify_qemu_tmoe_network_card'
    #16 50 7
    CURRENT_VALUE=$(grep "^${NET_DEVICE}=" ${QEMU_FILE} | head -n 1 | cut -d '=' -f 2)
    TMOE_VIRTUALIZATION=$(
        whiptail --title "ç½‘å¡å‹å·" --menu "Current netdev is ${CURRENT_VALUE},the default is ${DEFAULT_VALUE}.\n${IMPORTANT_TIPS}å½“å‰ä¸º${CURRENT_VALUE}" 0 0 0 \
            "0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
            "1" "disable ç¦ç”¨" \
            "2" "virtio-net-pci" \
            "3" "e1000:alias e1000-82540em" \
            "4" "e1000-82544gc:Intel Gigabit Ethernet" \
            "5" "e1000-82545em" \
            "6" "e1000e:Intel 82574L GbE Controller" \
            "7" "Realtek rtl8139" \
            "8" "vmxnet3:VMWare Paravirtualized Eth v3" \
            "9" "i82550:Intel i82550 Ethernet" \
            "10" "i82551" \
            "11" "i82557a" \
            "12" "i82557b" \
            "13" "i82557c" \
            "14" "i82558a" \
            "15" "i82558b" \
            "16" "i82559a" \
            "17" "i82559b" \
            "18" "i82559er" \
            "19" "i82562" \
            "20" "i82801" \
            "21" "ne2k_pci" \
            "22" "pcnet" \
            "23" "pcnet" \
            "24" "pvrdma" \
            "25" "rocker" \
            "26" "tulip" \
            3>&1 1>&2 2>&3
    )
    #############
    case ${TMOE_VIRTUALIZATION} in
    0 | "") modify_tmoe_qemu_network_settings ;;
    2) TMOE_QEMU_NETWORK_CARD="virtio-net-pci" ;;
    3) TMOE_QEMU_NETWORK_CARD="e1000" ;;
    4) TMOE_QEMU_NETWORK_CARD="e1000-82544gc" ;;
    5) TMOE_QEMU_NETWORK_CARD="e1000-82545em" ;;
    6) TMOE_QEMU_NETWORK_CARD="e1000e" ;;
    7) TMOE_QEMU_NETWORK_CARD="rtl8139" ;;
    8) TMOE_QEMU_NETWORK_CARD="vmxnet3" ;;
    9) TMOE_QEMU_NETWORK_CARD="i82550" ;;
    10) TMOE_QEMU_NETWORK_CARD="i82551" ;;
    11) TMOE_QEMU_NETWORK_CARD="i82557a" ;;
    12) TMOE_QEMU_NETWORK_CARD="i82557b" ;;
    13) TMOE_QEMU_NETWORK_CARD="i82557c" ;;
    14) TMOE_QEMU_NETWORK_CARD="i82558a" ;;
    15) TMOE_QEMU_NETWORK_CARD="i82558b" ;;
    16) TMOE_QEMU_NETWORK_CARD="i82559a" ;;
    17) TMOE_QEMU_NETWORK_CARD="i82559b" ;;
    18) TMOE_QEMU_NETWORK_CARD="i82559er" ;;
    19) TMOE_QEMU_NETWORK_CARD="i82562" ;;
    20) TMOE_QEMU_NETWORK_CARD="i82801" ;;
    21) TMOE_QEMU_NETWORK_CARD="ne2k_pci" ;;
    22) TMOE_QEMU_NETWORK_CARD="pcnet" ;;
    23) TMOE_QEMU_NETWORK_CARD="pcnet" ;;
    24) TMOE_QEMU_NETWORK_CARD="pvrdma" ;;
    25) TMOE_QEMU_NETWORK_CARD="rocker" ;;
    26) TMOE_QEMU_NETWORK_CARD="tulip" ;;
    esac
    case ${TMOE_VIRTUALIZATION} in
    1)
        sed -E -i "s@^(${NET_DEVICE}_ENABLED=).*@\1false@g" ${QEMU_FILE}
        sed -E -i "s@^(${NET_DEVICE}=).*@\1DISABLED@g" ${QEMU_FILE}
        printf "%s\n" "æ‚¨å·²ç¦ç”¨${NET_DEVICE}"
        ;;
    *)
        sed -E -i "s@^(${NET_DEVICE}=).*@\1"${TMOE_QEMU_NETWORK_CARD}"@g;s@^(${NET_DEVICE}_ENABLED=).*@\1true@g" ${QEMU_FILE}
        printf "%s\n" "æ‚¨å·²å°†network cardä¿®æ”¹ä¸º${TMOE_QEMU_NETWORK_CARD}"
        ;;
    esac
    grep -E --color=auto "^${NET_DEVICE}_ENABLED=|^${NET_DEVICE}=" ${QEMU_FILE}
}
###########
modify_qemu_exposed_ports() {
    case ${NET_DEVICE} in
    NET_CARD_02) PORT_FWD_VAR='TCP_PORT_HOST_FWD_02' ;;
    NET_CARD_01) PORT_FWD_VAR='TCP_PORT_HOST_FWD_01' ;;
    esac
    CURRENT_VALUE=$(grep "^${PORT_FWD_VAR}_ENABLED=" ${QEMU_FILE} | head -n 1 | cut -d '=' -f 2)
    #IMPORTANT_TIPS
    if (whiptail --title "TCP PORT FWD" --yes-button 'modify rules' --no-button 'disable' --yesno "æ‚¨æ˜¯æƒ³è¦ä¿®æ”¹tcpç«¯å£è½¬å‘è§„åˆ™ï¼Œè¿˜æ˜¯ç¦ç”¨æ­¤åŠŸèƒ½å‘¢ï¼Ÿ\nå¦‚éœ€ä¿®æ”¹udpç«¯å£è½¬å‘è§„åˆ™ï¼Œåˆ™è¯·æ‰‹åŠ¨ç¼–è¾‘é…ç½®è„šæœ¬\næ£€æµ‹åˆ°${PORT_FWD_VAR}çš„çŠ¶æ€ä¸º${CURRENT_VALUE}\nDo you want to modify the tcp port fwd rules,or disable it." 13 50); then
        modify_qemu_host_and_guest_port
    else
        disable_qemu_tcp_port_fwd
    fi
}
#################
disable_qemu_tcp_port_fwd() {
    sed -E -i "s@^(${PORT_FWD_VAR}_ENABLED=).*@\1false@g" ${QEMU_FILE}
    grep -E --color=auto "^${PORT_FWD_VAR}_ENABLED=" ${QEMU_FILE}
    printf "%s\n" "æ‚¨${PURPLE}å·²ç¦ç”¨${BLUE}${PORT_FWD_VAR}${RESET}"
}
#################
modify_qemu_host_and_guest_port() {
    CURRENT_VALUE=$(grep "^${PORT_FWD_VAR}=" ${QEMU_FILE} | head -n 1 | cut -d '=' -f 2)
    TCP_PORT_FWD_RULES=$(whiptail --inputbox "è¯·è¾“å…¥ç«¯å£è½¬å‘è§„åˆ™,ä¾‹å¦‚2888:22,39081:39080\n22ä¸ºguestçš„sshç«¯å£,2888ä¸ºhostçš„ç«¯å£,ç”¨é€—å·åˆ†éš”ä¸åŒçš„è§„åˆ™\nThe current port fwd rules are ${CURRENT_VALUE}" 13 50 --title "TCP PORT FWD RULES" 3>&1 1>&2 2>&3)
    if [ "$?" != "0" ]; then
        ${RETURN_TO_WHERE}
    elif [ -z "${TCP_PORT_FWD_RULES}" ]; then
        printf "%s\n" "è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å€¼"
        printf "%s\n" "Please enter a valid value"
    else
        sed -E -i "s@^(${PORT_FWD_VAR}=).*@\1"${TCP_PORT_FWD_RULES}"@g;s@^(${PORT_FWD_VAR}_ENABLED=).*@\1true@g" ${QEMU_FILE}
        grep -E --color=auto "^${PORT_FWD_VAR}_ENABLED=|^${PORT_FWD_VAR}=" ${QEMU_FILE}
        printf "%s\n" "æ‚¨å·²å°†${PORT_FWD_VAR}è½¬å‘è§„åˆ™ä¿®æ”¹ä¸º${TCP_PORT_FWD_RULES}"
    fi
}
########
########
########
modify_tmoe_qemu_extra_options() {
    RETURN_TO_WHERE='modify_tmoe_qemu_extra_options'
    TMOE_VIRTUALIZATION=$(
        whiptail --title "EXTRA OPTIONS" --menu "Which configuration do you want to modifyï¼Ÿ" 0 0 0 \
            "1" "legacy bios or uefi" \
            "2" "uefi file" \
            "3" "ä¿®æ”¹qemu binè·¯å¾„" \
            "4" "ğŸ¤ FAQå¸¸è§é—®é¢˜" \
            "5" "architectureæ¶æ„(x86/x64)" \
            "6" "machine æœºå™¨ç±»å‹(1996/2009)" \
            "7" "RTC(localtime/UTC)" \
            "0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
            3>&1 1>&2 2>&3
    )
    #############
    case ${TMOE_VIRTUALIZATION} in
    0 | "") ${RETURN_TO_MENU} ;;
    1) choose_uefi_or_bios ;;
    2) choose_qemu_bios_or_uefi_file ;;
    3) modify_qemu_bin_path ;;
    4) tmoe_qemu_faq ;;
    5) choose_your_qemu_arch ;;
    6) choose_qemu_machine_type ;;
    7) choose_qemu_rtc_base ;;
    esac
    ###############
    press_enter_to_return
    modify_tmoe_qemu_extra_options
}
#################
choose_qemu_rtc_base() {
    CURRENT_VALUE=$(grep '^RTC_BASE=' ${QEMU_FILE} | head -n 1 | cut -d '=' -f 2)
    if (whiptail --title "RTC BASE" --yes-button 'utc' --no-button 'localtime' --yesno "Current rtc-base is ${CURRENT_VALUE}.\nè‹¥guestä¸ºlinux,åˆ™é€‰æ‹©utc,è‹¥ä¸ºwin,åˆ™é€‰localtime" 10 50); then
        RTC_BASE='utc'
    else
        RTC_BASE='localtime'
    fi
    sed -E -i "s@^(RTC_BASE=).*@\1${RTC_BASE}@g" ${QEMU_FILE}
    grep --color=auto "^RTC_BASE=" ${QEMU_FILE}
}
delete_current_qemu_vm_conf() {
    UEFI_VARS_PFLASH="${HOME}/.config/tmoe-linux/qemu/${QEMU_VM_NAME}-NVRAM.fd"
    printf "%s\n" "${RED}rm -fv ${BLUE}${QEMU_FILE} ${HOME}/${QEMU_VM_NAME} ${UEFI_VARS_PFLASH}${RESET}"
    do_you_want_to_continue
    rm -fv ${QEMU_FILE} ${HOME}/${QEMU_VM_NAME}
    [[ ! -e ${UEFI_VARS_PFLASH} ]] || rm -fv ${UEFI_VARS_PFLASH}
    press_enter_to_return
    tmoe_qemu_main_menu
    #æ­¤å¤„éœ€è¿”å›qemuä¸»èœå•
}
###############
modify_qemu_bin_path() {
    CURRENT_VALUE=$(grep "^QEMU_BIN_PATH=" ${QEMU_FILE} | head -n 1 | cut -d '=' -f 2)
    if (whiptail --title "QEMU BIN PATH" --yes-button '/usr/bin' --no-button '/usr/local/bin' --yesno "Please choose the qemu bin file path\nè¯·é€‰æ‹©qemuäºŒè¿›åˆ¶æ–‡ä»¶æ‰€åœ¨è·¯å¾„\nå½“å‰ä¸º${CURRENT_VALUE}" 10 50); then
        QEMU_BIN_PATH="/usr/bin"
    else
        QEMU_BIN_PATH="/usr/local/bin"
    fi
    if [ ! -x "${QEMU_BIN_PATH}/qemu-system-x86_64" ]; then
        chmod a+rx -v "${QEMU_BIN_PATH}/qemu-system-x86_64"
        printf "${RED}%s${RESET}%s\n" "ERRORï¼" "ç›®æ ‡è·¯å¾„ä¸‹çš„qemu-system-x86_64æ— æ‰§è¡Œæƒé™ã€‚"
    else
        sed -E -i "s@^(QEMU_BIN_PATH=).*@\1${QEMU_BIN_PATH}@g" ${QEMU_FILE}
        grep -E --color=auto "^QEMU_BIN_PATH=" ${QEMU_FILE}
        printf "%s\n" "æ‚¨å·²å°†QEMU_BIN_PATHä¿®æ”¹ä¸º${QEMU_BIN_PATH}"
    fi
}
choose_qemu_bios_or_uefi_file() {
    # if [ ! -e "/usr/share/qemu-efi-aarch64/QEMU_EFI.fd" ]; then
    # 	DEPENDENCY_01=''
    # 	DEPENDENCY_02='qemu-efi-aarch64'
    # 	#beta_features_quick_install
    # fi
    if [ ! -e "/usr/share/ovmf/OVMF.fd" ]; then
        DEPENDENCY_01=''
        DEPENDENCY_02='ovmf'
        beta_features_quick_install
    fi
    RETURN_TO_WHERE='choose_qemu_bios_or_uefi_file'

    if grep -q 'UEFI_ENABLED=.*true' ${QEMU_FILE}; then
        CURRENT_VALUE=$(grep '^UEFI_CODE_PFLASH=' ${QEMU_FILE} | head -n 1 | cut -d '=' -f 2)
    else
        CURRENT_VALUE='legacy bios'
    fi
    TMOE_VIRTUALIZATION=$(
        whiptail --title "uefi" --menu "Please choose a uefi file.\nå½“å‰ä¸º${CURRENT_VALUE}" 0 0 0 \
            "1" "ovmf:TianoCore firmware for x64" \
            "2" "/usr/share/edk2-ovmf/x64/OVMF_CODE.fd" \
            "3" "/usr/share/OVMF/OVMF_CODE_4M.fd" \
            "4" "/usr/share/OVMF/OVMF_CODE_4M.secboot.fd" \
            "5" "/usr/share/OVMF/OVMF_CODE.fd" \
            "6" "choose a fileè‡ªé€‰æ–‡ä»¶" \
            "0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
            3>&1 1>&2 2>&3
    )
    #ovmf:TianoCore firmware for x64
    #############
    case ${TMOE_VIRTUALIZATION} in
    0 | "") modify_tmoe_qemu_extra_options ;;
    1) TMOE_QEMU_BIOS_FILE_PATH='/usr/share/ovmf/OVMF_CODE.fd' ;;
    2) TMOE_QEMU_BIOS_FILE_PATH='/usr/share/edk2-ovmf/x64/OVMF_CODE.fd' ;;
    3) TMOE_QEMU_BIOS_FILE_PATH='/usr/share/OVMF/OVMF_CODE_4M.fd' ;;
    4) TMOE_QEMU_BIOS_FILE_PATH='/usr/share/OVMF/OVMF_CODE_4M.secboot.fd' ;;
    5) TMOE_QEMU_BIOS_FILE_PATH='/usr/share/OVMF/OVMF_CODE.fd' ;;
    6) tmoe_choose_a_qemu_bios_file ;;
    esac
    ###############
    sed -E -i "s@^(UEFI_CODE_PFLASH=).*@\1"${TMOE_QEMU_BIOS_FILE_PATH}"@g;s@^(UEFI_ENABLED=).*@\1true@g" ${QEMU_FILE}
    grep -E --color=auto "^UEFI_CODE_PFLASH=|^UEFI_ENABLED=" ${QEMU_FILE}
    printf "%s\n" "æ‚¨å·²å°†UEFIæ–‡ä»¶ä¿®æ”¹ä¸º${TMOE_QEMU_BIOS_FILE_PATH}"
}
##########
tmoe_choose_a_qemu_bios_file() {
    FILE_EXT_01='fd'
    FILE_EXT_02='bin'
    IMPORTANT_TIPS="æ‚¨å½“å‰å·²åŠ è½½çš„biosä¸º${CURRENT_VALUE}"
    CURRENT_QEMU_ISO="${CURRENT_VALUE}"
    where_is_tmoe_file_dir
    if [ -z ${SELECTION} ]; then
        printf "%s\n" "æ²¡æœ‰æŒ‡å®š${YELLOW}æœ‰æ•ˆ${RESET}çš„${BLUE}æ–‡ä»¶${GREEN}ï¼Œè¯·${GREEN}é‡æ–°${RESET}é€‰æ‹©"
        press_enter_to_return
        ${RETURN_TO_WHERE}
    else
        printf "%s\n" "æ‚¨é€‰æ‹©çš„æ–‡ä»¶ä¸º${TMOE_FILE_ABSOLUTE_PATH}"
        ls -lah ${TMOE_FILE_ABSOLUTE_PATH}
        cd ${FILE_PATH}
        file ${SELECTION}
    fi
    TMOE_QEMU_BIOS_FILE_PATH="${TMOE_FILE_ABSOLUTE_PATH}"
    do_you_want_to_continue
}
########
########
how_to_create_a_new_tmoe_qemu_vm() {
    cat <<-'EOF'
		   1.ä¸‹è½½isoé•œåƒæ–‡ä»¶ Download a iso file.
		   è‹¥è™šæ‹Ÿç£ç›˜å†…å·²ç»å®‰è£…äº†ç³»ç»Ÿï¼Œåˆ™å¯è·³è¿‡æ­¤æ­¥ã€‚
		   If the qcow2 disk has a built-in system,then you can skip this step.
		        
			2.æ–°å»ºä¸€ä¸ªè™šæ‹Ÿç£ç›˜
			create a new vitual disk (qcow2 format).

			3.é€‰æ‹©å¯åŠ¨å…‰ç›˜iso
			Choose a iso file(CD-ROM)

			4.é€‰æ‹©å¯åŠ¨ç£ç›˜
			Choose a qcow2 disk

			5.ä¿®æ”¹ç›¸å…³å‚æ•°
			Modify the parameters of qemu.

			6.è¾“startqemu
			Type startqemu and press enter
			-------------------
			æ³¨ï¼šè‹¥æ‚¨ä½¿ç”¨çš„æ˜¯x86è™šæ‹Ÿæœºé•œåƒï¼Œåˆ™éœ€è¦åœ¨é¢å¤–é€‰é¡¹ä¸­ï¼Œå°†æ¶æ„åˆ‡æ¢ä¸ºi386ã€‚
			If you are using x86 image, please switch to i386 architecture in the extra options.
	EOF
}
tmoe_qemu_faq() {
    RETURN_TO_WHERE='tmoe_qemu_faq'
    TMOE_VIRTUALIZATION=$(
        whiptail --title "FAQ(ã‚ˆãã‚ã‚‹è³ªå•)" --menu "æ‚¨æœ‰å“ªäº›ç–‘é—®ï¼Ÿ\nWhat questions do you have?" 13 55 3 \
            "1" "processè¿›ç¨‹ç®¡ç†è¯´æ˜" \
            "2" "create a new vmå¦‚ä½•æ–°å»ºè™šæ‹Ÿæœº" \
            "0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
            3>&1 1>&2 2>&3
    )
    #############
    case ${TMOE_VIRTUALIZATION} in
    0 | "") ${RETURN_TO_MENU} ;;
    1) qemu_process_management_instructions ;;
    2) how_to_create_a_new_tmoe_qemu_vm ;;
    esac
    ###############
    press_enter_to_return
    tmoe_qemu_faq
}
################
qemu_process_management_instructions() {
    CURRENT_VNC_PORT=$(grep "^VNC_PORT=" ${QEMU_FILE} | cut -d '=' -f 2)
    printf "%s\n" "è¾“startqemuå¯åŠ¨qemu"
    printf "%s\n" "${BLUE}è¿æ¥æ–¹å¼01${RESET}"
    printf "%s\n" "æ‰“å¼€vncå®¢æˆ·ç«¯ï¼Œè¾“å…¥è®¿é—®åœ°å€localhost:${CURRENT_VNC_PORT}"
    printf "%s\n" "${BLUE}å…³æœºæ–¹å¼01${RESET}"
    printf "%s\n" "åœ¨qemu monitorç•Œé¢ä¸‹è¾“system_powerdownå…³é—­è™šæ‹Ÿæœºç”µæºï¼Œè¾“stopåœæ­¢"
    printf "%s\n" "æŒ‰Ctrl+Cé€€å‡ºqemu monitor"
    printf "%s\n" "Press Ctrl+C to exit qemu monitor."
    printf "%s\n" "${BLUE}è¿æ¥æ–¹å¼02${RESET}"
    printf "%s\n" "è‹¥æ‚¨éœ€è¦ä½¿ç”¨sshè¿æ¥ï¼Œåˆ™è¯·æ–°å»ºä¸€ä¸ªtermuxä¼šè¯çª—å£ï¼Œå¹¶è¾“å…¥${GREEN}ssh -p 2888 root@localhost${RESET}"
    printf "%s\n" "æœ¬å·¥å…·é»˜è®¤å°†è™šæ‹Ÿæœºçš„22ç«¯å£æ˜ å°„ä¸ºå®¿ä¸»æœºçš„2888ç«¯å£ï¼Œè‹¥æ— æ³•è¿æ¥ï¼Œåˆ™è¯·åœ¨è™šæ‹Ÿæœºä¸‹æ–°å»ºä¸€ä¸ªæ™®é€šç”¨æˆ·ï¼Œå†å°†ä¸Šè¿°å‘½ä»¤ä¸­çš„rootä¿®æ”¹ä¸ºæ™®é€šç”¨æˆ·åç§°"
    printf "%s\n" "è‹¥è¿æ¥æç¤º${YELLOW}REMOTE HOST IDENTIFICATION HAS CHANGED${RESET}ï¼Œåˆ™è¯·æ‰‹åŠ¨è¾“${GREEN}ssh-keygen -f '/root/.ssh/known_hosts' -R '[localhost]:2888'${RESET}"
    printf "%s\n" "${BLUE}å…³æœºæ–¹å¼02${RESET}"
    printf "%s\n" "åœ¨linuxè™šæ‹Ÿæœºå†…è¾“poweroff"
    printf "%s\n" "åœ¨windowsè™šæ‹Ÿæœºå†…è¾“shutdown /s /t 0"
    printf "%s\n" "${BLUE}é‡å¯æ–¹å¼01${RESET}"
    printf "%s\n" "åœ¨linuxè™šæ‹Ÿæœºå†…è¾“reboot"
    printf "%s\n" "åœ¨windowsè™šæ‹Ÿæœºå†…è¾“shutdown /r /t 0"
}
#################
check_qemu_installation() {
    DEPENDENCY_01='qemu'
    DEPENDENCY_02=''
    if [ ! $(command -v qemu-system-x86_64) ]; then
        case "${LINUX_DISTRO}" in
        "debian")
            if grep -q 'VERSION_CODENAME=buster' /etc/os-release; then
                DEPENDENCY_01='-t buster-backports qemu qemu-system-x86'
            else
                DEPENDENCY_01='qemu qemu-system-x86'
            fi
            DEPENDENCY_02='qemu-system-gui'
            ;;
        "alpine")
            DEPENDENCY_01='qemu qemu-system-x86_64 qemu-system-i386'
            DEPENDENCY_02='qemu-system-aarch64'
            ;;
        "arch")
            DEPENDENCY_02='edk2-ovmf'
            ;;
        esac
        beta_features_quick_install
    fi
}
#############
#sed '$!N;$!P;$!D;s/\(\n\)/\n    -test \\ \n/' startqemu
#sed "s@$(cat startqemu | tail -n 1)@& \\\@" startqemu
modify_qemu_amd64_tmoe_cpu_type() {
    CURRENT_VALUE=$(grep '^CPU_MODEL=' ${QEMU_FILE} | head -n 1 | cut -d '=' -f 2)
    TMOE_VIRTUALIZATION=$(
        whiptail --title "CPU" --menu "é»˜è®¤ä¸ºmax,å½“å‰ä¸º${CURRENT_VALUE}" 0 0 0 \
            "0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
            "000" "default(é»˜è®¤,å¯ç”¨åŠ é€Ÿå™¨æ”¯æŒçš„æ‰€æœ‰å¯ç”¨åŠŸèƒ½)" \
            "001" "486:(alias configured by machine type)" \
            "002" "486-v1" \
            "003" "Broadwell:(alias configured by machine type)" \
            "004" "Broadwell-IBRS:(alias of Broadwell-v3)" \
            "005" "Broadwell-noTSX:(alias of Broadwell-v2)" \
            "006" "Broadwell-noTSX-IBRS:(alias of Broadwell-v4)" \
            "007" "Broadwell-v1:Intel Core Processor (Broadwell)" \
            "008" "Broadwell-v2:Intel Core Processor (Broadwell, no TSX)" \
            "009" "Broadwell-v3:Intel Core Processor (Broadwell, IBRS)" \
            "010" "Broadwell-v4:Intel Core Processor (Broadwell, no TSX, IBRS)" \
            "011" "Cascadelake-Server:(alias configured by machine type)" \
            "012" "Cascadelake-Server-noTSX:(alias of Cascadelake-Server-v3)" \
            "013" "Cascadelake-Server-v1:Intel Xeon Processor (Cascadelake)" \
            "014" "Cascadelake-Server-v2:Intel Xeon Processor (Cascadelake)" \
            "015" "Cascadelake-Server-v3:Intel Xeon Processor (Cascadelake)" \
            "016" "Conroe:(alias configured by machine type)" \
            "017" "Conroe-v1:Intel Celeron_4x0 (Conroe/Merom Class Core 2)" \
            "018" "Cooperlake:(alias configured by machine type)" \
            "019" "Cooperlake-v1:Intel Xeon Processor (Cooperlake)" \
            "020" "Denverton:(alias configured by machine type)" \
            "021" "Denverton-v1:Intel Atom Processor (Denverton)" \
            "022" "Denverton-v2:Intel Atom Processor (Denverton)" \
            "023" "Dhyana:(alias configured by machine type)" \
            "024" "Dhyana-v1:Hygon Dhyana Processor" \
            "025" "EPYC:(alias configured by machine type)" \
            "026" "EPYC-IBPB:(alias of EPYC-v2)" \
            "027" "EPYC-Rome:(alias configured by machine type)" \
            "028" "EPYC-Rome-v1:AMD EPYC-Rome Processor" \
            "029" "EPYC-v1:AMD EPYC Processor" \
            "030" "EPYC-v2:AMD EPYC Processor (with IBPB)" \
            "031" "EPYC-v3:AMD EPYC Processor" \
            "032" "Haswell:(alias configured by machine type)" \
            "033" "Haswell-IBRS:(alias of Haswell-v3)" \
            "034" "Haswell-noTSX:(alias of Haswell-v2)" \
            "035" "Haswell-noTSX-IBRS:(alias of Haswell-v4)" \
            "036" "Haswell-v1:Intel Core Processor (Haswell)" \
            "037" "Haswell-v2:Intel Core Processor (Haswell, no TSX)" \
            "038" "Haswell-v3:Intel Core Processor (Haswell, IBRS)" \
            "039" "Haswell-v4:Intel Core Processor (Haswell, no TSX, IBRS)" \
            "040" "Icelake-Client:(alias configured by machine type)" \
            "041" "Icelake-Client-noTSX:(alias of Icelake-Client-v2)" \
            "042" "Icelake-Client-v1:Intel Core Processor (Icelake)" \
            "043" "Icelake-Client-v2:Intel Core Processor (Icelake)" \
            "044" "Icelake-Server:(alias configured by machine type)" \
            "045" "Icelake-Server-noTSX:(alias of Icelake-Server-v2)" \
            "046" "Icelake-Server-v1:Intel Xeon Processor (Icelake)" \
            "047" "Icelake-Server-v2:Intel Xeon Processor (Icelake)" \
            "048" "Icelake-Server-v3:Intel Xeon Processor (Icelake)" \
            "049" "IvyBridge:(alias configured by machine type)" \
            "050" "IvyBridge-IBRS:(alias of IvyBridge-v2)" \
            "051" "IvyBridge-v1:Intel Xeon E3-12xx v2 (Ivy Bridge)" \
            "052" "IvyBridge-v2:Intel Xeon E3-12xx v2 (Ivy Bridge, IBRS)" \
            "053" "KnightsMill:(alias configured by machine type)" \
            "054" "KnightsMill-v1:Intel Xeon Phi Processor (Knights Mill)" \
            "055" "Nehalem:(alias configured by machine type)" \
            "056" "Nehalem-IBRS:(alias of Nehalem-v2)" \
            "057" "Nehalem-v1:Intel Core i7 9xx (Nehalem Class Core i7)" \
            "058" "Nehalem-v2:Intel Core i7 9xx (Nehalem Core i7, IBRS update)" \
            "059" "Opteron_G1:(alias configured by machine type)" \
            "060" "Opteron_G1-v1:AMD Opteron 240 (Gen 1 Class Opteron)" \
            "061" "Opteron_G2:(alias configured by machine type)" \
            "062" "Opteron_G2-v1:AMD Opteron 22xx (Gen 2 Class Opteron)" \
            "063" "Opteron_G3:(alias configured by machine type)" \
            "064" "Opteron_G3-v1:AMD Opteron 23xx (Gen 3 Class Opteron)" \
            "065" "Opteron_G4:(alias configured by machine type)" \
            "066" "Opteron_G4-v1:AMD Opteron 62xx class CPU" \
            "067" "Opteron_G5:(alias configured by machine type)" \
            "068" "Opteron_G5-v1:AMD Opteron 63xx class CPU" \
            "069" "Penryn:(alias configured by machine type)" \
            "070" "Penryn-v1:Intel Core 2 Duo P9xxx (Penryn Class Core 2)" \
            "071" "SandyBridge:(alias configured by machine type)" \
            "072" "SandyBridge-IBRS:(alias of SandyBridge-v2)" \
            "073" "SandyBridge-v1:Intel Xeon E312xx (Sandy Bridge)" \
            "074" "SandyBridge-v2:Intel Xeon E312xx (Sandy Bridge, IBRS update)" \
            "075" "Skylake-Client:(alias configured by machine type)" \
            "076" "Skylake-Client-IBRS:(alias of Skylake-Client-v2)" \
            "077" "Skylake-Client-noTSX-IBRS:BRS  (alias of Skylake-Client-v3)" \
            "078" "Skylake-Client-v1:Intel Core Processor (Skylake)" \
            "079" "Skylake-Client-v2:Intel Core Processor (Skylake, IBRS)" \
            "080" "Skylake-Client-v3:Intel Core Processor (Skylake, IBRS, no TSX)" \
            "081" "Skylake-Server:(alias configured by machine type)" \
            "082" "Skylake-Server-IBRS:(alias of Skylake-Server-v2)" \
            "083" "Skylake-Server-noTSX-IBRS:BRS  (alias of Skylake-Server-v3)" \
            "084" "Skylake-Server-v1:Intel Xeon Processor (Skylake)" \
            "085" "Skylake-Server-v2:Intel Xeon Processor (Skylake, IBRS)" \
            "086" "Skylake-Server-v3:Intel Xeon Processor (Skylake, IBRS, no TSX)" \
            "087" "Snowridge:(alias configured by machine type)" \
            "088" "Snowridge-v1:Intel Atom Processor (SnowRidge)" \
            "089" "Snowridge-v2:Intel Atom Processor (Snowridge, no MPX)" \
            "090" "Westmere:(alias configured by machine type)" \
            "091" "Westmere-IBRS:(alias of Westmere-v2)" \
            "092" "Westmere-v1:Westmere E56xx/L56xx/X56xx (Nehalem-C)" \
            "093" "Westmere-v2:Westmere E56xx/L56xx/X56xx (IBRS update)" \
            "094" "athlon:(alias configured by machine type)" \
            "095" "athlon-v1:QEMU Virtual CPU version 2.5+" \
            "096" "core2duo:(alias configured by machine type)" \
            "097" "core2duo-v1:Intel(R) Core(TM)2 Duo CPU     T7700  @ 2.40GHz" \
            "098" "coreduo:(alias configured by machine type)" \
            "099" "coreduo-v1:Genuine Intel(R) CPU           T2600  @ 2.16GHz" \
            "100" "kvm32:(alias configured by machine type)" \
            "101" "kvm32-v1:Common 32-bit KVM processor" \
            "102" "kvm64:(alias configured by machine type)" \
            "103" "kvm64-v1:Common KVM processor" \
            "104" "n270:(alias configured by machine type)" \
            "105" "n270-v1:Intel(R) Atom(TM) CPU N270   @ 1.60GHz" \
            "106" "pentium:(alias configured by machine type)" \
            "107" "pentium-v1" \
            "108" "pentium2:(alias configured by machine type)" \
            "109" "pentium2-v1" \
            "110" "pentium3:(alias configured by machine type)" \
            "111" "pentium3-v1" \
            "112" "phenom:(alias configured by machine type)" \
            "113" "phenom-v1:AMD Phenom(tm) 9550 Quad-Core Processor" \
            "114" "qemu32:(alias configured by machine type)" \
            "115" "qemu32-v1:QEMU Virtual CPU version 2.5+" \
            "116" "qemu64:(alias configured by machine type)" \
            "117" "qemu64-v1:QEMU Virtual CPU version 2.5+" \
            "118" "base:base CPU model type with no features enabled" \
            "119" "host:KVM processor with all supported host features" \
            "120" "max:Enables all features supported by the accelerator in the current host" \
            3>&1 1>&2 2>&3
    )
    #############
    case ${TMOE_VIRTUALIZATION} in
    0 | "") ${RETURN_TO_WHERE} ;;
    000) TMOE_AMD64_QEMU_CPU_TYPE="max" ;;
    001) TMOE_AMD64_QEMU_CPU_TYPE="486" ;;
    002) TMOE_AMD64_QEMU_CPU_TYPE="486-v1" ;;
    003) TMOE_AMD64_QEMU_CPU_TYPE="Broadwell" ;;
    004) TMOE_AMD64_QEMU_CPU_TYPE="Broadwell-IBRS" ;;
    005) TMOE_AMD64_QEMU_CPU_TYPE="Broadwell-noTSX" ;;
    006) TMOE_AMD64_QEMU_CPU_TYPE="Broadwell-noTSX-IBRS" ;;
    007) TMOE_AMD64_QEMU_CPU_TYPE="Broadwell-v1" ;;
    008) TMOE_AMD64_QEMU_CPU_TYPE="Broadwell-v2" ;;
    009) TMOE_AMD64_QEMU_CPU_TYPE="Broadwell-v3" ;;
    010) TMOE_AMD64_QEMU_CPU_TYPE="Broadwell-v4" ;;
    011) TMOE_AMD64_QEMU_CPU_TYPE="Cascadelake-Server" ;;
    012) TMOE_AMD64_QEMU_CPU_TYPE="Cascadelake-Server-noTSX" ;;
    013) TMOE_AMD64_QEMU_CPU_TYPE="Cascadelake-Server-v1" ;;
    014) TMOE_AMD64_QEMU_CPU_TYPE="Cascadelake-Server-v2" ;;
    015) TMOE_AMD64_QEMU_CPU_TYPE="Cascadelake-Server-v3" ;;
    016) TMOE_AMD64_QEMU_CPU_TYPE="Conroe" ;;
    017) TMOE_AMD64_QEMU_CPU_TYPE="Conroe-v1" ;;
    018) TMOE_AMD64_QEMU_CPU_TYPE="Cooperlake" ;;
    019) TMOE_AMD64_QEMU_CPU_TYPE="Cooperlake-v1" ;;
    020) TMOE_AMD64_QEMU_CPU_TYPE="Denverton" ;;
    021) TMOE_AMD64_QEMU_CPU_TYPE="Denverton-v1" ;;
    022) TMOE_AMD64_QEMU_CPU_TYPE="Denverton-v2" ;;
    023) TMOE_AMD64_QEMU_CPU_TYPE="Dhyana" ;;
    024) TMOE_AMD64_QEMU_CPU_TYPE="Dhyana-v1" ;;
    025) TMOE_AMD64_QEMU_CPU_TYPE="EPYC" ;;
    026) TMOE_AMD64_QEMU_CPU_TYPE="EPYC-IBPB" ;;
    027) TMOE_AMD64_QEMU_CPU_TYPE="EPYC-Rome" ;;
    028) TMOE_AMD64_QEMU_CPU_TYPE="EPYC-Rome-v1" ;;
    029) TMOE_AMD64_QEMU_CPU_TYPE="EPYC-v1" ;;
    030) TMOE_AMD64_QEMU_CPU_TYPE="EPYC-v2" ;;
    031) TMOE_AMD64_QEMU_CPU_TYPE="EPYC-v3" ;;
    032) TMOE_AMD64_QEMU_CPU_TYPE="Haswell" ;;
    033) TMOE_AMD64_QEMU_CPU_TYPE="Haswell-IBRS" ;;
    034) TMOE_AMD64_QEMU_CPU_TYPE="Haswell-noTSX" ;;
    035) TMOE_AMD64_QEMU_CPU_TYPE="Haswell-noTSX-IBRS" ;;
    036) TMOE_AMD64_QEMU_CPU_TYPE="Haswell-v1" ;;
    037) TMOE_AMD64_QEMU_CPU_TYPE="Haswell-v2" ;;
    038) TMOE_AMD64_QEMU_CPU_TYPE="Haswell-v3" ;;
    039) TMOE_AMD64_QEMU_CPU_TYPE="Haswell-v4" ;;
    040) TMOE_AMD64_QEMU_CPU_TYPE="Icelake-Client" ;;
    041) TMOE_AMD64_QEMU_CPU_TYPE="Icelake-Client-noTSX" ;;
    042) TMOE_AMD64_QEMU_CPU_TYPE="Icelake-Client-v1" ;;
    043) TMOE_AMD64_QEMU_CPU_TYPE="Icelake-Client-v2" ;;
    044) TMOE_AMD64_QEMU_CPU_TYPE="Icelake-Server" ;;
    045) TMOE_AMD64_QEMU_CPU_TYPE="Icelake-Server-noTSX" ;;
    046) TMOE_AMD64_QEMU_CPU_TYPE="Icelake-Server-v1" ;;
    047) TMOE_AMD64_QEMU_CPU_TYPE="Icelake-Server-v2" ;;
    048) TMOE_AMD64_QEMU_CPU_TYPE="Icelake-Server-v3" ;;
    049) TMOE_AMD64_QEMU_CPU_TYPE="IvyBridge" ;;
    050) TMOE_AMD64_QEMU_CPU_TYPE="IvyBridge-IBRS" ;;
    051) TMOE_AMD64_QEMU_CPU_TYPE="IvyBridge-v1" ;;
    052) TMOE_AMD64_QEMU_CPU_TYPE="IvyBridge-v2" ;;
    053) TMOE_AMD64_QEMU_CPU_TYPE="KnightsMill" ;;
    054) TMOE_AMD64_QEMU_CPU_TYPE="KnightsMill-v1" ;;
    055) TMOE_AMD64_QEMU_CPU_TYPE="Nehalem" ;;
    056) TMOE_AMD64_QEMU_CPU_TYPE="Nehalem-IBRS" ;;
    057) TMOE_AMD64_QEMU_CPU_TYPE="Nehalem-v1" ;;
    058) TMOE_AMD64_QEMU_CPU_TYPE="Nehalem-v2" ;;
    059) TMOE_AMD64_QEMU_CPU_TYPE="Opteron_G1" ;;
    060) TMOE_AMD64_QEMU_CPU_TYPE="Opteron_G1-v1" ;;
    061) TMOE_AMD64_QEMU_CPU_TYPE="Opteron_G2" ;;
    062) TMOE_AMD64_QEMU_CPU_TYPE="Opteron_G2-v1" ;;
    063) TMOE_AMD64_QEMU_CPU_TYPE="Opteron_G3" ;;
    064) TMOE_AMD64_QEMU_CPU_TYPE="Opteron_G3-v1" ;;
    065) TMOE_AMD64_QEMU_CPU_TYPE="Opteron_G4" ;;
    066) TMOE_AMD64_QEMU_CPU_TYPE="Opteron_G4-v1" ;;
    067) TMOE_AMD64_QEMU_CPU_TYPE="Opteron_G5" ;;
    068) TMOE_AMD64_QEMU_CPU_TYPE="Opteron_G5-v1" ;;
    069) TMOE_AMD64_QEMU_CPU_TYPE="Penryn" ;;
    070) TMOE_AMD64_QEMU_CPU_TYPE="Penryn-v1" ;;
    071) TMOE_AMD64_QEMU_CPU_TYPE="SandyBridge" ;;
    072) TMOE_AMD64_QEMU_CPU_TYPE="SandyBridge-IBRS" ;;
    073) TMOE_AMD64_QEMU_CPU_TYPE="SandyBridge-v1" ;;
    074) TMOE_AMD64_QEMU_CPU_TYPE="SandyBridge-v2" ;;
    075) TMOE_AMD64_QEMU_CPU_TYPE="Skylake-Client" ;;
    076) TMOE_AMD64_QEMU_CPU_TYPE="Skylake-Client-IBRS" ;;
    077) TMOE_AMD64_QEMU_CPU_TYPE="Skylake-Client-noTSX-IBRS" ;;
    078) TMOE_AMD64_QEMU_CPU_TYPE="Skylake-Client-v1" ;;
    079) TMOE_AMD64_QEMU_CPU_TYPE="Skylake-Client-v2" ;;
    080) TMOE_AMD64_QEMU_CPU_TYPE="Skylake-Client-v3" ;;
    081) TMOE_AMD64_QEMU_CPU_TYPE="Skylake-Server" ;;
    082) TMOE_AMD64_QEMU_CPU_TYPE="Skylake-Server-IBRS" ;;
    083) TMOE_AMD64_QEMU_CPU_TYPE="Skylake-Server-noTSX-IBRS" ;;
    084) TMOE_AMD64_QEMU_CPU_TYPE="Skylake-Server-v1" ;;
    085) TMOE_AMD64_QEMU_CPU_TYPE="Skylake-Server-v2" ;;
    086) TMOE_AMD64_QEMU_CPU_TYPE="Skylake-Server-v3" ;;
    087) TMOE_AMD64_QEMU_CPU_TYPE="Snowridge" ;;
    088) TMOE_AMD64_QEMU_CPU_TYPE="Snowridge-v1" ;;
    089) TMOE_AMD64_QEMU_CPU_TYPE="Snowridge-v2" ;;
    090) TMOE_AMD64_QEMU_CPU_TYPE="Westmere" ;;
    091) TMOE_AMD64_QEMU_CPU_TYPE="Westmere-IBRS" ;;
    092) TMOE_AMD64_QEMU_CPU_TYPE="Westmere-v1" ;;
    093) TMOE_AMD64_QEMU_CPU_TYPE="Westmere-v2" ;;
    094) TMOE_AMD64_QEMU_CPU_TYPE="athlon" ;;
    095) TMOE_AMD64_QEMU_CPU_TYPE="athlon-v1" ;;
    096) TMOE_AMD64_QEMU_CPU_TYPE="core2duo" ;;
    097) TMOE_AMD64_QEMU_CPU_TYPE="core2duo-v1" ;;
    098) TMOE_AMD64_QEMU_CPU_TYPE="coreduo" ;;
    099) TMOE_AMD64_QEMU_CPU_TYPE="coreduo-v1" ;;
    100) TMOE_AMD64_QEMU_CPU_TYPE="kvm32" ;;
    101) TMOE_AMD64_QEMU_CPU_TYPE="kvm32-v1" ;;
    102) TMOE_AMD64_QEMU_CPU_TYPE="kvm64" ;;
    103) TMOE_AMD64_QEMU_CPU_TYPE="kvm64-v1" ;;
    104) TMOE_AMD64_QEMU_CPU_TYPE="n270" ;;
    105) TMOE_AMD64_QEMU_CPU_TYPE="n270-v1" ;;
    106) TMOE_AMD64_QEMU_CPU_TYPE="pentium" ;;
    107) TMOE_AMD64_QEMU_CPU_TYPE="pentium-v1" ;;
    108) TMOE_AMD64_QEMU_CPU_TYPE="pentium2" ;;
    109) TMOE_AMD64_QEMU_CPU_TYPE="pentium2-v1" ;;
    110) TMOE_AMD64_QEMU_CPU_TYPE="pentium3" ;;
    111) TMOE_AMD64_QEMU_CPU_TYPE="pentium3-v1" ;;
    112) TMOE_AMD64_QEMU_CPU_TYPE="phenom" ;;
    113) TMOE_AMD64_QEMU_CPU_TYPE="phenom-v1" ;;
    114) TMOE_AMD64_QEMU_CPU_TYPE="qemu32" ;;
    115) TMOE_AMD64_QEMU_CPU_TYPE="qemu32-v1" ;;
    116) TMOE_AMD64_QEMU_CPU_TYPE="qemu64" ;;
    117) TMOE_AMD64_QEMU_CPU_TYPE="qemu64-v1" ;;
    118) TMOE_AMD64_QEMU_CPU_TYPE="base" ;;
    119) TMOE_AMD64_QEMU_CPU_TYPE="host" ;;
    120) TMOE_AMD64_QEMU_CPU_TYPE="max" ;;
    esac
    ###############
    sed -E -i "s@^(CPU_MODEL=).*@\1${TMOE_AMD64_QEMU_CPU_TYPE}@g" ${QEMU_FILE}
    grep -E --color=auto "^CPU_MODEL=" ${QEMU_FILE}
    printf "%s\n" "æ‚¨å·²å°†cpuä¿®æ”¹ä¸º${TMOE_AMD64_QEMU_CPU_TYPE}"
    printf "%s\n" "ä¿®æ”¹å®Œæˆï¼Œå°†åœ¨ä¸‹æ¬¡å¯åŠ¨qemuè™šæ‹Ÿæœºæ—¶ç”Ÿæ•ˆ"
    press_enter_to_return
    ${RETURN_TO_WHERE}
}
############
tmoe_qemu_main "$@"
###############################
