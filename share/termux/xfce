#!/usr/bin/env bash
#######################################
tmoe_install_xfce() {
	if [ "${LINUX_DISTRO}" != 'Android' ]; then
		aria2c --allow-overwrite=true -d /tmp -o '.tmoe-linux-tool.sh' 'https://raw.githubusercontent.com/2moe/tmoe-linux/master/tool.sh'
		bash /tmp/.tmoe-linux-tool.sh --install-gui
		exit 0
	fi

	if [ -e "${PREFIX}/bin/xfwm4" ]; then
		printf "%s\n" "æ£€æµ‹åˆ°æ‚¨å·²å®‰è£…ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ"
		printf '%s\n' 'Press enter to continue'
		printf "%s\n" "${YELLOW}æŒ‰å›è½¦é”®ç¡®è®¤ç»§ç»­,æŒ‰Ctrl+Cå–æ¶ˆã€‚${RESET}"
		read
	fi
	apt update
	apt install -y x11-repo
	apt update
	apt dist-upgrade -y

	apt install -y xfce tigervnc aterm
	cat >${PREFIX}/bin/startvnc <<-'EndOfFile'
		#!/usr/bin/env bash
		pkill Xvnc 2>/dev/null 
		pulseaudio --kill 2>/dev/null
		pulseaudio --start
		printf "%s\n" "æ­£åœ¨å¯åŠ¨vncæœåŠ¡,æœ¬æœºé»˜è®¤vncåœ°å€localhost:5901"
		echo The LAN VNC address å±€åŸŸç½‘åœ°å€ $(ip -4 -br -c a | tail -n 1 | cut -d '/' -f 1 | cut -d 'P' -f 2):5901
		export DISPLAY=:1
		Xvnc -geometry 720x1440 -depth 24 --SecurityTypes=None $DISPLAY &
		export PULSE_SERVER=127.0.0.1
		am start -n com.realvnc.viewer.android/com.realvnc.viewer.android.app.ConnectionChooserActivity
		sleep 1s
		thunar &
		printf "%s\n" "å·²ä¸ºæ‚¨å¯åŠ¨vncæœåŠ¡ Vnc server has been started, enjoy it!"
		printf "%s\n" "é»˜è®¤ä¸ºå‰å°è¿è¡Œï¼Œæ‚¨å¯ä»¥æŒ‰Ctrl+Cç»ˆæ­¢å½“å‰è¿›ç¨‹ã€‚"
		startxfce4

	EndOfFile
	termux-fix-shebang ${PREFIX}/bin/startvnc
	chmod +x ${PREFIX}/bin/startvnc
	source ${PREFIX}/bin/startvnc
}
##########
tmoe_modify_vnc_conf() {
	if [ "${LINUX_DISTRO}" != 'Android' ]; then
		aria2c --allow-overwrite=true -d /tmp -o '.tmoe-linux-tool.sh' 'https://raw.githubusercontent.com/2moe/tmoe-linux/master/tool.sh'
		bash /tmp/.tmoe-linux-tool.sh --modify_remote_desktop_config
		exit 0
	fi
	modify_android_termux_vnc_config
}
#########
termux_original_system_gui_menu() {
	RETURN_TO_WHERE='termux_original_system_gui_menu'
	termux_original_system_gui_menu_en() {
		OPTION=$(whiptail --title "Termux" --menu "Termux native GUI has fewer software packages.It is recommended that you install a container." 0 50 0 \
			"1" "modify termux-vnc conf" \
			"2" "ğŸ¹ install termux-xfce4" \
			"3" "ğŸ’” remove xfce4" \
			"0" "ğŸŒš Return to previous menu" \
			3>&1 1>&2 2>&3)
	}
	termux_original_system_gui_menu_cn() {
		#\nè¿™é‡Œæ˜¯termuxåŸç³»ç»Ÿçš„é…ç½®åŒºåŸŸ,ä¸æ˜¯GNU/Linuxå®¹å™¨çš„å“¦ï¼\nThe following options only apply to termux original system.
		OPTION=$(whiptail --title "Termux" --menu "TermuxåŸç³»ç»ŸGUIå¯ç©æ€§è¾ƒä½,å»ºè®®æ‚¨å®‰è£…GNU/Linux(proot/chroot)å®¹å™¨" 0 50 0 \
			"1" "modify termux-vnc conf" \
			"2" "ğŸ¹ install termux-xfce4" \
			"3" "ğŸ’” remove xfce4" \
			"0" "ğŸŒš Return è¿”å›ä¸Šçº§èœå•" \
			3>&1 1>&2 2>&3)
	}
	case ${TMOE_MENU_LANG} in
	zh_*UTF-8) termux_original_system_gui_menu_cn ;;
	*) termux_original_system_gui_menu_en ;;
	esac
	#####################################
	case "${OPTION}" in
	0 | "") android_termux_tmoe_menu ;;
	1) tmoe_modify_vnc_conf ;;
	2) tmoe_install_xfce ;;
	3) tmoe_remove_xfce ;;
	esac
	####################################
	press_enter_to_return
	termux_original_system_gui_menu
}
###############
tmoe_remove_xfce() {
	if [ "${LINUX_DISTRO}" != 'Android' ]; then
		aria2c --allow-overwrite=true -d /tmp -o '.tmoe-linux-tool.sh' 'https://raw.githubusercontent.com/2moe/tmoe-linux/master/tool.sh'
		bash /tmp/.tmoe-linux-tool.sh --remove_gui
		exit 0
	fi
	remove_android_termux_xfce
}
##########I
modify_android_termux_vnc_config() {
	if [ ! -e ${PREFIX}/bin/startvnc ]; then
		printf "%s\n" "${PREFIX}/bin/startvnc is not detected, maybe you have not installed the graphical desktop environment, do you want to continue editing?"
		printf '%s\n' 'æœªæ£€æµ‹åˆ°startvnc,æ‚¨å¯èƒ½å°šæœªå®‰è£…å›¾å½¢æ¡Œé¢ï¼Œæ˜¯å¦ç»§ç»­ç¼–è¾‘?'
		printf "%s\n" "Press Enter to confirm."
		printf "%s\n" "${YELLOW}æŒ‰å›è½¦é”®ç¡®è®¤ç¼–è¾‘ã€‚${RESET}"
		read
	fi
	CURRENTTERMUXVNCRES=$(sed -n 7p "$(command -v startvnc)" | cut -d 'y' -f 2 | cut -d '-' -f 1)
	if (whiptail --title "modify vnc configuration" --yes-button 'åˆ†è¾¨ç‡resolution' --no-button 'å…¶å®ƒother' --yesno "æ‚¨æƒ³è¦ä¿®æ”¹å“ªé¡¹é…ç½®ä¿¡æ¯ï¼ŸWhich configuration do you want to modify?" 9 50); then
		if grep -q 'debian_' "$(command -v startvnc)"; then
			printf "%s\n" "æ‚¨å½“å‰ä½¿ç”¨çš„startvncé…ç½®ä¸ºLinuxå®¹å™¨ç³»ç»Ÿä¸“ç”¨ç‰ˆï¼Œè¯·è¾“debianè¿›å…¥å®¹å™¨åå†è¾“debian-iä¿®æ”¹"
			printf "%s\n" "æœ¬é€‰é¡¹ä»…é€‚ç”¨äºtermuxåŸç³»ç»Ÿã€‚"
			press_enter_to_return
			tmoe_manager_main_menu
		fi
		TARGET=$(whiptail --inputbox "Please enter a resolution,è¯·è¾“å…¥åˆ†è¾¨ç‡,ä¾‹å¦‚2880x1440,2400x1200,1920x1080,1920x960,1440x720,1280x1024,1280x960,1280x720,1024x768,800x680ç­‰ç­‰,é»˜è®¤ä¸º720x1440,å½“å‰ä¸º${CURRENTTERMUXVNCRES}ã€‚åˆ†è¾¨ç‡å¯è‡ªå®šä¹‰ï¼Œä½†å»ºè®®æ‚¨æ ¹æ®å±å¹•æ¯”ä¾‹æ¥è°ƒæ•´ï¼Œè¾“å…¥å®ŒæˆåæŒ‰å›è½¦é”®ç¡®è®¤ï¼Œä¿®æ”¹å®Œæˆåå°†è‡ªåŠ¨åœæ­¢VNCæœåŠ¡ã€‚æ³¨æ„ï¼šxä¸ºè‹±æ–‡å°å†™ï¼Œä¸æ˜¯ä¹˜å·ã€‚Press Enter after the input is completed." 16 50 --title "è¯·åœ¨æ–¹æ¡†å†…è¾“å…¥ æ°´å¹³åƒç´ xå‚ç›´åƒç´  (æ•°å­—xæ•°å­—) " 3>&1 1>&2 2>&3)
		#æ­¤å¤„termuxçš„whiptailè·Ÿdebianä¸åŒï¼Œå¿…é¡»æˆªå–Errorå‰çš„å­—ç¬¦ã€‚
		#TRUETARGET="$(printf '%s\n' ${TARGET} | cut -d 'E' -f 1)"
		TRUETARGET="$(printf '%s\n' ${TARGET} | head -n 1 | cut -d ' ' -f 1)"
		#ä¸‹é¢é‚£æ¡å˜é‡TRUETARGETTARGETå‰åŠ ç©ºæ ¼
		#sed -i "s#${CURRENTTERMUXVNCRES}# ${TRUETARGETTARGET}#" "$(command -v startvnc)"
		sed -i "7 c Xvnc -geometry ${TRUETARGET} -depth 24 --SecurityTypes=None \$DISPLAY \&" "$(command -v startvnc)"
		printf '%s\n' 'Your current resolution has been modified.'
		printf '%s\n' 'æ‚¨å½“å‰çš„åˆ†è¾¨ç‡å·²ç»ä¿®æ”¹ä¸º'
		printf "%s\n" "$(sed -n 7p "$(command -v startvnc)" | cut -d 'y' -f 2 | cut -d '-' -f 1)"
	else
		printf '%s\n' 'æ‚¨å¯ä»¥æ‰‹åŠ¨ä¿®æ”¹vncçš„é…ç½®ä¿¡æ¯'
		printf '%s\n' 'If you want to modify the resolution, please change the 720x1440 (default resolution , vertical screen) to another resolution, such as 1920x1080 (landscape).'
		printf '%s\n' 'è‹¥æ‚¨æƒ³è¦ä¿®æ”¹åˆ†è¾¨ç‡ï¼Œè¯·å°†é»˜è®¤çš„720x1440ï¼ˆç«–å±ï¼‰æ”¹ä¸ºå…¶å®ƒæ‚¨æƒ³è¦çš„åˆ†è¾¨ç‡ï¼Œä¾‹å¦‚1920x1080ï¼ˆæ¨ªå±ï¼‰ã€‚'
		printf "%s\n" "æ‚¨å½“å‰åˆ†è¾¨ç‡ä¸º${CURRENTTERMUXVNCRES}"
		printf '%s\n' 'æ”¹å®ŒåæŒ‰Ctrl+Sä¿å­˜ï¼ŒCtrl+Xé€€å‡ºã€‚'
		printf "%s\n" "Press Enter to confirm."
		printf "%s\n" "${YELLOW}æŒ‰å›è½¦é”®ç¡®è®¤ç¼–è¾‘ã€‚${RESET}"
		read
		nano ${PREFIX}/bin/startvnc || nano $(command -v startvnc)
		printf "%s\n" "æ‚¨å½“å‰åˆ†è¾¨ç‡ä¸º$(sed -n 7p "$(command -v startvnc)" | cut -d 'y' -f 2 | cut -d '-' -f 1)"
	fi
	press_enter_to_return
	tmoe_manager_main_menu
}
###############
remove_android_termux_xfce() {
	do_you_want_to_continue
	apt purge -y ^xfce tigervnc aterm
	apt purge -y x11-repo
	apt autoremove
	press_enter_to_return
	tmoe_manager_main_menu
}
#################
termux_original_system_gui_menu $@
