#!/usr/bin/env bash
#######################################
backup_filename() {
	TARGET_BACKUP_FILE_NAME=$(whiptail --inputbox "è¯·è‡ªå®šä¹‰å¤‡ä»½çš„æ–‡ä»¶åç§°\nPlease type the filename." 9 50 --title "FILENAME" 3>&1 1>&2 2>&3)
	TARGET_BACKUP_FILE_NAME=$(printf "%s\n" "${TARGET_BACKUP_FILE_NAME}" | head -n 1 | cut -d ' ' -f 1)
	printf '%s\n' "${TARGET_BACKUP_FILE_NAME}"
	if [ -z ${TARGET_BACKUP_FILE_NAME} ]; then
		printf "%s\n" "æ–‡ä»¶åç§°ä¸èƒ½ä¸ºç©ºï¼"
		press_enter_to_return
		backup_termux_system
	fi
}
######################
backup_termux_system() {
	source ${TMOE_SHARE_DIR}/removal/umount
	RETURN_TO_WHERE='backup_termux_system'
	OPTION=$(whiptail --title "Backup System" --menu "Choose your option" 0 50 0 \
		"0" "ğŸŒš Back è¿”å›" \
		"1" "å¤‡ä»½Termux" \
		"2" "ä½¿ç”¨Timeshiftå¤‡ä»½å®¿ä¸»æœºç³»ç»Ÿ" \
		3>&1 1>&2 2>&3)
	#########################################
	case "${OPTION}" in
	0 | "") android_termux_tmoe_menu ;;
	1) backup_termux ;;
	2) install_timeshift ;;
	esac
	####################
	press_enter_to_return
	backup_termux_system
}
####################
install_timeshift() {
	if [ "${LINUX_DISTRO}" = "Android" ]; then
		printf "%s\n" 'Sorry,æœ¬åŠŸèƒ½ä¸æ”¯æŒAndroidç³»ç»Ÿ'
		press_enter_to_return
		tmoe_manager_main_menu
	fi
	if [ ! -e "/usr/bin/timeshift" ]; then
		case "${LINUX_DISTRO}" in
		"debian")
			apt update
			apt install -y timeshift
			;;
		"arch") pacman -Syu --noconfirm timeshift ;;
		"redhat") dnf install timeshift ;;
		*) ${TMOE_INSTALLATION_COMMAND} timeshift ;;
		esac
	fi

	if [ -e "/usr/bin/timeshift" ]; then
		timeshift-launcher &
		printf "%s\n" "å®‰è£…å®Œæˆï¼Œå¦‚éœ€å¸è½½ï¼Œè¯·æ‰‹åŠ¨è¾“${TMOE_REMOVAL_COMMAND} timeshift"
	fi
}
######################
termux_backup_pre() {
	if [ ! -d /sdcard/Download/backup ]; then
		mkdir -p /sdcard/Download/backup
	fi
	cd /sdcard/Download/backup
	backup_filename
	BACKUP_TIME=$(date +%Y-%m-%d_%H-%M)
}
####################
backup_termux() {
	#15 60 4
	backup_termux_menu_en() {
		TERMUX_BACKUP=$(whiptail --title "multiple choices" --checklist \
			"Which directory do you want to backup? \nPress space key to select and press Enter to confirm." 0 0 0 \
			"home" "Termux Home dir, mainly used to save user files" ON \
			"usr" "Save software,commands,and other things" OFF \
			3>&1 1>&2 2>&3)
	}
	backup_termux_menu_cn() {
		TERMUX_BACKUP=$(whiptail --title "å¤šé¡¹é€‰æ‹©é¢˜" --checklist \
			"æ‚¨æƒ³è¦å¤‡ä»½å“ªä¸ªç›®å½•ï¼ŸæŒ‰ç©ºæ ¼é”®é€‰æ‹©ï¼Œ*ä¸ºé€‰ä¸­çŠ¶æ€ï¼Œå›è½¦é”®ç¡®è®¤ã€‚" 0 0 0 \
			"home" "Termuxä¸»ç›®å½•,ä¸»è¦ç”¨æ¥ä¿å­˜ç”¨æˆ·æ–‡ä»¶" ON \
			"usr" "ä¿å­˜è½¯ä»¶ã€å‘½ä»¤å’Œå…¶å®ƒä¸œè¥¿" OFF \
			3>&1 1>&2 2>&3)
	}
	case ${TMOE_MENU_LANG} in
	zh_*UTF-8) backup_termux_menu_cn ;;
	*) backup_termux_menu_en ;;
	esac
	case ${TERMUX_BACKUP} in
	"") backup_termux_system ;;
	home) TERMUX_BACKUP_DIR="${HOME}" ;;
	usr) TERMUX_BACKUP_DIR="${PREFIX}" ;;
	*) TERMUX_BACKUP_DIR="${HOME} ${PREFIX}" ;;
	esac
	printf "%s\n" "${TERMUX_BACKUP}"
	########################
	termux_backup_pre
	TERMUX_TAR_FILE_NAME="${TARGET_BACKUP_FILE_NAME}_${BACKUP_TIME}-termux_bak"
	if (whiptail --title "Select compression type é€‰æ‹©å‹ç¼©ç±»å‹ " --yes-button "tar.xz" --no-button "tar.gz" --yesno "Which do yo like better? \n tar.xzå‹ç¼©ç‡é«˜ï¼Œä½†é€Ÿåº¦æ…¢ã€‚tar.xz has a higher compression ration, but is slower.\n tar.gzé€Ÿåº¦å¿«,ä½†å‹ç¼©ç‡ä½ã€‚tar.gz compresses faster, but with a lower compression ratio.\n å‹ç¼©è¿‡ç¨‹ä¸­ï¼Œè¿›åº¦æ¡å€’ç€è·‘æ˜¯æ­£å¸¸ç°è±¡ã€‚" 10 60); then
		cat <<-EOF
			æ‚¨é€‰æ‹©äº†tar.gz,å³å°†ä¸ºæ‚¨å¤‡ä»½è‡³/sdcard/Download/backup/${TERMUX_TAR_FILE_NAME}.tar.gz
			ä»¥ä¸‹ç›®å½•å°†è¢«å¤‡ä»½:
			${BLUE}${TERMUX_BACKUP_DIR}
			${YELLOW}æŒ‰å›è½¦é”®å¼€å§‹å¤‡ä»½,press Enter to start the backup.${RESET}
		EOF
		do_you_want_to_continue
		tar -PJpvcf ${TERMUX_TAR_FILE_NAME}.tar.xz --exclude=${TMOE_SHARE_DIR}/containers ${TERMUX_BACKUP_DIR}
		#xz -z -T0 -e -9 -v ${TERMUX_TAR_FILE_NAME}.tar
		#${DEBIAN_CHROOT}/root/sd --exclude=${DEBIAN_CHROOT}/root/termux --exclude=${DEBIAN_CHROOT}/root/tf
		printf "%s\n" "Don't worry too much, it is normal for some directories to backup without permission."
		printf "%s\n" "éƒ¨åˆ†ç›®å½•æ— æƒé™å¤‡ä»½æ˜¯æ­£å¸¸ç°è±¡ã€‚"
		pwd
		ls -lth ./*termux_home*tar* | grep ^- | head -n 1
		printf "%s ${GREEN}%s${RESET}\n" Backup complete.
	else
		cat <<-EOF
			æ‚¨é€‰æ‹©äº†tar.gz,å³å°†ä¸ºæ‚¨å¤‡ä»½è‡³/sdcard/Download/backup/${TERMUX_TAR_FILE_NAME}.tar.gz
			ä»¥ä¸‹ç›®å½•å°†è¢«å¤‡ä»½:
			${BLUE}${TERMUX_BACKUP_DIR}
			${YELLOW}æŒ‰å›è½¦é”®å¼€å§‹å¤‡ä»½,press Enter to start the backup.${RESET}
		EOF
		do_you_want_to_continue

		tar -Ppvczf ${TERMUX_TAR_FILE_NAME}.tar.gz --exclude=${TMOE_SHARE_DIR}/containers ${TERMUX_BACKUP_DIR}

		printf "%s\n" "Don't worry too much, it is normal for some directories to backup without permission."
		printf "%s\n" "éƒ¨åˆ†ç›®å½•æ— æƒé™å¤‡ä»½æ˜¯æ­£å¸¸ç°è±¡ã€‚"
		pwd
		ls -lth ./*termux_bak*tar* | grep ^- | head -n 1
		printf "%s ${GREEN}%s${RESET}\n" Backup complete.
	fi
}
##################################
backup_termux_system
