#!/usr/bin/env bash
#######################################
backup_filename() {
	TARGET_BACKUP_FILE_NAME=$(whiptail --inputbox "è¯·è‡ªå®šä¹‰å¤‡ä»½çš„æ–‡ä»¶åç§°,è‹¥ç•™ç©º\nåˆ™å°†è‡ªåŠ¨å‘½åä¸º${DEBIAN_FOLDER}\nPlease type the filename." 10 50 --title "FILENAME" 3>&1 1>&2 2>&3)
	TARGET_BACKUP_FILE_NAME="$(printf '%s\n' "${TARGET_BACKUP_FILE_NAME}" | head -n 1 | cut -d ' ' -f 1)"
	printf "%s\n" "${TARGET_BACKUP_FILE_NAME}"
	if [ -z ${TARGET_BACKUP_FILE_NAME} ]; then
		#printf "%s\n" "æ–‡ä»¶åç§°ä¸èƒ½ä¸ºç©ºï¼"
		printf "%s\n" "The file name is ${RED}empty${RESET}."
		#return 1
		#press_enter_to_return
		#backup_system
		TARGET_BACKUP_FILE_NAME="${DEBIAN_FOLDER}"
	fi
}
######################
backup_tmoe_container_preconfigure() {
	[[ -d ${CONTAINER_BACKUP_PATH} ]] || mkdir -p ${CONTAINER_BACKUP_PATH}
	cd ${CONTAINER_BACKUP_PATH}
	backup_filename
	BACKUP_TIME_TMP=$(date +%Y-%m-%d_%H-%M)
}
#####################
backup_gnu_linux_container_to_external_tf() {
	if [ -h "${HOME}/storage/external-1" ]; then
		BACKUP_PATH="$(readlink ${HOME}/storage/external-1)/Download/backup/containers"
		printf "%s\n" "${RED}å¸è½½æˆ–æ¸…é™¤${RESET}termuxå°†æœ‰å¯èƒ½åŒæ—¶æ¸…ç©º${BLUE}${BACKUP_PATH}${RESET}"
		printf "%s\n" "${RED}Uninstalling${RESET} TERMUX will also clear the ${BLUE}${BACKUP_PATH}${RESET}."
		press_enter_to_continue
	else
		printf "%s\n" "${HOME}/storage/external-1éè½¯é“¾æ¥ï¼Œæ— æ³•ä¿å­˜è‡³è¯¥ç›®å½•,å°†è‡ªåŠ¨åˆ‡æ¢ä¸ºå†…ç½®å­˜å‚¨è®¾å¤‡ã€‚"
		check_container_backup_path
	fi
	case_backup_path_proot_or_chroot
	backup_gnu_linux_container
}
#####################
backup_system() {
	#check_zstd
	RETURN_TO_WHERE='backup_system'
	backup_system_menu_en() {
		OPTION=$(whiptail --title "BACKUP ${DEBIAN_FOLDER_CAPITAL}" --menu "Do you want to backup the container?(à¹‘Â´Ú¡\`à¹‘)" 0 50 0 \
			"1" "Clean up garbage and private data" \
			"2" "Backup ${DEBIAN_FOLDER} container" \
			"3" "Backup container to sd/tf card (only for termux)" \
			"0" "ğŸŒš Return to previous menu" \
			3>&1 1>&2 2>&3)
	}
	backup_system_menu_cn() {
		OPTION=$(whiptail --title "BACKUP ${DEBIAN_FOLDER_CAPITAL}" --menu "æ‚¨æƒ³è¦å¤‡ä»½${DEBIAN_FOLDER}å®¹å™¨æ•°æ®ä¹ˆï¼Ÿ(à¹‘Â´Ú¡\`à¹‘)" 0 50 0 \
			"1" "æ¸…ç†${DEBIAN_FOLDER}å®¹å™¨åƒåœ¾å’Œéšç§æ•°æ®" \
			"2" "å¤‡ä»½${DEBIAN_FOLDER} prootå®¹å™¨" \
			"3" "å¤‡ä»½å®¹å™¨è‡³å¤–ç½®sd/tf(ä»…é™termux)" \
			"0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
			3>&1 1>&2 2>&3)
	}
	case ${TMOE_MENU_LANG} in
	zh_*UTF-8) backup_system_menu_cn ;;
	*) backup_system_menu_en ;;
	esac
	#########################################
	case "${OPTION}" in
	0 | "") proot_management_menu ;;
	1) clean_up_container_garbage ;;
	2)
		check_container_backup_path
		backup_gnu_linux_container
		;;
	3) backup_gnu_linux_container_to_external_tf ;;
	esac
	####################
	press_enter_to_return
	backup_system
}
###########################
clean_up_container_garbage() {
	if [ -e "${DEBIAN_CHROOT}" ]; then
		cd ${DEBIAN_CHROOT}
	else
		printf "%s\n" "æœªæ£€æµ‹åˆ°å®¹å™¨ç›®å½•ï¼Œæ— æ³•æ¸…ç†åƒåœ¾æ–‡ä»¶ã€‚"
		press_enter_to_return
		backup_system
	fi
	CONTAINER_GARBAGE_FILES='tmp/.* tmp/* root/.cache root/.ICEauthority root/.Xauthority root/.bash_history root/.pki root/.chord root/.cocomusic.json root/.dbus root/.gnupg root/.gridea root/.l2s..ICEauthority* root/.l2s..Xauthority* root/.mozilla root/.petal.db root/.vnc/passwd root/.vnc/x11passwd root/.vnc/localhost* root/.config/Electron root/.config/Netron root/.config/chord root/.config/electron-netease-cloud-music root/.config/go-for-it root/.config/gridea root/.config/listen1 root/.config/lx-music-desktop root/.config/neofetch root/.config/netease-cloud-music-gtk root/.config/pulse root/.config/tenvideo_universal root/.xfce4-session.verbose-log root/.xfce4-session.verbose-log.last root/.zcompdump-localhost* root/.z root/.zsh_history'
	CONTAINER_GARBAGE_FILES_02='var/cache/apt/archives/* \
var/cache/apt/* \
var/mail/* \
var/log/* \
var/log/apt/* \
var/log/journal/* \
var/lib/apt/lists/*'
	#ä¸è¦åˆ é™¤å®¹å™¨çš„dev/* \

	if [ -e "root/.vnc/passwd" ]; then
		ls -lah ${CONTAINER_GARBAGE_FILES} 2>/dev/null
	fi
	printf "${BOLD}${YELLOW}%s${RESET}${RESET}\n" "${DEBIAN_CHROOT}"
	printf "%s\n" "${RED}rm -rvf${RESET} ${BLUE}${CONTAINER_GARBAGE_FILES}${RESET}"
	printf "%s\n" "${RED}rm -fv${RESET} ${BLUE}${CONTAINER_GARBAGE_FILES_02}${RESET}"
	cat <<-EOF
		è‹¥æ‚¨éœ€è¦å°†å®¹å™¨åˆ†äº«ç»™ä»–äººï¼Œåˆ™å¯ä»¥åˆ é™¤ä»¥ä¸Šæ–‡ä»¶ï¼Œå¦åˆ™è¯·å‹¿æ‰§è¡Œæ¸…ç†æ“ä½œã€‚
		è‹¥æ‚¨ä½¿ç”¨çš„æ˜¯debç³»åˆ—å‘è¡Œç‰ˆï¼Œåˆ™åœ¨æ¸…ç†å‰ï¼Œå¯ä»¥åœ¨å®¹å™¨å†…ä»¥sudoæˆ–rootæƒé™æ‰§è¡Œ${GREEN}apt clean;apt autoclean;apt autopurge || apt autoremove${RESET}
		å¼€å‘è€…ä¸å¯¹è¯¯åˆ é™¤çš„æ–‡ä»¶è´Ÿè´£ï¼Œè¯·åœ¨æ¸…ç†å‰ç¡®ä¿ä»¥ä¸Šåˆ—è¡¨ä¸­æ— é‡è¦æ–‡ä»¶ï¼Œå¦åˆ™è¯·è¾“n
		If you want to share the container with others, you can delete the above files, otherwise, please type n to return.
	EOF
	do_you_want_to_continue
	${TMOE_PREFIX} rm -rvf ${CONTAINER_GARBAGE_FILES}
	${TMOE_PREFIX} rm -fv ${CONTAINER_GARBAGE_FILES_02}
}
#############
backup_gnu_linux_container() {
	backup_tmoe_container_preconfigure
	case ${TMOE_CHROOT} in
	true) CONTAINER_BACKUP_FILE_NAME="${TARGET_BACKUP_FILE_NAME}_${BACKUP_TIME_TMP}_chroot-rootfs_bak" ;;
	*) CONTAINER_BACKUP_FILE_NAME="${TARGET_BACKUP_FILE_NAME}_${BACKUP_TIME_TMP}-rootfs_bak" ;;
	esac
	BACKUP_FOLDER="${DEBIAN_CHROOT}"
	#çµ•å°è·¯å¾‘ã€‚ä¸”ä¸åŒ…å«tmoe,debian-iå’ŒGIT_DIR
	#${ACROSS_ARCH_FILE} ${LINUX_CONTAINER_DISTRO_FILE}
	for i in ${PREFIX}/bin/tmoe ${PREFIX}/bin/startxsdl ${PREFIX}/bin/startvnc ${PREFIX}/bin/debian ${PREFIX}/bin/stopvnc ${PREFIX}/bin/startx11vnc ${CONFIG_FOLDER} ${HOME}/å®¹å™¨é€‰æ‹©èœå•.sh ${HOME}/å¤©èŒ-ã‚³ãƒ³ãƒ†ãƒŠ-ãƒ¡ãƒ‹ãƒ¥ãƒ¼.sh ${HOME}/TMOE-CONTAINER-MENU.sh; do
		[[ ! -e ${i} ]] || BACKUP_FOLDER="${BACKUP_FOLDER} ${i}"
	done

	case ${LINUX_DISTRO} in
	Android) QEMU_PREFIX=${PREFIX}/bin ;;
	*) QEMU_PREFIX=/usr/bin ;;
	esac

	for i in ${QEMU_PREFIX}/qemu-aarch64_be-static ${QEMU_PREFIX}/qemu-aarch64-static ${QEMU_PREFIX}/qemu-alpha-static ${QEMU_PREFIX}/qemu-armeb-static ${QEMU_PREFIX}/qemu-arm-static ${QEMU_PREFIX}/qemu-cris-static ${QEMU_PREFIX}/qemu-hppa-static ${QEMU_PREFIX}/qemu-i386-static ${QEMU_PREFIX}/qemu-m68k-static ${QEMU_PREFIX}/qemu-microblazeel-static ${QEMU_PREFIX}/qemu-microblaze-static ${QEMU_PREFIX}/qemu-mips64el-static ${QEMU_PREFIX}/qemu-mips64-static ${QEMU_PREFIX}/qemu-mipsel-static ${QEMU_PREFIX}/qemu-mipsn32el-static ${QEMU_PREFIX}/qemu-mipsn32-static ${QEMU_PREFIX}/qemu-mips-static ${QEMU_PREFIX}/qemu-nios2-static ${QEMU_PREFIX}/qemu-or1k-static ${QEMU_PREFIX}/qemu-ppc64abi32-static ${QEMU_PREFIX}/qemu-ppc64le-static ${QEMU_PREFIX}/qemu-ppc64-static ${QEMU_PREFIX}/qemu-ppc-static ${QEMU_PREFIX}/qemu-riscv32-static ${QEMU_PREFIX}/qemu-riscv64-static ${QEMU_PREFIX}/qemu-s390x-static ${QEMU_PREFIX}/qemu-sh4eb-static ${QEMU_PREFIX}/qemu-sh4-static ${QEMU_PREFIX}/qemu-sparc32plus-static ${QEMU_PREFIX}/qemu-sparc64-static ${QEMU_PREFIX}/qemu-sparc-static ${QEMU_PREFIX}/qemu-tilegx-static ${QEMU_PREFIX}/qemu-x86_64-static ${QEMU_PREFIX}/qemu-xtensaeb-static ${QEMU_PREFIX}/qemu-xtensa-static; do
		[[ ! -e ${i} ]] || BACKUP_FOLDER="${BACKUP_FOLDER} ${i}"
	done

	if (whiptail --title "Select compression type é€‰æ‹©å‹ç¼©ç±»å‹ " --yes-button "tar.zst" --no-button "tar.xz" --yesno "tar.zståœ¨é€Ÿåº¦å’Œå‹ç¼©ç‡ä¹‹é—´ä¿æŒå¹³è¡¡\ntar.xzå‹ç¼©ç‡é«˜,ä½†é€Ÿåº¦æ…¢\ntar.zst compresses faster.\ntar.xz has a higher compression ration, but is slower." 11 50); then
		printf "${BLOD}%s${RESET} ${BLUE}%s${RESET}\n" "å°†å¤‡ä»½ä»¥ä¸‹æ–‡ä»¶/ç›®å½•ï¼š" "${BACKUP_FOLDER}"
		printf "%s\n" "æ‚¨é€‰æ‹©äº†tar.zst,å³å°†ä¸ºæ‚¨å¤‡ä»½è‡³${CONTAINER_BACKUP_PATH}/${CONTAINER_BACKUP_FILE_NAME}.tar.zst"
		printf "%s\n" "${YELLOW}æŒ‰å›è½¦é”®å¼€å§‹å¤‡ä»½ã€‚Press Enter to start the backup.${RESET} "
		do_you_want_to_continue
		case ${TMOE_CHROOT} in
		true) ${TMOE_PREFIX} tar -I zstd -Ppcvf ${CONTAINER_BACKUP_FILE_NAME}.tar.zst --exclude=${DEBIAN_CHROOT}/root/sd --exclude=${DEBIAN_CHROOT}/root/tf --exclude=${DEBIAN_CHROOT}/root/termux ${BACKUP_FOLDER} ;;
		*)
			if [ "$(command -v pv)" ]; then
				tar -I zstd -Ppcf - --exclude=${DEBIAN_CHROOT}/root/sd --exclude=${DEBIAN_CHROOT}/root/tf --exclude=${DEBIAN_CHROOT}/root/termux ${BACKUP_FOLDER} | (pv -p --timer --rate --bytes >${CONTAINER_BACKUP_FILE_NAME}.tar.zst)
			else
				tar -I zstd -Ppcvf ${CONTAINER_BACKUP_FILE_NAME}.tar.zst --exclude=${DEBIAN_CHROOT}/root/sd --exclude=${DEBIAN_CHROOT}/root/tf --exclude=${DEBIAN_CHROOT}/root/termux ${BACKUP_FOLDER}
			fi
			;;
		esac
	else
		#Which do yo like better? \n
		printf "${BLOD}%s${RESET} ${BLUE}%s${RESET}\n" "å°†å¤‡ä»½ä»¥ä¸‹æ–‡ä»¶/ç›®å½•ï¼š" "${BACKUP_FOLDER}"
		printf "%s\n" "æ‚¨é€‰æ‹©äº†tar.xz,å³å°†ä¸ºæ‚¨å¤‡ä»½è‡³${CONTAINER_BACKUP_PATH}/${CONTAINER_BACKUP_FILE_NAME}.tar.xz"
		printf "%s\n" "${YELLOW}æŒ‰å›è½¦é”®å¼€å§‹å¤‡ä»½ã€‚Press Enter to start the backup.${RESET} "
		do_you_want_to_continue
		#stopvncï¼ˆpkill allï¼‰åœ¨linuxä¸ä¼šè‡ªåŠ¨ç”Ÿæˆ
		${TMOE_PREFIX} tar -PJpcvf ${CONTAINER_BACKUP_FILE_NAME}.tar.xz --exclude=${DEBIAN_CHROOT}/root/sd --exclude=${DEBIAN_CHROOT}/root/tf --exclude=${DEBIAN_CHROOT}/root/termux ${BACKUP_FOLDER}
	fi
	printf "%s\n" "Don't worry too much, it is normal for some directories to backup without permission."
	printf "%s\n" "éƒ¨åˆ†ç›®å½•æ— æƒé™å¤‡ä»½æ˜¯æ­£å¸¸ç°è±¡ã€‚"
	pwd
	ls -lth ./*tar* | grep ^- | head -n 1
	#printf "%s\n" 'gzipå‹ç¼©è‡³60%å®Œæˆæ˜¯æ­£å¸¸ç°è±¡ã€‚'
	printf "%s\n" 'å¤‡ä»½å®Œæˆ'
}
####################
backup_system
