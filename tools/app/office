#!/usr/bin/env bash
#############
tmoe_documents_menu() {
    RETURN_TO_WHERE='tmoe_documents_menu'
    RETURN_TO_MENU='tmoe_documents_menu'
    DEPENDENCY_01=""
    DEPENDENCY_02=""
    TMOE_APP=$(
        whiptail --title "documents" --menu \
            "Which software do you want to install?" 0 50 0 \
            "1" "LibreOffice(å¼€æºã€è‡ªç”±çš„åŠå…¬æ–‡æ¡£è½¯ä»¶)" \
            "2" "WPS office(æ‰“é€ æ–°ä¸€ä»£åŠå…¬ç¯å¢ƒ)" \
            "3" "Chinese manual(ä¸­æ–‡æ‰‹å†Œ)" \
            "4" "æ°¸ä¸­Office(x64,ç§‰æ‰¿é›†æˆåˆ›æ–°ç†å¿µ)" \
            "5" "Free Office(x86,x64,å…¨é¢æ”¯æŒå¾®è½¯Officeæ–‡ä»¶)" \
            "6" "Meld(å¯è§†åŒ–çš„æ–‡æœ¬å·®å¼‚æ¯”è¾ƒå·¥å…·)" \
            "7" "Kdiff3(KDEä¸‹çš„æ–‡ä»¶å·®å¼‚å¯¹æ¯”å·¥å…·)" \
            "0" "ğŸŒš Return to previous menu è¿”å›ä¸Šçº§èœå•" \
            3>&1 1>&2 2>&3
    )
    ##########################
    case "${TMOE_APP}" in
    0 | "") software_center ;;
    1) install_libre_office ;;
    2) install_wps_office ;;
    3) install_chinese_manpages ;;
    4) yozo_office_env ;;
    5) free_office_env ;;
    6) install_meld ;;
    7) install_kdiff3 ;;
    esac
    ##########################
    press_enter_to_return
    tmoe_documents_menu
}
#############
install_meld() {
    DEPENDENCY_02="meld"
    beta_features_quick_install
}
############
install_kdiff3() {
    DEPENDENCY_02="kdiff3"
    beta_features_quick_install
}
#################
free_office_env() {
    DEPENDENCY_01="freeoffice"
    GREP_NAME="${DEPENDENCY_01}"
    OFFICIAL_URL='https://www.freeoffice.com/download/applications'
    tmoe_app_menu_01
}
############
install_free_office() {
    REPO_URL="${OFFICIAL_URL}"
    THE_LATEST_DEB_URL=$(curl -L ${REPO_URL} | grep 'amd64.deb' | sed 's@ @\n@g' | grep deb | cut -d '"' -f 2 | cut -d '=' -f 2 | head -n 1)
    case ${ARCH_TYPE} in
    amd64) ;;
    i386) THE_LATEST_DEB_URL=$(printf '%s\n' "${THE_LATEST_DEB_URL}" | sed "s@amd64.deb@${ARCH_TYPE}.deb@") ;;
    esac
    #https://www.softmaker.net/down/softmaker-freeoffice-2018_976-01_amd64.deb
    #https://www.softmaker.net/down/softmaker-freeoffice-2018-976.x86_64.rpm
    case ${LINUX_DISTRO} in
    debian | arch) ;;
    redhat)
        case ${ARCH_TYPE} in
        amd64)
            THE_LATEST_DEB_URL="$(curl -L ${REPO_URL} | grep rpm | sed 's@ @\n@g' | grep 'rpm' | grep 'x86_64' | cut -d '"' -f 2 | cut -d '=' -f 2 | head -n 1)"
            #THE_LATEST_DEB_URL=$(printf '%s\n' "${THE_LATEST_DEB_URL}" | sed "s@-01_amd64.deb@.x86_64.rpm@" | sed "s@_amd64.deb@.x86_64.rpm@")
            ;;
        i386)
            THE_LATEST_DEB_URL=$(curl -L ${REPO_URL} | grep 'rpm' | sed 's@ @\n@g' | grep rpm | grep i386 | cut -d '"' -f 2 | cut -d '=' -f 2 | head -n 1)
            #THE_LATEST_DEB_URL=$(printf '%s\n' "${THE_LATEST_DEB_URL}" | sed "s@-01_amd64.deb@.i386.rpm@" | sed "s@_amd64.deb@.i386.rpm@")
            ;;
        esac
        ;;
    esac
    THE_LATEST_DEB_FILE=$(printf '%s\n' "${THE_LATEST_DEB_URL}" | awk -F '/' '{print $NF}')
    THE_LATEST_DEB_VERSION=$(printf '%s\n' "${THE_LATEST_DEB_FILE}" | sed 's@.deb@@' | sed 's@softmaker-freeoffice-@@' | sed "s@${GREP_NAME}_@@")
    check_deb_version
    case ${ARCH_TYPE} in
    amd64) ;;
    i386) ;;
    *) arch_does_not_support ;;
    esac
    download_and_install_deb
}
###################
yozo_office_env() {
    DEPENDENCY_01="yozo-office"
    case ${LINUX_DISTRO} in
    arch) DEPENDENCY_02="yozo-office-fonts" ;;
    esac
    GREP_NAME="${DEPENDENCY_01}"
    OFFICIAL_URL='https://www.yozosoft.com/product-officelinux.html'
    tmoe_app_menu_01
}
############
install_yozo_office() {
    #REPO_URL='http://www.yozosoft.com/product-officelinux.html'
    #httpsè¯ä¹¦é”™è¯¯ï¼Œå› æ­¤ä¸åŠ s
    #THE_LATEST_DEB_FILE=$(curl -L ${REPO_URL} | grep 'amd64.deb' | grep '=' | cut -d '=' -f 2 | cut -d '"' -f 2 | awk -F '/' '{print $NF}')
    #THE_LATEST_DEB_URL="https://dl.yozosoft.com/portal-download/fileManager/PRODUCT/${THE_LATEST_DEB_FILE}"
    #arm64) THE_LATEST_DEB_URL=$(printf '%s\n' "${THE_LATEST_DEB_URL}" | sed "s@amd64.deb@arm64.deb@") ;;
    #https://dl.yozosoft.com/portal-download/fileManager/PRODUCT/yozo-office_8.0.1331.101ZH.S1_amd64.deb
    #https://dl.yozosoft.com/portal-download/fileManager/PRODUCT/yozo-office-8.0.1331.101ZH.S1-1.x86_64.rpm
    REPO_URL='https://aur.tuna.tsinghua.edu.cn/packages/yozo-office/'
    THE_LATEST_DEB_URL=$(curl -L ${REPO_URL} | grep deb | cut -d '=' -f 2 | cut -d '"' -f 2 | head -n 1)
    case ${LINUX_DISTRO} in
    debian) ;;
    redhat) THE_LATEST_DEB_URL=$(printf '%s\n' "${THE_LATEST_DEB_URL}" | sed "s@${GREP_NAME}_@${GREP_NAME}-@" | sed "s@_amd64.deb@-1.x86_64.rpm@") ;;
    esac
    THE_LATEST_DEB_FILE=$(printf '%s\n' "${THE_LATEST_DEB_URL}" | awk -F '/' '{print $NF}')
    THE_LATEST_DEB_VERSION=$(printf '%s\n' "${THE_LATEST_DEB_FILE}" | sed 's@.deb@@' | sed "s@${GREP_NAME}-@@" | sed "s@${GREP_NAME}_@@")
    ICON_FILE='/usr/share/icons/hicolor/48x48/apps/yozoicon.png'
    if [ -e "${ICON_FILE}" ]; then
        catimg "${ICON_FILE}" 2>/dev/null
    fi
    check_deb_version
    case ${ARCH_TYPE} in
    amd64) ;;
    *) arch_does_not_support ;;
    esac
    #printf "%s\n" "æœ€æ–°ç‰ˆé“¾æ¥ä¸º${BLUE}${THE_LATEST_DEB_URL}${RESET}"
    download_and_install_deb
}
###################
install_wps_office() {
    random_neko
    DEPENDENCY_01="wps-office"
    DEPENDENCY_02=""
    printf "%s\n" "æ­£åœ¨æ£€æµ‹ç‰ˆæœ¬æ›´æ–°..."
    printf "%s\n" "è‹¥å®‰è£…å¤±è´¥ï¼Œåˆ™è¯·å‰å¾€å®˜ç½‘æ‰‹åŠ¨ä¸‹è½½å®‰è£…ã€‚"
    printf "%s\n" "url: ${YELLOW}https://linux.wps.cn${RESET}"
    case ${LINUX_DISTRO} in
    redhat)
        THE_LATEST_DEB_URL=$(curl -L https://linux.wps.cn/ | grep '\.rpm' | grep -i "$(uname -m)" | head -n 1 | cut -d '=' -f 2 | cut -d '"' -f 2)
        ;;
    *)
        THE_LATEST_DEB_URL=$(curl -L https://linux.wps.cn/ | grep '\.deb' | grep -i "${ARCH_TYPE}" | head -n 1 | cut -d '=' -f 2 | cut -d '"' -f 2)
        ;;
    esac
    THE_LATEST_DEB_VERSION=$(printf '%s\n' "${THE_LATEST_DEB_URL}" | awk -F '/' '{print $NF}' | sed 's@.deb@@')
    TMOE_TIPS_01="æ£€æµ‹åˆ°æœ€æ–°ç‰ˆæœ¬ä¸º${THE_LATEST_DEB_VERSION}"
    lolcat_tmoe_tips_01
    printf "%s\n" "æœ€æ–°ç‰ˆé“¾æ¥ä¸º${BLUE}${THE_LATEST_DEB_URL}${RESET}"
    if [ ! -e "${APPS_LNK_DIR}/wps-office-wps.desktop" ]; then
        #press_enter_to_reinstall
        printf "%s\n" "æœªæ£€æµ‹åˆ°æœ¬åœ°ç‰ˆæœ¬ï¼Œæ‚¨å¯èƒ½å°šæœªå®‰è£…WPSå®¢æˆ·ç«¯ã€‚"
    elif [ -e "${TMOE_LINUX_DIR}/${DEPENDENCY_01}-version" ]; then
        printf "%s\n" "æœ¬åœ°ç‰ˆæœ¬å¯èƒ½ä¸º${YELLOW}$(sed -n p ${TMOE_LINUX_DIR}/${DEPENDENCY_01}-version | head -n 1)${RESET}"
        printf "%s\n" "å¦‚éœ€${RED}å¸è½½${RESET}ï¼Œè¯·æ‰‹åŠ¨è¾“${BLUE} ${TMOE_REMOVAL_COMMAND} ${DEPENDENCY_01} ${DEPENDENCY_02} ${RESET}"
    else
        printf "%s\n" "æœªæ£€æµ‹åˆ°æœ¬åœ°ç‰ˆæœ¬ï¼Œæ‚¨å¯èƒ½ä¸æ˜¯é€šè¿‡tmoe-linux toolå®‰è£…çš„ã€‚"
    fi
    do_you_want_to_continue
    cd /tmp
    case "${LINUX_DISTRO}" in
    "debian")
        dpkg --configure -a
        if [ ! -e "/usr/share/doc/ttf-mscorefonts-installer/copyright" ]; then
            printf "%s\n" "apt install -y ttf-mscorefonts-installer"
            apt install -y ttf-mscorefonts-installer
        fi
        aria2c --no-conf --allow-overwrite=true -s 5 -x 5 -k 1M -o WPSoffice.deb "${THE_LATEST_DEB_URL}"
        apt-cache show ./WPSoffice.deb
        apt install -y ./WPSoffice.deb
        ;;
    "arch")
        DEPENDENCY_01="wps-office-cn"
        beta_features_quick_install
        ;;
    "redhat")
        aria2c --no-conf --allow-overwrite=true -s 5 -x 5 -k 1M -o WPSoffice.rpm "${THE_LATEST_DEB_URL}"
        rpm -ivh ./WPSoffice.rpm
        ;;
    esac
    printf "%s\n" "${THE_LATEST_DEB_VERSION}" >${TMOE_LINUX_DIR}/${DEPENDENCY_01}-version
    rm -fv ./WPSoffice.deb ./WPSoffice.rpm 2>/dev/null
    beta_features_install_completed
}
###################
install_libre_office() {
    #ps -e >/dev/null || printf "%s\n" "/procåˆ†åŒºæœªæŒ‚è½½ï¼Œè¯·å‹¿å®‰è£…libreoffice,èµ‹äºˆprootå®¹å™¨çœŸå®rootæƒé™å¯è§£å†³ç›¸å…³é—®é¢˜ï¼Œä½†å¼ºçƒˆä¸æ¨èï¼"
    case ${TMOE_PROOT} in
    no)
        printf "%s\n" "${RED}WARNINGï¼${RESET}æ£€æµ‹åˆ°æ‚¨æ— æƒè¯»å–${GREEN}/proc${RESET}çš„æŸäº›æ•°æ®ï¼"
        printf "%s\n" "æœ¬å·¥å…·å°†ä¸ºæ­¤è½¯ä»¶è‡ªåŠ¨æ‰“è¡¥ä¸ä»¥è§£å†³æ— æ³•è¿è¡Œçš„é—®é¢˜ï¼Œä½†æ— æ³•ä¿è¯è¡¥ä¸æœ‰æ•ˆã€‚"
        ;;
    esac
    #RETURN_TO_WHERE='software_center'
    #do_you_want_to_continue
    case "${LINUX_DISTRO}" in
    "debian") DEPENDENCY_01='--no-install-recommends libreoffice' ;;
    *) DEPENDENCY_01="libreoffice" ;;
    esac
    DEPENDENCY_02="libreoffice-l10n-zh-cn libreoffice-gtk3"

    beta_features_quick_install
    case "${TMOE_PROOT}" in
    no)
        patch_libreoffice
        printf "%s\n" "æ‰“è¡¥ä¸å®Œæˆ"
        ;;
    esac
}
###################
patch_libreoffice() {
    mkdir -p /prod/version
    cd /usr/lib/libreoffice/program
    rm -f oosplash
    curl -Lo 'oosplash' https://gitee.com/mo2/patch/raw/libreoffice/oosplash
    chmod +x oosplash
}
##################
check_libreoffice_patch() {
    if [ $(command -v libreoffice) ]; then
        patch_libreoffice
    fi
}
############
tmoe_documents_menu
